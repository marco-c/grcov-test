<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - gfx/thebes/gfxFontconfigFonts.cpp</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">gfx/thebes</a> - gfxFontconfigFonts.cpp<span style="font-size: 80%;"> (source / <a href="gfxFontconfigFonts.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">710</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-03-17 01:02:30</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">76</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-</a>
<span class="lineNum">       2 </span>            :  * This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #include &quot;prlink.h&quot;
<span class="lineNum">       7 </span>            : #include &quot;gfxTypes.h&quot;
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;nsTArray.h&quot;
<span class="lineNum">      10 </span>            : 
<span class="lineNum">      11 </span>            : #include &quot;gfxContext.h&quot;
<span class="lineNum">      12 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">      13 </span>            : #include &quot;gfxPlatformGtk.h&quot;
<span class="lineNum">      14 </span>            : #endif
<span class="lineNum">      15 </span>            : #include &quot;gfxFontconfigFonts.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;gfxFT2FontBase.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;gfxFT2Utils.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;harfbuzz/hb.h&quot;
<span class="lineNum">      19 </span>            : #include &quot;harfbuzz/hb-glib.h&quot;
<span class="lineNum">      20 </span>            : #include &quot;harfbuzz/hb-ot.h&quot;
<span class="lineNum">      21 </span>            : #include &quot;nsUnicodeProperties.h&quot;
<span class="lineNum">      22 </span>            : #include &quot;nsUnicodeScriptCodes.h&quot;
<span class="lineNum">      23 </span>            : #include &quot;gfxFontconfigUtils.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;gfxUserFontSet.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;gfxFontConstants.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;nsGkAtoms.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;nsILanguageAtomService.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;nsServiceManagerUtils.h&quot;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &lt;cairo.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;cairo-ft.h&gt;
<span class="lineNum">      32 </span>            : #include &quot;mozilla/gfx/HelpersCairo.h&quot;
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : #include &lt;fontconfig/fcfreetype.h&gt;
<span class="lineNum">      35 </span>            : #include &lt;pango/pango.h&gt;
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : #include FT_TRUETYPE_TABLES_H
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">      40 </span>            : #include &lt;gdk/gdk.h&gt;
<span class="lineNum">      41 </span>            : #endif
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : using namespace mozilla;
<span class="lineNum">      46 </span>            : using namespace mozilla::unicode;
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span>            : #define PRINTING_FC_PROPERTY &quot;gfx.printing&quot;
<span class="lineNum">      49 </span>            : 
<span class="lineNum">      50 </span>            : static PangoLanguage *GuessPangoLanguage(nsIAtom *aLanguage);
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            : static cairo_scaled_font_t *
<span class="lineNum">      53 </span>            : CreateScaledFont(FcPattern *aPattern, cairo_font_face_t *aFace);
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : static FT_Library gFTLibrary;
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : // FC_FAMILYLANG and FC_FULLNAME were introduced in fontconfig-2.2.97
<span class="lineNum">      58 </span>            : // and so fontconfig-2.3.0 (2005).
<span class="lineNum">      59 </span>            : #ifndef FC_FAMILYLANG
<span class="lineNum">      60 </span>            : #define FC_FAMILYLANG &quot;familylang&quot;
<span class="lineNum">      61 </span>            : #endif
<span class="lineNum">      62 </span>            : #ifndef FC_FULLNAME
<span class="lineNum">      63 </span>            : #define FC_FULLNAME &quot;fullname&quot;
<span class="lineNum">      64 </span>            : #endif
<a name="65"><span class="lineNum">      65 </span>            : </a>
<span class="lineNum">      66 </span>            : static PRFuncPtr
<span class="lineNum">      67 </span><span class="lineNoCov">          0 : FindFunctionSymbol(const char *name)</span>
<span class="lineNum">      68 </span>            : {
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :     PRLibrary *lib = nullptr;</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :     PRFuncPtr result = PR_FindFunctionSymbolAndLibrary(name, &amp;lib);</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :     if (lib) {</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :         PR_UnloadLibrary(lib);</span>
<span class="lineNum">      73 </span>            :     }
<span class="lineNum">      74 </span>            : 
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :     return result;</span>
<a name="76"><span class="lineNum">      76 </span>            : }</a>
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineNoCov">          0 : static bool HasChar(FcPattern *aFont, FcChar32 wc)</span>
<span class="lineNum">      79 </span>            : {
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :     FcCharSet *charset = nullptr;</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :     FcPatternGetCharSet(aFont, FC_CHARSET, 0, &amp;charset);</span>
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :     return charset &amp;&amp; FcCharSetHasChar(charset, wc);</span>
<span class="lineNum">      84 </span>            : }
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span>            : /**
<span class="lineNum">      87 </span>            :  * gfxFcFontEntry:
<span class="lineNum">      88 </span>            :  *
<span class="lineNum">      89 </span>            :  * An abstract base class of for gfxFontEntry implementations used by
<span class="lineNum">      90 </span>            :  * gfxFcFont and gfxUserFontSet.
<a name="91"><span class="lineNum">      91 </span>            :  */</a>
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span><span class="lineNoCov">          0 : class gfxFcFontEntry : public gfxFontEntry {</span>
<span class="lineNum">      94 </span>            : public:
<span class="lineNum">      95 </span>            :     // For all FontEntrys attached to gfxFcFonts, there will be only one
<span class="lineNum">      96 </span>            :     // pattern in this array.  This is always a font pattern, not a fully
<span class="lineNum">      97 </span>            :     // resolved pattern.  gfxFcFont only uses this to construct a PangoFont.
<span class="lineNum">      98 </span>            :     //
<span class="lineNum">      99 </span>            :     // FontEntrys for src:local() fonts in gfxUserFontSet may return more than
<span class="lineNum">     100 </span>            :     // one pattern.  (See comment in gfxUserFcFontEntry.)
<span class="lineNum">     101 </span>            :     const nsTArray&lt; nsCountedRef&lt;FcPattern&gt; &gt;&amp; GetPatterns()
<span class="lineNum">     102 </span>            :     {
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :         return mPatterns;</span>
<a name="104"><span class="lineNum">     104 </span>            :     }</a>
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :     static gfxFcFontEntry *LookupFontEntry(cairo_font_face_t *aFace)</span>
<span class="lineNum">     107 </span>            :     {
<span class="lineNum">     108 </span>            :         return static_cast&lt;gfxFcFontEntry*&gt;
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :             (cairo_font_face_get_user_data(aFace, &amp;sFontEntryKey));</span>
<span class="lineNum">     110 </span>            :     }
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span>            :     // override the gfxFontEntry impl to read the name from fontconfig
<span class="lineNum">     113 </span>            :     // instead of trying to get the 'name' table, as we don't implement
<span class="lineNum">     114 </span>            :     // GetFontTable() here
<span class="lineNum">     115 </span>            :     virtual nsString RealFaceName();
<a name="116"><span class="lineNum">     116 </span>            : </a>
<span class="lineNum">     117 </span>            :     // This is needed to make gfxFontEntry::HasCharacter(aCh) work.
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :     virtual bool TestCharacterMap(uint32_t aCh)</span>
<span class="lineNum">     119 </span>            :     {
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :         for (uint32_t i = 0; i &lt; mPatterns.Length(); ++i) {</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :             if (HasChar(mPatterns[i], aCh)) {</span>
<span class="lineNum">     122 </span>            :                 return true;
<span class="lineNum">     123 </span>            :             }
<span class="lineNum">     124 </span>            :         }
<span class="lineNum">     125 </span>            :         return false;
<span class="lineNum">     126 </span>            :     }
<a name="127"><span class="lineNum">     127 </span>            : </a>
<span class="lineNum">     128 </span>            : protected:
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :     explicit gfxFcFontEntry(const nsAString&amp; aName)</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         : gfxFontEntry(aName)</span>
<span class="lineNum">     131 </span>            :     {
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span>            :     // One pattern is the common case and some subclasses rely on successful
<span class="lineNum">     135 </span>            :     // addition of the first element to the array.
<span class="lineNum">     136 </span>            :     AutoTArray&lt;nsCountedRef&lt;FcPattern&gt;,1&gt; mPatterns;
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            :     static cairo_user_data_key_t sFontEntryKey;
<span class="lineNum">     139 </span>            : };
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            : cairo_user_data_key_t gfxFcFontEntry::sFontEntryKey;
<a name="142"><span class="lineNum">     142 </span>            : </a>
<span class="lineNum">     143 </span>            : nsString
<span class="lineNum">     144 </span><span class="lineNoCov">          0 : gfxFcFontEntry::RealFaceName()</span>
<span class="lineNum">     145 </span>            : {
<span class="lineNum">     146 </span>            :     FcChar8 *name;
<span class="lineNum">     147 </span><span class="lineNoCov">          0 :     if (!mPatterns.IsEmpty()) {</span>
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         if (FcPatternGetString(mPatterns[0],</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :                                FC_FULLNAME, 0, &amp;name) == FcResultMatch) {</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :             return NS_ConvertUTF8toUTF16((const char*)name);</span>
<span class="lineNum">     151 </span>            :         }
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :         if (FcPatternGetString(mPatterns[0],</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :                                FC_FAMILY, 0, &amp;name) == FcResultMatch) {</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :             NS_ConvertUTF8toUTF16 result((const char*)name);</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :             if (FcPatternGetString(mPatterns[0],</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :                                    FC_STYLE, 0, &amp;name) == FcResultMatch) {</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :                 result.Append(' ');</span>
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :                 AppendUTF8toUTF16((const char*)name, result);</span>
<span class="lineNum">     159 </span>            :             }
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :             return result;</span>
<span class="lineNum">     161 </span>            :         }
<span class="lineNum">     162 </span>            :     }
<span class="lineNum">     163 </span>            :     // fall back to gfxFontEntry implementation (only works for sfnt fonts)
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :     return gfxFontEntry::RealFaceName();</span>
<span class="lineNum">     165 </span>            : }
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span>            : /**
<span class="lineNum">     168 </span>            :  * gfxSystemFcFontEntry:
<span class="lineNum">     169 </span>            :  *
<span class="lineNum">     170 </span>            :  * An implementation of gfxFcFontEntry used by gfxFcFonts for system fonts,
<span class="lineNum">     171 </span>            :  * including those from regular family-name based font selection as well as
<span class="lineNum">     172 </span>            :  * those from src:local().
<span class="lineNum">     173 </span>            :  *
<span class="lineNum">     174 </span>            :  * All gfxFcFonts using the same cairo_font_face_t share the same FontEntry. 
<span class="lineNum">     175 </span>            :  */
<span class="lineNum">     176 </span>            : 
<span class="lineNum">     177 </span>            : class gfxSystemFcFontEntry : public gfxFcFontEntry {
<span class="lineNum">     178 </span>            : public:
<a name="179"><span class="lineNum">     179 </span>            :     // For memory efficiency, aFontPattern should be a font pattern,</a>
<span class="lineNum">     180 </span>            :     // not a fully resolved pattern.
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :     gfxSystemFcFontEntry(cairo_font_face_t *aFontFace,</span>
<span class="lineNum">     182 </span>            :                          FcPattern *aFontPattern,
<span class="lineNum">     183 </span>            :                          const nsAString&amp; aName)
<span class="lineNum">     184 </span>            :         : gfxFcFontEntry(aName), mFontFace(aFontFace),
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :           mFTFace(nullptr), mFTFaceInitialized(false)</span>
<span class="lineNum">     186 </span>            :     {
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :         cairo_font_face_reference(mFontFace);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :         cairo_font_face_set_user_data(mFontFace, &amp;sFontEntryKey, this, nullptr);</span>
<span class="lineNum">     189 </span>            : 
<span class="lineNum">     190 </span>            :         // mPatterns is an AutoTArray with 1 space always available, so the
<span class="lineNum">     191 </span>            :         // AppendElement always succeeds.
<span class="lineNum">     192 </span>            :         // FIXME: Make this infallible after bug 968520 is done.
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :         MOZ_ALWAYS_TRUE(mPatterns.AppendElement(fallible));</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :         mPatterns[0] = aFontPattern;</span>
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span>            :         FcChar8 *name;
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :         if (FcPatternGetString(aFontPattern,</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :                                FC_FAMILY, 0, &amp;name) == FcResultMatch) {</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :             mFamilyName = NS_ConvertUTF8toUTF16((const char*)name);</span>
<span class="lineNum">     200 </span>            :         }
<a name="201"><span class="lineNum">     201 </span><span class="lineNoCov">          0 :     }</span></a>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :     ~gfxSystemFcFontEntry()</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     205 </span>            :         cairo_font_face_set_user_data(mFontFace,
<span class="lineNum">     206 </span>            :                                       &amp;sFontEntryKey,
<span class="lineNum">     207 </span>            :                                       nullptr,
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                                       nullptr);</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :         cairo_font_face_destroy(mFontFace);</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            :     virtual void ForgetHBFace() override;
<span class="lineNum">     213 </span>            :     virtual void ReleaseGrFace(gr_face* aFace) override;
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span>            : protected:
<span class="lineNum">     216 </span>            :     virtual nsresult
<span class="lineNum">     217 </span>            :     CopyFontTable(uint32_t aTableTag, nsTArray&lt;uint8_t&gt;&amp; aBuffer) override;
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            :     void MaybeReleaseFTFace();
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            : private:
<span class="lineNum">     222 </span>            :     cairo_font_face_t *mFontFace;
<span class="lineNum">     223 </span>            :     FT_Face            mFTFace;
<span class="lineNum">     224 </span>            :     bool               mFTFaceInitialized;
<span class="lineNum">     225 </span>            : };
<a name="226"><span class="lineNum">     226 </span>            : </a>
<span class="lineNum">     227 </span>            : nsresult
<span class="lineNum">     228 </span><span class="lineNoCov">          0 : gfxSystemFcFontEntry::CopyFontTable(uint32_t aTableTag,</span>
<span class="lineNum">     229 </span>            :                                     nsTArray&lt;uint8_t&gt;&amp; aBuffer)
<span class="lineNum">     230 </span>            : {
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :     if (!mFTFaceInitialized) {</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         mFTFaceInitialized = true;</span>
<span class="lineNum">     233 </span>            :         FcChar8 *filename;
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :         if (FcPatternGetString(mPatterns[0], FC_FILE, 0, &amp;filename) != FcResultMatch) {</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :             return NS_ERROR_FAILURE;</span>
<span class="lineNum">     236 </span>            :         }
<span class="lineNum">     237 </span>            :         int index;
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         if (FcPatternGetInteger(mPatterns[0], FC_INDEX, 0, &amp;index) != FcResultMatch) {</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :             index = 0; // default to 0 if not found in pattern</span>
<span class="lineNum">     240 </span>            :         }
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :         if (FT_New_Face(gfxPangoFontGroup::GetFTLibrary(),</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :                         (const char*)filename, index, &amp;mFTFace) != 0) {</span>
<span class="lineNum">     243 </span>            :             return NS_ERROR_FAILURE;
<span class="lineNum">     244 </span>            :         }
<span class="lineNum">     245 </span>            :     }
<span class="lineNum">     246 </span>            : 
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :     if (!mFTFace) {</span>
<span class="lineNum">     248 </span>            :         return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">     249 </span>            :     }
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :     FT_ULong length = 0;</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :     if (FT_Load_Sfnt_Table(mFTFace, aTableTag, 0, nullptr, &amp;length) != 0) {</span>
<span class="lineNum">     253 </span>            :         return NS_ERROR_NOT_AVAILABLE;
<span class="lineNum">     254 </span>            :     }
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :     if (!aBuffer.SetLength(length, fallible)) {</span>
<span class="lineNum">     256 </span>            :         return NS_ERROR_OUT_OF_MEMORY;
<span class="lineNum">     257 </span>            :     }
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     if (FT_Load_Sfnt_Table(mFTFace, aTableTag, 0, aBuffer.Elements(), &amp;length) != 0) {</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :         aBuffer.Clear();</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :         return NS_ERROR_FAILURE;</span>
<span class="lineNum">     261 </span>            :     }
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span>            :     return NS_OK;
<span class="lineNum">     264 </span>            : }
<a name="265"><span class="lineNum">     265 </span>            : </a>
<span class="lineNum">     266 </span>            : void
<span class="lineNum">     267 </span><span class="lineNoCov">          0 : gfxSystemFcFontEntry::MaybeReleaseFTFace()</span>
<span class="lineNum">     268 </span>            : {
<span class="lineNum">     269 </span>            :     // don't release if either HB or Gr face still exists
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :     if (mHBFace || mGrFace) {</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">     272 </span>            :     }
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :     if (mFTFace) {</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         FT_Done_Face(mFTFace);</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         mFTFace = nullptr;</span>
<span class="lineNum">     276 </span>            :     }
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :     mFTFaceInitialized = false;</span>
<span class="lineNum">     278 </span>            : }
<a name="279"><span class="lineNum">     279 </span>            : </a>
<span class="lineNum">     280 </span>            : void
<span class="lineNum">     281 </span><span class="lineNoCov">          0 : gfxSystemFcFontEntry::ForgetHBFace()</span>
<span class="lineNum">     282 </span>            : {
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     gfxFontEntry::ForgetHBFace();</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     MaybeReleaseFTFace();</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 : }</span>
<a name="286"><span class="lineNum">     286 </span>            : </a>
<span class="lineNum">     287 </span>            : void
<span class="lineNum">     288 </span><span class="lineNoCov">          0 : gfxSystemFcFontEntry::ReleaseGrFace(gr_face* aFace)</span>
<span class="lineNum">     289 </span>            : {
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :     gfxFontEntry::ReleaseGrFace(aFace);</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :     MaybeReleaseFTFace();</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span>            : // A namespace for @font-face family names in FcPatterns so that fontconfig
<span class="lineNum">     295 </span>            : // aliases do not pick up families from @font-face rules and so that
<span class="lineNum">     296 </span>            : // fontconfig rules can distinguish between web fonts and platform fonts.
<span class="lineNum">     297 </span>            : // http://lists.freedesktop.org/archives/fontconfig/2008-November/003037.html
<span class="lineNum">     298 </span>            : #define FONT_FACE_FAMILY_PREFIX &quot;@font-face:&quot;
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span>            : /**
<span class="lineNum">     301 </span>            :  * gfxUserFcFontEntry:
<span class="lineNum">     302 </span>            :  *
<span class="lineNum">     303 </span>            :  * An abstract class for objects in a gfxUserFontSet that can provide
<span class="lineNum">     304 </span>            :  * FcPattern* handles to fonts.
<span class="lineNum">     305 </span>            :  *
<span class="lineNum">     306 </span>            :  * Separate implementations of this class support local fonts from src:local()
<span class="lineNum">     307 </span>            :  * and web fonts from src:url().
<span class="lineNum">     308 </span>            :  */
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            : // There is a one-to-one correspondence between gfxUserFcFontEntry objects and
<span class="lineNum">     311 </span>            : // @font-face rules, but sometimes a one-to-many correspondence between font
<span class="lineNum">     312 </span>            : // entries and font patterns.
<span class="lineNum">     313 </span>            : //
<span class="lineNum">     314 </span>            : // http://www.w3.org/TR/2002/WD-css3-webfonts-20020802#font-descriptions
<span class="lineNum">     315 </span>            : // provided a font-size descriptor to specify the sizes supported by the face,
<span class="lineNum">     316 </span>            : // but the &quot;Editor's Draft 27 June 2008&quot;
<span class="lineNum">     317 </span>            : // http://dev.w3.org/csswg/css3-fonts/#font-resources does not provide such a
<span class="lineNum">     318 </span>            : // descriptor, and Mozilla does not recognize such a descriptor.
<span class="lineNum">     319 </span>            : //
<span class="lineNum">     320 </span>            : // Font face names used in src:local() also do not usually specify a size.
<span class="lineNum">     321 </span>            : //
<span class="lineNum">     322 </span>            : // PCF format fonts have each size in a different file, and each of these
<span class="lineNum">     323 </span>            : // files is referenced by its own pattern, but really these are each
<span class="lineNum">     324 </span>            : // different sizes of one face with one name.
<span class="lineNum">     325 </span>            : //
<span class="lineNum">     326 </span>            : // Multiple patterns in an entry also effectively deals with a set of
<span class="lineNum">     327 </span>            : // PostScript Type 1 font files that all have the same face name but are in
<span class="lineNum">     328 </span>            : // several files because of the limit on the number of glyphs in a Type 1 font
<a name="329"><span class="lineNum">     329 </span>            : // file.  (e.g. Computer Modern.)</a>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span><span class="lineNoCov">          0 : class gfxUserFcFontEntry : public gfxFcFontEntry {</span>
<span class="lineNum">     332 </span>            : protected:
<span class="lineNum">     333 </span>            :     explicit gfxUserFcFontEntry(const nsAString&amp; aFontName,
<span class="lineNum">     334 </span>            :                        uint16_t aWeight,
<span class="lineNum">     335 </span>            :                        int16_t aStretch,
<span class="lineNum">     336 </span>            :                        uint8_t aStyle)
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :         : gfxFcFontEntry(aFontName)</span>
<span class="lineNum">     338 </span>            :     {
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :         mStyle = aStyle;</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :         mWeight = aWeight;</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :         mStretch = aStretch;</span>
<span class="lineNum">     342 </span>            :     }
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span>            :     // Helper function to change a pattern so that it matches the CSS style
<span class="lineNum">     345 </span>            :     // descriptors and so gets properly sorted in font selection.  This also
<span class="lineNum">     346 </span>            :     // avoids synthetic style effects being added by the renderer when the
<span class="lineNum">     347 </span>            :     // style of the font itself does not match the descriptor provided by the
<span class="lineNum">     348 </span>            :     // author.
<span class="lineNum">     349 </span>            :     void AdjustPatternToCSS(FcPattern *aPattern);
<span class="lineNum">     350 </span>            : };
<a name="351"><span class="lineNum">     351 </span>            : </a>
<span class="lineNum">     352 </span>            : void
<span class="lineNum">     353 </span><span class="lineNoCov">          0 : gfxUserFcFontEntry::AdjustPatternToCSS(FcPattern *aPattern)</span>
<span class="lineNum">     354 </span>            : {
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :     int fontWeight = -1;</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :     FcPatternGetInteger(aPattern, FC_WEIGHT, 0, &amp;fontWeight);</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :     int cssWeight = gfxFontconfigUtils::FcWeightForBaseWeight(mWeight / 100);</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :     if (cssWeight != fontWeight) {</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         FcPatternDel(aPattern, FC_WEIGHT);</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :         FcPatternAddInteger(aPattern, FC_WEIGHT, cssWeight);</span>
<span class="lineNum">     361 </span>            :     }
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span>            :     int fontSlant;
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :     FcResult res = FcPatternGetInteger(aPattern, FC_SLANT, 0, &amp;fontSlant);</span>
<span class="lineNum">     365 </span>            :     // gfxFontEntry doesn't understand the difference between oblique
<span class="lineNum">     366 </span>            :     // and italic.
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :     if (res != FcResultMatch ||</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :         IsItalic() != (fontSlant != FC_SLANT_ROMAN)) {</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :         FcPatternDel(aPattern, FC_SLANT);</span>
<span class="lineNum">     370 </span>            :         FcPatternAddInteger(aPattern, FC_SLANT,
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                             IsItalic() ? FC_SLANT_OBLIQUE : FC_SLANT_ROMAN);</span>
<span class="lineNum">     372 </span>            :     }
<span class="lineNum">     373 </span>            : 
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :     int fontWidth = -1;</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :     FcPatternGetInteger(aPattern, FC_WIDTH, 0, &amp;fontWidth);</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :     int cssWidth = gfxFontconfigUtils::FcWidthForThebesStretch(mStretch);</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :     if (cssWidth != fontWidth) {</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :         FcPatternDel(aPattern, FC_WIDTH);</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :         FcPatternAddInteger(aPattern, FC_WIDTH, cssWidth);</span>
<span class="lineNum">     380 </span>            :     }
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            :     // Ensure that there is a fullname property (if there is a family
<span class="lineNum">     383 </span>            :     // property) so that fontconfig rules can identify the real name of the
<span class="lineNum">     384 </span>            :     // font, because the family property will be replaced.
<span class="lineNum">     385 </span>            :     FcChar8 *unused;
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     if (FcPatternGetString(aPattern,</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :                            FC_FULLNAME, 0, &amp;unused) == FcResultNoMatch) {</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :         nsAutoCString fullname;</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :         if (gfxFontconfigUtils::GetFullnameFromFamilyAndStyle(aPattern,</span>
<span class="lineNum">     390 </span>            :                                                               &amp;fullname)) {
<span class="lineNum">     391 </span>            :             FcPatternAddString(aPattern, FC_FULLNAME,
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                                gfxFontconfigUtils::ToFcChar8(fullname));</span>
<span class="lineNum">     393 </span>            :         }
<span class="lineNum">     394 </span>            :     }
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :     nsAutoCString family;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :     family.Append(FONT_FACE_FAMILY_PREFIX);</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :     AppendUTF16toUTF8(Name(), family);</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :     FcPatternDel(aPattern, FC_FAMILY);</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :     FcPatternDel(aPattern, FC_FAMILYLANG);</span>
<span class="lineNum">     402 </span>            :     FcPatternAddString(aPattern, FC_FAMILY,
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :                        gfxFontconfigUtils::ToFcChar8(family));</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span>            : /**
<span class="lineNum">     407 </span>            :  * gfxLocalFcFontEntry:
<span class="lineNum">     408 </span>            :  *
<span class="lineNum">     409 </span>            :  * An implementation of gfxUserFcFontEntry for local fonts from src:local().
<span class="lineNum">     410 </span>            :  *
<span class="lineNum">     411 </span>            :  * This class is used only in gfxUserFontSet and for providing FcPattern*
<span class="lineNum">     412 </span>            :  * handles to system fonts for font selection.  gfxFcFonts created from these
<span class="lineNum">     413 </span>            :  * patterns will use gfxSystemFcFontEntrys, which may be shared with
<span class="lineNum">     414 </span>            :  * gfxFcFonts from regular family-name based font selection.
<a name="415"><span class="lineNum">     415 </span>            :  */</a>
<span class="lineNum">     416 </span>            : 
<a name="417"><span class="lineNum">     417 </span><span class="lineNoCov">          0 : class gfxLocalFcFontEntry : public gfxUserFcFontEntry {</span></a>
<span class="lineNum">     418 </span>            : public:
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :     gfxLocalFcFontEntry(const nsAString&amp; aFontName,</span>
<span class="lineNum">     420 </span>            :                         uint16_t aWeight,
<span class="lineNum">     421 </span>            :                         int16_t aStretch,
<span class="lineNum">     422 </span>            :                         uint8_t aStyle,
<span class="lineNum">     423 </span>            :                         const nsTArray&lt; nsCountedRef&lt;FcPattern&gt; &gt;&amp; aPatterns)
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         : gfxUserFcFontEntry(aFontName, aWeight, aStretch, aStyle)</span>
<span class="lineNum">     425 </span>            :     {
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :         if (!mPatterns.SetCapacity(aPatterns.Length(), fallible))</span>
<span class="lineNum">     427 </span>            :             return; // OOM
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         for (uint32_t i = 0; i &lt; aPatterns.Length(); ++i) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :             FcPattern *pattern = FcPatternDuplicate(aPatterns.ElementAt(i));</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :             if (!pattern)</span>
<span class="lineNum">     432 </span>            :                 return; // OOM
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :             AdjustPatternToCSS(pattern);</span>
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span>            :             // FIXME: Make this infallible after bug 968520 is done.
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :             MOZ_ALWAYS_TRUE(mPatterns.AppendElement(fallible));</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :             mPatterns[i].own(pattern);</span>
<span class="lineNum">     439 </span>            :         }
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :         mIsLocalUserFont = true;</span>
<span class="lineNum">     441 </span>            :     }
<span class="lineNum">     442 </span>            : };
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span>            : /**
<span class="lineNum">     445 </span>            :  * gfxDownloadedFcFontEntry:
<span class="lineNum">     446 </span>            :  *
<span class="lineNum">     447 </span>            :  * An implementation of gfxFcFontEntry for web fonts from src:url().
<span class="lineNum">     448 </span>            :  * 
<span class="lineNum">     449 </span>            :  * When a cairo_font_face_t is created for these fonts, the cairo_font_face_t
<span class="lineNum">     450 </span>            :  * keeps a reference to the FontEntry to keep the font data alive.
<span class="lineNum">     451 </span>            :  */
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span>            : class gfxDownloadedFcFontEntry : public gfxUserFcFontEntry {
<a name="454"><span class="lineNum">     454 </span>            : public:</a>
<span class="lineNum">     455 </span>            :     // This takes ownership of the face and its underlying data
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :     gfxDownloadedFcFontEntry(const nsAString&amp; aFontName,</span>
<span class="lineNum">     457 </span>            :                              uint16_t aWeight,
<span class="lineNum">     458 </span>            :                              int16_t aStretch,
<span class="lineNum">     459 </span>            :                              uint8_t aStyle,
<span class="lineNum">     460 </span>            :                              const uint8_t *aData, FT_Face aFace)
<span class="lineNum">     461 </span>            :         : gfxUserFcFontEntry(aFontName, aWeight, aStretch, aStyle),
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :           mFontData(aData), mFace(aFace)</span>
<span class="lineNum">     463 </span>            :     {
<span class="lineNum">     464 </span>            :         NS_PRECONDITION(aFace != nullptr, &quot;aFace is NULL!&quot;);
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :         mIsDataUserFont = true;</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :         InitPattern();</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     468 </span>            : 
<span class="lineNum">     469 </span>            :     virtual ~gfxDownloadedFcFontEntry();
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span>            :     // Returns true on success
<span class="lineNum">     472 </span>            :     bool SetCairoFace(cairo_font_face_t *aFace);
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span>            :     virtual hb_blob_t* GetFontTable(uint32_t aTableTag) override;
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span>            : protected:
<span class="lineNum">     477 </span>            :     void InitPattern();
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            :     // mFontData holds the data used to instantiate the FT_Face;
<span class="lineNum">     480 </span>            :     // this has to persist until we are finished with the face,
<span class="lineNum">     481 </span>            :     // then be released with free().
<span class="lineNum">     482 </span>            :     const uint8_t* mFontData;
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span>            :     FT_Face mFace;
<span class="lineNum">     485 </span>            : };
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            : // A property for recording gfxDownloadedFcFontEntrys on FcPatterns.
<a name="488"><span class="lineNum">     488 </span>            : static const char *kFontEntryFcProp = &quot;-moz-font-entry&quot;;</a>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineNoCov">          0 : static FcBool AddDownloadedFontEntry(FcPattern *aPattern,</span>
<span class="lineNum">     491 </span>            :                                      gfxDownloadedFcFontEntry *aFontEntry)
<span class="lineNum">     492 </span>            : {
<span class="lineNum">     493 </span>            :     FcValue value;
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :     value.type = FcTypeFTFace; // void* field of union</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :     value.u.f = aFontEntry;</span>
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :     return FcPatternAdd(aPattern, kFontEntryFcProp, value, FcFalse);</span>
<a name="498"><span class="lineNum">     498 </span>            : }</a>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineNoCov">          0 : static FcBool DelDownloadedFontEntry(FcPattern *aPattern)</span>
<span class="lineNum">     501 </span>            : {
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :     return FcPatternDel(aPattern, kFontEntryFcProp);</span>
<a name="503"><span class="lineNum">     503 </span>            : }</a>
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span><span class="lineNoCov">          0 : static gfxDownloadedFcFontEntry *GetDownloadedFontEntry(FcPattern *aPattern)</span>
<span class="lineNum">     506 </span>            : {
<span class="lineNum">     507 </span>            :     FcValue value;
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :     if (FcPatternGet(aPattern, kFontEntryFcProp, 0, &amp;value) != FcResultMatch)</span>
<span class="lineNum">     509 </span>            :         return nullptr;
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :     if (value.type != FcTypeFTFace) {</span>
<span class="lineNum">     512 </span>            :         NS_NOTREACHED(&quot;Wrong type for -moz-font-entry font property&quot;);
<span class="lineNum">     513 </span>            :         return nullptr;
<span class="lineNum">     514 </span>            :     }
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :     return static_cast&lt;gfxDownloadedFcFontEntry*&gt;(value.u.f);</span>
<a name="517"><span class="lineNum">     517 </span>            : }</a>
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span><span class="lineNoCov">          0 : gfxDownloadedFcFontEntry::~gfxDownloadedFcFontEntry()</span>
<span class="lineNum">     520 </span>            : {
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :     if (mPatterns.Length() != 0) {</span>
<span class="lineNum">     522 </span>            :         // Remove back reference to this font entry and the face in case
<span class="lineNum">     523 </span>            :         // anyone holds a reference to the pattern.
<span class="lineNum">     524 </span>            :         NS_ASSERTION(mPatterns.Length() == 1,
<span class="lineNum">     525 </span>            :                      &quot;More than one pattern in gfxDownloadedFcFontEntry!&quot;);
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :         DelDownloadedFontEntry(mPatterns[0]);</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :         FcPatternDel(mPatterns[0], FC_FT_FACE);</span>
<span class="lineNum">     528 </span>            :     }
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     FT_Done_Face(mFace);</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :     free((void*)mFontData);</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     532 </span>            : 
<span class="lineNum">     533 </span>            : typedef FcPattern* (*QueryFaceFunction)(const FT_Face face,
<span class="lineNum">     534 </span>            :                                         const FcChar8 *file, int id,
<span class="lineNum">     535 </span>            :                                         FcBlanks *blanks);
<a name="536"><span class="lineNum">     536 </span>            : </a>
<span class="lineNum">     537 </span>            : void
<span class="lineNum">     538 </span><span class="lineNoCov">          0 : gfxDownloadedFcFontEntry::InitPattern()</span>
<span class="lineNum">     539 </span>            : {
<span class="lineNum">     540 </span>            :     static QueryFaceFunction sQueryFacePtr =
<span class="lineNum">     541 </span>            :         reinterpret_cast&lt;QueryFaceFunction&gt;
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :         (FindFunctionSymbol(&quot;FcFreeTypeQueryFace&quot;));</span>
<span class="lineNum">     543 </span>            :     FcPattern *pattern;
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span>            :     // FcFreeTypeQueryFace is the same function used to construct patterns for
<span class="lineNum">     546 </span>            :     // system fonts and so is the preferred function to use for this purpose.
<span class="lineNum">     547 </span>            :     // This will set up the langset property, which helps with sorting, and
<span class="lineNum">     548 </span>            :     // the foundry, fullname, and fontversion properties, which properly
<span class="lineNum">     549 </span>            :     // identify the font to fontconfig rules.  However, FcFreeTypeQueryFace is
<span class="lineNum">     550 </span>            :     // available only from fontconfig-2.4.2 (December 2006).  (CentOS 5.0 has
<span class="lineNum">     551 </span>            :     // fontconfig-2.4.1.)
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :     if (sQueryFacePtr) {</span>
<span class="lineNum">     553 </span>            :         // The &quot;file&quot; argument cannot be nullptr (in fontconfig-2.6.0 at
<span class="lineNum">     554 </span>            :         // least). The dummy file passed here is removed below.
<span class="lineNum">     555 </span>            :         //
<span class="lineNum">     556 </span>            :         // When fontconfig scans the system fonts, FcConfigGetBlanks(nullptr)
<span class="lineNum">     557 </span>            :         // is passed as the &quot;blanks&quot; argument, which provides that unexpectedly
<span class="lineNum">     558 </span>            :         // blank glyphs are elided.  Here, however, we pass nullptr for
<span class="lineNum">     559 </span>            :         // &quot;blanks&quot;, effectively assuming that, if the font has a blank glyph,
<span class="lineNum">     560 </span>            :         // then the author intends any associated character to be rendered
<span class="lineNum">     561 </span>            :         // blank.
<span class="lineNum">     562 </span>            :         pattern =
<span class="lineNum">     563 </span>            :             (*sQueryFacePtr)(mFace,
<span class="lineNum">     564 </span>            :                              gfxFontconfigUtils::ToFcChar8(&quot;&quot;),
<span class="lineNum">     565 </span>            :                              0,
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                              nullptr);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :         if (!pattern)</span>
<span class="lineNum">     568 </span>            :             // Either OOM, or fontconfig chose to skip this font because it
<span class="lineNum">     569 </span>            :             // has &quot;no encoded characters&quot;, which I think means &quot;BDF and PCF
<span class="lineNum">     570 </span>            :             // fonts which are not in Unicode (or the effectively equivalent
<span class="lineNum">     571 </span>            :             // ISO Latin-1) encoding&quot;.
<span class="lineNum">     572 </span>            :             return;
<span class="lineNum">     573 </span>            : 
<span class="lineNum">     574 </span>            :         // These properties don't make sense for this face without a file.
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :         FcPatternDel(pattern, FC_FILE);</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :         FcPatternDel(pattern, FC_INDEX);</span>
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            :     } else {
<span class="lineNum">     579 </span>            :         // Do the minimum necessary to construct a pattern for sorting.
<span class="lineNum">     580 </span>            : 
<span class="lineNum">     581 </span>            :         // FC_CHARSET is vital to determine which characters are supported.
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :         nsAutoRef&lt;FcCharSet&gt; charset(FcFreeTypeCharSet(mFace, nullptr));</span>
<span class="lineNum">     583 </span>            :         // If there are no characters then assume we don't know how to read
<span class="lineNum">     584 </span>            :         // this font.
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :         if (!charset || FcCharSetCount(charset) == 0)</span>
<span class="lineNum">     586 </span>            :             return;
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         pattern = FcPatternCreate();</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :         FcPatternAddCharSet(pattern, FC_CHARSET, charset);</span>
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            :         // FC_PIXEL_SIZE can be important for font selection of fixed-size
<span class="lineNum">     592 </span>            :         // fonts.
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :         if (!(mFace-&gt;face_flags &amp; FT_FACE_FLAG_SCALABLE)) {</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :             for (FT_Int i = 0; i &lt; mFace-&gt;num_fixed_sizes; ++i) {</span>
<span class="lineNum">     595 </span>            : #if HAVE_FT_BITMAP_SIZE_Y_PPEM
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                 double size = FLOAT_FROM_26_6(mFace-&gt;available_sizes[i].y_ppem);</span>
<span class="lineNum">     597 </span>            : #else
<span class="lineNum">     598 </span>            :                 double size = mFace-&gt;available_sizes[i].height;
<span class="lineNum">     599 </span>            : #endif
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                 FcPatternAddDouble (pattern, FC_PIXEL_SIZE, size);</span>
<span class="lineNum">     601 </span>            :             }
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span>            :             // Not sure whether this is important;
<span class="lineNum">     604 </span>            :             // imitating FcFreeTypeQueryFace:
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :             FcPatternAddBool (pattern, FC_ANTIALIAS, FcFalse);</span>
<span class="lineNum">     606 </span>            :         }
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span>            :         // Setting up the FC_LANGSET property is very difficult with the APIs
<span class="lineNum">     609 </span>            :         // available prior to FcFreeTypeQueryFace.  Having no FC_LANGSET
<span class="lineNum">     610 </span>            :         // property seems better than having a property with an empty LangSet.
<span class="lineNum">     611 </span>            :         // With no FC_LANGSET property, fontconfig sort functions will
<span class="lineNum">     612 </span>            :         // consider this face to have the same priority as (otherwise equal)
<span class="lineNum">     613 </span>            :         // faces that have support for the primary requested language, but
<span class="lineNum">     614 </span>            :         // will not consider any language to have been satisfied (and so will
<span class="lineNum">     615 </span>            :         // continue to look for a face with language support in fallback
<span class="lineNum">     616 </span>            :         // fonts).
<span class="lineNum">     617 </span>            :     }
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :     AdjustPatternToCSS(pattern);</span>
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :     FcPatternAddFTFace(pattern, FC_FT_FACE, mFace);</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :     AddDownloadedFontEntry(pattern, this);</span>
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span>            :     // There is never more than one pattern
<span class="lineNum">     625 </span>            :     // FIXME: Make this infallible after bug 968520 is done.
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :     MOZ_ALWAYS_TRUE(mPatterns.AppendElement(fallible));</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :     mPatterns[0].own(pattern);</span>
<a name="628"><span class="lineNum">     628 </span>            : }</a>
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span><span class="lineNoCov">          0 : static void ReleaseDownloadedFontEntry(void *data)</span>
<span class="lineNum">     631 </span>            : {
<span class="lineNum">     632 </span>            :     gfxDownloadedFcFontEntry *downloadedFontEntry =
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :         static_cast&lt;gfxDownloadedFcFontEntry*&gt;(data);</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :     NS_RELEASE(downloadedFontEntry);</span>
<a name="635"><span class="lineNum">     635 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineNoCov">          0 : bool gfxDownloadedFcFontEntry::SetCairoFace(cairo_font_face_t *aFace)</span>
<span class="lineNum">     638 </span>            : {
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :     if (CAIRO_STATUS_SUCCESS !=</span>
<span class="lineNum">     640 </span>            :         cairo_font_face_set_user_data(aFace, &amp;sFontEntryKey, this,
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :                                       ReleaseDownloadedFontEntry))</span>
<span class="lineNum">     642 </span>            :         return false;
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span>            :     // Hold a reference to this font entry to keep the font face data.
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :     NS_ADDREF(this);</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :     return true;</span>
<span class="lineNum">     647 </span>            : }
<a name="648"><span class="lineNum">     648 </span>            : </a>
<span class="lineNum">     649 </span>            : hb_blob_t *
<span class="lineNum">     650 </span><span class="lineNoCov">          0 : gfxDownloadedFcFontEntry::GetFontTable(uint32_t aTableTag)</span>
<span class="lineNum">     651 </span>            : {
<span class="lineNum">     652 </span>            :     // The entry already owns the (sanitized) sfnt data in mFontData,
<span class="lineNum">     653 </span>            :     // so we can just return a blob that &quot;wraps&quot; the appropriate chunk of it.
<span class="lineNum">     654 </span>            :     // The blob should not attempt to free its data, as the entire sfnt data
<span class="lineNum">     655 </span>            :     // will be freed when the font entry is deleted.
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :     return gfxFontUtils::GetTableFromFontData(mFontData, aTableTag);</span>
<span class="lineNum">     657 </span>            : }
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span>            : /*
<span class="lineNum">     660 </span>            :  * gfxFcFont
<span class="lineNum">     661 </span>            :  *
<span class="lineNum">     662 </span>            :  * This is a gfxFont implementation using a CAIRO_FONT_TYPE_FT
<span class="lineNum">     663 </span>            :  * cairo_scaled_font created from an FcPattern.
<span class="lineNum">     664 </span>            :  */
<span class="lineNum">     665 </span>            : 
<span class="lineNum">     666 </span>            : class gfxFcFont : public gfxFontconfigFontBase {
<span class="lineNum">     667 </span>            : public:
<span class="lineNum">     668 </span>            :     virtual ~gfxFcFont();
<span class="lineNum">     669 </span>            :     static already_AddRefed&lt;gfxFcFont&gt;
<span class="lineNum">     670 </span>            :     GetOrMakeFont(FcPattern *aRequestedPattern, FcPattern *aFontPattern,
<span class="lineNum">     671 </span>            :                   const gfxFontStyle *aFontStyle);
<span class="lineNum">     672 </span>            : 
<span class="lineNum">     673 </span>            :     // return a cloned font resized and offset to simulate sub/superscript glyphs
<span class="lineNum">     674 </span>            :     virtual already_AddRefed&lt;gfxFont&gt;
<span class="lineNum">     675 </span>            :     GetSubSuperscriptFont(int32_t aAppUnitsPerDevPixel) override;
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            : protected:
<span class="lineNum">     678 </span>            :     virtual already_AddRefed&lt;gfxFont&gt; MakeScaledFont(gfxFontStyle *aFontStyle,
<span class="lineNum">     679 </span>            :                                                      gfxFloat aFontScale);
<span class="lineNum">     680 </span>            :     virtual already_AddRefed&lt;gfxFont&gt; GetSmallCapsFont() override;
<span class="lineNum">     681 </span>            : 
<span class="lineNum">     682 </span>            : private:
<span class="lineNum">     683 </span>            :     gfxFcFont(cairo_scaled_font_t *aCairoFont,
<span class="lineNum">     684 </span>            :               FcPattern *aPattern,
<span class="lineNum">     685 </span>            :               gfxFcFontEntry *aFontEntry,
<span class="lineNum">     686 </span>            :               const gfxFontStyle *aFontStyle);
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span>            :     // key for locating a gfxFcFont corresponding to a cairo_scaled_font
<span class="lineNum">     689 </span>            :     static cairo_user_data_key_t sGfxFontKey;
<span class="lineNum">     690 </span>            : };
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span>            : /**
<span class="lineNum">     693 </span>            :  * gfxFcFontSet:
<span class="lineNum">     694 </span>            :  *
<span class="lineNum">     695 </span>            :  * Translation from a desired FcPattern to a sorted set of font references
<span class="lineNum">     696 </span>            :  * (fontconfig cache data) and (when needed) fonts.
<span class="lineNum">     697 </span>            :  */
<span class="lineNum">     698 </span>            : 
<a name="699"><span class="lineNum">     699 </span>            : class gfxFcFontSet final {</a>
<span class="lineNum">     700 </span>            : public:
<a name="701"><span class="lineNum">     701 </span><span class="lineNoCov">          0 :     NS_INLINE_DECL_REFCOUNTING(gfxFcFontSet)</span></a>
<span class="lineNum">     702 </span>            :     
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :     explicit gfxFcFontSet(FcPattern *aPattern,</span>
<span class="lineNum">     704 </span>            :                                gfxUserFontSet *aUserFontSet)
<span class="lineNum">     705 </span>            :         : mSortPattern(aPattern), mUserFontSet(aUserFontSet),
<span class="lineNum">     706 </span>            :           mFcFontsTrimmed(0),
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :           mHaveFallbackFonts(false)</span>
<span class="lineNum">     708 </span>            :     {
<span class="lineNum">     709 </span>            :         bool waitForUserFont;
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         mFcFontSet = SortPreferredFonts(waitForUserFont);</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :         mWaitingForUserFont = waitForUserFont;</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     713 </span>            : 
<a name="714"><span class="lineNum">     714 </span>            :     // A reference is held by the FontSet.</a>
<span class="lineNum">     715 </span>            :     // The caller may add a ref to keep the font alive longer than the FontSet.
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :     gfxFcFont *GetFontAt(uint32_t i, const gfxFontStyle *aFontStyle)</span>
<span class="lineNum">     717 </span>            :     {
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :         if (i &gt;= mFonts.Length() || !mFonts[i].mFont) { </span>
<span class="lineNum">     719 </span>            :             // GetFontPatternAt sets up mFonts
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :             FcPattern *fontPattern = GetFontPatternAt(i);</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :             if (!fontPattern)</span>
<span class="lineNum">     722 </span>            :                 return nullptr;
<span class="lineNum">     723 </span>            : 
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :             mFonts[i].mFont =</span>
<span class="lineNum">     725 </span>            :                 gfxFcFont::GetOrMakeFont(mSortPattern, fontPattern,
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                                          aFontStyle);</span>
<span class="lineNum">     727 </span>            :         }
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :         return mFonts[i].mFont;</span>
<span class="lineNum">     729 </span>            :     }
<span class="lineNum">     730 </span>            : 
<span class="lineNum">     731 </span>            :     FcPattern *GetFontPatternAt(uint32_t i);
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span>            :     bool WaitingForUserFont() const {
<span class="lineNum">     734 </span>            :         return mWaitingForUserFont;
<span class="lineNum">     735 </span>            :     }
<span class="lineNum">     736 </span>            : 
<a name="737"><span class="lineNum">     737 </span>            : private:</a>
<span class="lineNum">     738 </span>            :     // Private destructor, to discourage deletion outside of Release():
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :     ~gfxFcFontSet()</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :     {</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     742 </span>            : 
<span class="lineNum">     743 </span>            :     nsReturnRef&lt;FcFontSet&gt; SortPreferredFonts(bool&amp; aWaitForUserFont);
<a name="744"><span class="lineNum">     744 </span>            :     nsReturnRef&lt;FcFontSet&gt; SortFallbackFonts();</a>
<span class="lineNum">     745 </span>            : 
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     struct FontEntry {</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :         explicit FontEntry(FcPattern *aPattern) : mPattern(aPattern) {}</span>
<span class="lineNum">     748 </span>            :         nsCountedRef&lt;FcPattern&gt; mPattern;
<span class="lineNum">     749 </span>            :         RefPtr&lt;gfxFcFont&gt; mFont;
<span class="lineNum">     750 </span>            :     };
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span>            :     struct LangSupportEntry {
<span class="lineNum">     753 </span>            :         LangSupportEntry(FcChar8 *aLang, FcLangResult aSupport) :
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :             mLang(aLang), mBestSupport(aSupport) {}</span>
<span class="lineNum">     755 </span>            :         FcChar8 *mLang;
<span class="lineNum">     756 </span>            :         FcLangResult mBestSupport;
<span class="lineNum">     757 </span>            :     };
<span class="lineNum">     758 </span>            : 
<span class="lineNum">     759 </span>            : public:
<span class="lineNum">     760 </span>            :     // public for nsTArray
<a name="761"><span class="lineNum">     761 </span>            :     class LangComparator {</a>
<span class="lineNum">     762 </span>            :     public:
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :         bool Equals(const LangSupportEntry&amp; a, const FcChar8 *b) const</span>
<span class="lineNum">     764 </span>            :         {
<span class="lineNum">     765 </span><span class="lineNoCov">          0 :             return FcStrCmpIgnoreCase(a.mLang, b) == 0;</span>
<span class="lineNum">     766 </span>            :         }
<span class="lineNum">     767 </span>            :     };
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span>            : private:
<span class="lineNum">     770 </span>            :     // The requested pattern
<span class="lineNum">     771 </span>            :     nsCountedRef&lt;FcPattern&gt; mSortPattern;
<span class="lineNum">     772 </span>            :     // Fonts from @font-face rules
<span class="lineNum">     773 </span>            :     RefPtr&lt;gfxUserFontSet&gt; mUserFontSet;
<span class="lineNum">     774 </span>            :     // A (trimmed) list of font patterns and fonts that is built up as
<span class="lineNum">     775 </span>            :     // required.
<span class="lineNum">     776 </span>            :     nsTArray&lt;FontEntry&gt; mFonts;
<span class="lineNum">     777 </span>            :     // Holds a list of font patterns that will be trimmed.  This is first set
<span class="lineNum">     778 </span>            :     // to a list of preferred fonts.  Then, if/when all the preferred fonts
<span class="lineNum">     779 </span>            :     // have been trimmed and added to mFonts, this is set to a list of
<span class="lineNum">     780 </span>            :     // fallback fonts.
<span class="lineNum">     781 </span>            :     nsAutoRef&lt;FcFontSet&gt; mFcFontSet;
<span class="lineNum">     782 </span>            :     // The set of characters supported by the fonts in mFonts.
<span class="lineNum">     783 </span>            :     nsAutoRef&lt;FcCharSet&gt; mCharSet;
<span class="lineNum">     784 </span>            :     // The index of the next font in mFcFontSet that has not yet been
<span class="lineNum">     785 </span>            :     // considered for mFonts.
<span class="lineNum">     786 </span>            :     int mFcFontsTrimmed;
<span class="lineNum">     787 </span>            :     // True iff fallback fonts are either stored in mFcFontSet or have been
<span class="lineNum">     788 </span>            :     // trimmed and added to mFonts (so that mFcFontSet is nullptr).
<span class="lineNum">     789 </span>            :     bool mHaveFallbackFonts;
<span class="lineNum">     790 </span>            :     // True iff there was a user font set with pending downloads,
<span class="lineNum">     791 </span>            :     // so the set may be updated when downloads complete
<span class="lineNum">     792 </span>            :     bool mWaitingForUserFont;
<span class="lineNum">     793 </span>            : };
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span>            : // Find the FcPattern for an @font-face font suitable for CSS family |aFamily|
<a name="796"><span class="lineNum">     796 </span>            : // and style |aStyle| properties.</a>
<span class="lineNum">     797 </span>            : static const nsTArray&lt; nsCountedRef&lt;FcPattern&gt; &gt;*
<span class="lineNum">     798 </span><span class="lineNoCov">          0 : FindFontPatterns(gfxUserFontSet *mUserFontSet,</span>
<span class="lineNum">     799 </span>            :                  const nsACString &amp;aFamily, uint8_t aStyle,
<span class="lineNum">     800 </span>            :                  uint16_t aWeight, int16_t aStretch,
<span class="lineNum">     801 </span>            :                  bool&amp; aWaitForUserFont)
<span class="lineNum">     802 </span>            : {
<span class="lineNum">     803 </span>            :     // Convert to UTF16
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :     NS_ConvertUTF8toUTF16 utf16Family(aFamily);</span>
<span class="lineNum">     805 </span>            : 
<span class="lineNum">     806 </span>            :     // needsBold is not used here.  Instead synthetic bold is enabled through
<span class="lineNum">     807 </span>            :     // FcFontRenderPrepare when the weight in the requested pattern is
<span class="lineNum">     808 </span>            :     // compared against the weight in the font pattern.
<span class="lineNum">     809 </span>            :     bool needsBold;
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :     gfxFontStyle style;</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :     style.style = aStyle;</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :     style.weight = aWeight;</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :     style.stretch = aStretch;</span>
<span class="lineNum">     815 </span>            : 
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :     gfxUserFcFontEntry *fontEntry = nullptr;</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     gfxFontFamily *family = mUserFontSet-&gt;LookupFamily(utf16Family);</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :     if (family) {</span>
<span class="lineNum">     819 </span>            :         gfxUserFontEntry* userFontEntry =
<span class="lineNum">     820 </span>            :             mUserFontSet-&gt;FindUserFontEntryAndLoad(family, style, needsBold,
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                                                    aWaitForUserFont);</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :         if (userFontEntry) {</span>
<span class="lineNum">     823 </span>            :             fontEntry = static_cast&lt;gfxUserFcFontEntry*&gt;
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :                 (userFontEntry-&gt;GetPlatformFontEntry());</span>
<span class="lineNum">     825 </span>            :         }
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span>            :         // Accept synthetic oblique for italic and oblique.
<span class="lineNum">     828 </span>            :         // xxx - this isn't really ideal behavior, for docs that only use a
<span class="lineNum">     829 </span>            :         //       single italic face it will also pull down the normal face
<span class="lineNum">     830 </span>            :         //       and probably never use it
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :         if (!fontEntry &amp;&amp; aStyle != NS_FONT_STYLE_NORMAL) {</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :             style.style = NS_FONT_STYLE_NORMAL;</span>
<span class="lineNum">     833 </span>            :             userFontEntry =
<span class="lineNum">     834 </span>            :                 mUserFontSet-&gt;FindUserFontEntryAndLoad(family, style,
<span class="lineNum">     835 </span>            :                                                        needsBold,
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :                                                        aWaitForUserFont);</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :             if (userFontEntry) {</span>
<span class="lineNum">     838 </span>            :                 fontEntry = static_cast&lt;gfxUserFcFontEntry*&gt;
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :                     (userFontEntry-&gt;GetPlatformFontEntry());</span>
<span class="lineNum">     840 </span>            :             }
<span class="lineNum">     841 </span>            :         }
<span class="lineNum">     842 </span>            :     }
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :     if (!fontEntry) {</span>
<span class="lineNum">     845 </span>            :         return nullptr;
<span class="lineNum">     846 </span>            :     }
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :     return &amp;fontEntry-&gt;GetPatterns();</span>
<span class="lineNum">     849 </span>            : }
<span class="lineNum">     850 </span>            : 
<span class="lineNum">     851 </span>            : typedef FcBool (*FcPatternRemoveFunction)(FcPattern *p, const char *object,
<span class="lineNum">     852 </span>            :                                           int id);
<span class="lineNum">     853 </span>            : 
<a name="854"><span class="lineNum">     854 </span>            : // FcPatternRemove is available in fontconfig-2.3.0 (2005)</a>
<span class="lineNum">     855 </span>            : static FcBool
<span class="lineNum">     856 </span><span class="lineNoCov">          0 : moz_FcPatternRemove(FcPattern *p, const char *object, int id)</span>
<span class="lineNum">     857 </span>            : {
<span class="lineNum">     858 </span>            :     static FcPatternRemoveFunction sFcPatternRemovePtr =
<span class="lineNum">     859 </span>            :         reinterpret_cast&lt;FcPatternRemoveFunction&gt;
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :         (FindFunctionSymbol(&quot;FcPatternRemove&quot;));</span>
<span class="lineNum">     861 </span>            : 
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :     if (!sFcPatternRemovePtr)</span>
<span class="lineNum">     863 </span>            :         return FcFalse;
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :     return (*sFcPatternRemovePtr)(p, object, id);</span>
<span class="lineNum">     866 </span>            : }
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span>            : // fontconfig prefers a matching family or lang to pixelsize of bitmap
<a name="869"><span class="lineNum">     869 </span>            : // fonts.  CSS suggests a tolerance of 20% on pixelsize.</a>
<span class="lineNum">     870 </span>            : static bool
<span class="lineNum">     871 </span><span class="lineNoCov">          0 : SizeIsAcceptable(FcPattern *aFont, double aRequestedSize)</span>
<span class="lineNum">     872 </span>            : {
<span class="lineNum">     873 </span>            :     double size;
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :     int v = 0;</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :     while (FcPatternGetDouble(aFont,</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :                               FC_PIXEL_SIZE, v, &amp;size) == FcResultMatch) {</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :         ++v;</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :         if (5.0 * fabs(size - aRequestedSize) &lt; aRequestedSize)</span>
<span class="lineNum">     879 </span>            :             return true;
<span class="lineNum">     880 </span>            :     }
<span class="lineNum">     881 </span>            : 
<span class="lineNum">     882 </span>            :     // No size means scalable
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :     return v == 0;</span>
<span class="lineNum">     884 </span>            : }
<span class="lineNum">     885 </span>            : 
<span class="lineNum">     886 </span>            : // Sorting only the preferred fonts first usually saves having to sort through
<a name="887"><span class="lineNum">     887 </span>            : // every font on the system.</a>
<span class="lineNum">     888 </span>            : nsReturnRef&lt;FcFontSet&gt;
<span class="lineNum">     889 </span><span class="lineNoCov">          0 : gfxFcFontSet::SortPreferredFonts(bool &amp;aWaitForUserFont)</span>
<span class="lineNum">     890 </span>            : {
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :     aWaitForUserFont = false;</span>
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :     gfxFontconfigUtils *utils = gfxFontconfigUtils::GetFontconfigUtils();</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :     if (!utils)</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :         return nsReturnRef&lt;FcFontSet&gt;();</span>
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span>            :     // The list of families in mSortPattern has values with both weak and
<span class="lineNum">     898 </span>            :     // strong bindings.  Values with strong bindings should be preferred.
<span class="lineNum">     899 </span>            :     // Values with weak bindings are default fonts that should be considered
<span class="lineNum">     900 </span>            :     // only when the font provides the best support for a requested language
<span class="lineNum">     901 </span>            :     // or after other fonts have satisfied all the requested languages.
<span class="lineNum">     902 </span>            :     //
<span class="lineNum">     903 </span>            :     // There are no direct fontconfig APIs to get the binding type.  The
<span class="lineNum">     904 </span>            :     // binding only takes effect in the sort and match functions.
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span>            :     // |requiredLangs| is a list of requested languages that have not yet been
<span class="lineNum">     907 </span>            :     // satisfied.  gfxFontconfigUtils only sets one FC_LANG property value,
<span class="lineNum">     908 </span>            :     // but FcConfigSubstitute may add more values (e.g. prepending &quot;en&quot; to
<span class="lineNum">     909 </span>            :     // &quot;ja&quot; will use western fonts to render Latin/Arabic numerals in Japanese
<span class="lineNum">     910 </span>            :     // text.)
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :     AutoTArray&lt;LangSupportEntry,10&gt; requiredLangs;</span>
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :     for (int v = 0; ; ++v) {</span>
<span class="lineNum">     913 </span>            :         FcChar8 *lang;
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :         FcResult result = FcPatternGetString(mSortPattern, FC_LANG, v, &amp;lang);</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :         if (result != FcResultMatch) {</span>
<span class="lineNum">     916 </span>            :             // No need to check FcPatternGetLangSet() because
<span class="lineNum">     917 </span>            :             // gfxFontconfigUtils sets only a string value for FC_LANG and
<span class="lineNum">     918 </span>            :             // FcConfigSubstitute cannot add LangSets.
<span class="lineNum">     919 </span>            :             NS_ASSERTION(result != FcResultTypeMismatch,
<span class="lineNum">     920 </span>            :                          &quot;Expected a string for FC_LANG&quot;);
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">     922 </span>            :         }
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :         if (!requiredLangs.Contains(lang, LangComparator())) {</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :             FcLangResult bestLangSupport = utils-&gt;GetBestLangSupport(lang);</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :             if (bestLangSupport != FcLangDifferentLang) {</span>
<span class="lineNum">     927 </span>            :                 requiredLangs.
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :                     AppendElement(LangSupportEntry(lang, bestLangSupport));</span>
<span class="lineNum">     929 </span>            :             }
<span class="lineNum">     930 </span>            :         }
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :     nsAutoRef&lt;FcFontSet&gt; fontSet(FcFontSetCreate());</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :     if (!fontSet)</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :         return fontSet.out();</span>
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span>            :     // FcDefaultSubstitute() ensures a slant on mSortPattern, but, if that ever
<span class="lineNum">     938 </span>            :     // doesn't happen, Roman will be used.
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :     int requestedSlant = FC_SLANT_ROMAN;</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :     FcPatternGetInteger(mSortPattern, FC_SLANT, 0, &amp;requestedSlant);</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :     double requestedSize = -1.0;</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :     FcPatternGetDouble(mSortPattern, FC_PIXEL_SIZE, 0, &amp;requestedSize);</span>
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :     nsTHashtable&lt;gfxFontconfigUtils::DepFcStrEntry&gt; existingFamilies(32);</span>
<span class="lineNum">     945 </span>            :     FcChar8 *family;
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :     for (int v = 0;</span>
<span class="lineNum">     947 </span>            :          FcPatternGetString(mSortPattern,
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :                             FC_FAMILY, v, &amp;family) == FcResultMatch; ++v) {</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :         const nsTArray&lt; nsCountedRef&lt;FcPattern&gt; &gt; *familyFonts = nullptr;</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span>            :         // Is this an @font-face family?
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :         bool isUserFont = false;</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :         if (mUserFontSet) {</span>
<span class="lineNum">     954 </span>            :             // Have some @font-face definitions
<span class="lineNum">     955 </span>            : 
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :             nsDependentCString cFamily(gfxFontconfigUtils::ToCString(family));</span>
<span class="lineNum">     957 </span>            :             NS_NAMED_LITERAL_CSTRING(userPrefix, FONT_FACE_FAMILY_PREFIX);
<span class="lineNum">     958 </span>            : 
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :             if (StringBeginsWith(cFamily, userPrefix)) {</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :                 isUserFont = true;</span>
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span>            :                 // Trim off the prefix
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                 nsDependentCSubstring cssFamily(cFamily, userPrefix.Length());</span>
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span>            :                 uint8_t thebesStyle =
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :                     gfxFontconfigUtils::FcSlantToThebesStyle(requestedSlant);</span>
<span class="lineNum">     967 </span>            :                 uint16_t thebesWeight =
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :                     gfxFontconfigUtils::GetThebesWeight(mSortPattern);</span>
<span class="lineNum">     969 </span>            :                 int16_t thebesStretch =
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                     gfxFontconfigUtils::GetThebesStretch(mSortPattern);</span>
<span class="lineNum">     971 </span>            : 
<span class="lineNum">     972 </span>            :                 bool waitForUserFont;
<span class="lineNum">     973 </span>            :                 familyFonts = FindFontPatterns(mUserFontSet, cssFamily,
<span class="lineNum">     974 </span>            :                                                thebesStyle,
<span class="lineNum">     975 </span>            :                                                thebesWeight, thebesStretch,
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :                                                waitForUserFont);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :                 if (waitForUserFont) {</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :                     aWaitForUserFont = true;</span>
<span class="lineNum">     979 </span>            :                 }
<span class="lineNum">     980 </span>            :             }
<span class="lineNum">     981 </span>            :         }
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :         if (!isUserFont) {</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :             familyFonts = &amp;utils-&gt;GetFontsForFamily(family);</span>
<span class="lineNum">     985 </span>            :         }
<span class="lineNum">     986 </span>            : 
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :         if (!familyFonts || familyFonts-&gt;Length() == 0) {</span>
<span class="lineNum">     988 </span>            :             // There are no fonts matching this family, so there is no point
<span class="lineNum">     989 </span>            :             // in searching for this family in the FontSort.
<span class="lineNum">     990 </span>            :             //
<span class="lineNum">     991 </span>            :             // Perhaps the original pattern should be retained for
<span class="lineNum">     992 </span>            :             // FcFontRenderPrepare.  However, the only a useful config
<span class="lineNum">     993 </span>            :             // substitution test against missing families that i can imagine
<span class="lineNum">     994 </span>            :             // would only be interested in the preferred family
<span class="lineNum">     995 </span>            :             // (qual=&quot;first&quot;), so always keep the first family and use the
<span class="lineNum">     996 </span>            :             // same pattern for Sort and RenderPrepare.
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :             if (v != 0 &amp;&amp; moz_FcPatternRemove(mSortPattern, FC_FAMILY, v)) {</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :                 --v;</span>
<span class="lineNum">     999 </span>            :             }
<span class="lineNum">    1000 </span>            :             continue;
<span class="lineNum">    1001 </span>            :         }
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span>            :         // Aliases seem to often end up occurring more than once, but
<span class="lineNum">    1004 </span>            :         // duplicate families can't be removed from the sort pattern without
<span class="lineNum">    1005 </span>            :         // knowing whether duplicates have the same binding.
<span class="lineNum">    1006 </span>            :         gfxFontconfigUtils::DepFcStrEntry *familyEntry =
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :             existingFamilies.PutEntry(family);</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :         if (familyEntry) {</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :             if (familyEntry-&gt;mKey) // old entry</span>
<span class="lineNum">    1010 </span>            :                 continue;
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :             familyEntry-&gt;mKey = family; // initialize new entry</span>
<span class="lineNum">    1013 </span>            :         }
<span class="lineNum">    1014 </span>            : 
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :         for (uint32_t f = 0; f &lt; familyFonts-&gt;Length(); ++f) {</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :             FcPattern *font = familyFonts-&gt;ElementAt(f);</span>
<span class="lineNum">    1017 </span>            : 
<span class="lineNum">    1018 </span>            :             // Fix up the family name of user-font patterns, as the same
<span class="lineNum">    1019 </span>            :             // font entry may be used (via the UserFontCache) for multiple
<span class="lineNum">    1020 </span>            :             // CSS family names
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :             if (isUserFont) {</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :                 font = FcPatternDuplicate(font);</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :                 FcPatternDel(font, FC_FAMILY);</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                 FcPatternAddString(font, FC_FAMILY, family);</span>
<span class="lineNum">    1025 </span>            :             }
<span class="lineNum">    1026 </span>            : 
<span class="lineNum">    1027 </span>            :             // User fonts are already filtered by slant (but not size) in
<span class="lineNum">    1028 </span>            :             // mUserFontSet-&gt;FindUserFontEntry().
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :             if (requestedSize != -1.0 &amp;&amp; !SizeIsAcceptable(font, requestedSize))</span>
<span class="lineNum">    1030 </span>            :                 continue;
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :             for (uint32_t r = 0; r &lt; requiredLangs.Length(); ++r) {</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :                 const LangSupportEntry&amp; langEntry = requiredLangs[r];</span>
<span class="lineNum">    1034 </span>            :                 FcLangResult support =
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :                     gfxFontconfigUtils::GetLangSupport(font, langEntry.mLang);</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :                 if (support &lt;= langEntry.mBestSupport) { // lower is better</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :                     requiredLangs.RemoveElementAt(r);</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                     --r;</span>
<span class="lineNum">    1039 </span>            :                 }
<span class="lineNum">    1040 </span>            :             }
<span class="lineNum">    1041 </span>            : 
<span class="lineNum">    1042 </span>            :             // FcFontSetDestroy will remove a reference but FcFontSetAdd
<span class="lineNum">    1043 </span>            :             // does _not_ take a reference!
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :             if (FcFontSetAdd(fontSet, font)) {</span>
<span class="lineNum">    1045 </span>            :                 // We don't add a reference here for user fonts, because we're
<span class="lineNum">    1046 </span>            :                 // using a local clone of the pattern (see above) in order to
<span class="lineNum">    1047 </span>            :                 // override the family name
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :                 if (!isUserFont) {</span>
<span class="lineNum">    1049 </span><span class="lineNoCov">          0 :                     FcPatternReference(font);</span>
<span class="lineNum">    1050 </span>            :                 }
<span class="lineNum">    1051 </span>            :             }
<span class="lineNum">    1052 </span>            :         }
<span class="lineNum">    1053 </span>            :     }
<span class="lineNum">    1054 </span>            : 
<span class="lineNum">    1055 </span>            :     FcPattern *truncateMarker = nullptr;
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :     for (uint32_t r = 0; r &lt; requiredLangs.Length(); ++r) {</span>
<span class="lineNum">    1057 </span>            :         const nsTArray&lt; nsCountedRef&lt;FcPattern&gt; &gt;&amp; langFonts =
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :             utils-&gt;GetFontsForLang(requiredLangs[r].mLang);</span>
<span class="lineNum">    1059 </span>            : 
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :         bool haveLangFont = false;</span>
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         for (uint32_t f = 0; f &lt; langFonts.Length(); ++f) {</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :             FcPattern *font = langFonts[f];</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :             if (requestedSize != -1.0 &amp;&amp; !SizeIsAcceptable(font, requestedSize))</span>
<span class="lineNum">    1064 </span>            :                 continue;
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :             haveLangFont = true;</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :             if (FcFontSetAdd(fontSet, font)) {</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :                 FcPatternReference(font);</span>
<span class="lineNum">    1069 </span>            :             }
<span class="lineNum">    1070 </span>            :         }
<span class="lineNum">    1071 </span>            : 
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :         if (!haveLangFont &amp;&amp; langFonts.Length() &gt; 0) {</span>
<span class="lineNum">    1073 </span>            :             // There is a font that supports this language but it didn't pass
<span class="lineNum">    1074 </span>            :             // the slant and size criteria.  Weak default font families should
<span class="lineNum">    1075 </span>            :             // not be considered until the language has been satisfied.
<span class="lineNum">    1076 </span>            :             //
<span class="lineNum">    1077 </span>            :             // Insert a font that supports the language so that it will mark
<span class="lineNum">    1078 </span>            :             // the position of fonts from weak families in the sorted set and
<span class="lineNum">    1079 </span>            :             // they can be removed.  The language and weak families will be
<span class="lineNum">    1080 </span>            :             // considered in the fallback fonts, which use fontconfig's
<span class="lineNum">    1081 </span>            :             // algorithm.
<span class="lineNum">    1082 </span>            :             //
<span class="lineNum">    1083 </span>            :             // Of the fonts that don't meet slant and size criteria, strong
<span class="lineNum">    1084 </span>            :             // default font families should be considered before (other) fonts
<span class="lineNum">    1085 </span>            :             // for this language, so this marker font will be removed (as well
<span class="lineNum">    1086 </span>            :             // as the fonts from weak families), and strong families will be
<span class="lineNum">    1087 </span>            :             // reconsidered in the fallback fonts.
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :             FcPattern *font = langFonts[0];</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :             if (FcFontSetAdd(fontSet, font)) {</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :                 FcPatternReference(font);</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :                 truncateMarker = font;</span>
<span class="lineNum">    1092 </span>            :             }
<span class="lineNum">    1093 </span>            :             break;
<span class="lineNum">    1094 </span>            :         }
<span class="lineNum">    1095 </span>            :     }
<span class="lineNum">    1096 </span>            : 
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :     FcFontSet *sets[1] = { fontSet };</span>
<span class="lineNum">    1098 </span>            :     FcResult result;
<span class="lineNum">    1099 </span>            : #ifdef SOLARIS
<span class="lineNum">    1100 </span>            :     // Get around a crash of FcFontSetSort when FcConfig is nullptr
<span class="lineNum">    1101 </span>            :     // Solaris's FcFontSetSort needs an FcConfig (bug 474758)
<span class="lineNum">    1102 </span>            :     fontSet.own(FcFontSetSort(FcConfigGetCurrent(), sets, 1, mSortPattern,
<span class="lineNum">    1103 </span>            :                               FcFalse, nullptr, &amp;result));
<span class="lineNum">    1104 </span>            : #else
<span class="lineNum">    1105 </span>            :     fontSet.own(FcFontSetSort(nullptr, sets, 1, mSortPattern,
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :                               FcFalse, nullptr, &amp;result));</span>
<span class="lineNum">    1107 </span>            : #endif
<span class="lineNum">    1108 </span>            : 
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :     if (truncateMarker != nullptr &amp;&amp; fontSet) {</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :         nsAutoRef&lt;FcFontSet&gt; truncatedSet(FcFontSetCreate());</span>
<span class="lineNum">    1111 </span>            : 
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :         for (int f = 0; f &lt; fontSet-&gt;nfont; ++f) {</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :             FcPattern *font = fontSet-&gt;fonts[f];</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :             if (font == truncateMarker)</span>
<span class="lineNum">    1115 </span>            :                 break;
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :             if (FcFontSetAdd(truncatedSet, font)) {</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :                 FcPatternReference(font);</span>
<span class="lineNum">    1119 </span>            :             }
<span class="lineNum">    1120 </span>            :         }
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span>            :         fontSet.steal(truncatedSet);
<span class="lineNum">    1123 </span>            :     }
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :     return fontSet.out();</span>
<span class="lineNum">    1126 </span>            : }
<a name="1127"><span class="lineNum">    1127 </span>            : </a>
<span class="lineNum">    1128 </span>            : nsReturnRef&lt;FcFontSet&gt;
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 : gfxFcFontSet::SortFallbackFonts()</span>
<span class="lineNum">    1130 </span>            : {
<span class="lineNum">    1131 </span>            :     // Setting trim to FcTrue would provide a much smaller (~ 1/10) FcFontSet,
<span class="lineNum">    1132 </span>            :     // but would take much longer due to comparing all the character sets.
<span class="lineNum">    1133 </span>            :     //
<span class="lineNum">    1134 </span>            :     // The references to fonts in this FcFontSet are almost free
<span class="lineNum">    1135 </span>            :     // as they are pointers into mmaped cache files.
<span class="lineNum">    1136 </span>            :     //
<span class="lineNum">    1137 </span>            :     // GetFontPatternAt() will trim lazily if and as needed, which will also
<span class="lineNum">    1138 </span>            :     // remove duplicates of preferred fonts.
<span class="lineNum">    1139 </span>            :     FcResult result;
<span class="lineNum">    1140 </span>            :     return nsReturnRef&lt;FcFontSet&gt;(FcFontSort(nullptr, mSortPattern,
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :                                              FcFalse, nullptr, &amp;result));</span>
<span class="lineNum">    1142 </span>            : }
<span class="lineNum">    1143 </span>            : 
<a name="1144"><span class="lineNum">    1144 </span>            : // GetFontAt relies on this setting up all patterns up to |i|.</a>
<span class="lineNum">    1145 </span>            : FcPattern *
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 : gfxFcFontSet::GetFontPatternAt(uint32_t i)</span>
<span class="lineNum">    1147 </span>            : {
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :     while (i &gt;= mFonts.Length()) {</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :         while (!mFcFontSet) {</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :             if (mHaveFallbackFonts)</span>
<span class="lineNum">    1151 </span>            :                 return nullptr;
<span class="lineNum">    1152 </span>            : 
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :             mFcFontSet = SortFallbackFonts();</span>
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :             mHaveFallbackFonts = true;</span>
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :             mFcFontsTrimmed = 0;</span>
<span class="lineNum">    1156 </span>            :             // Loop to test that mFcFontSet is non-nullptr.
<span class="lineNum">    1157 </span>            :         }
<span class="lineNum">    1158 </span>            : 
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :         while (mFcFontsTrimmed &lt; mFcFontSet-&gt;nfont) {</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :             FcPattern *font = mFcFontSet-&gt;fonts[mFcFontsTrimmed];</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :             ++mFcFontsTrimmed;</span>
<span class="lineNum">    1162 </span>            : 
<span class="lineNum">    1163 </span><span class="lineNoCov">          0 :             if (mFonts.Length() != 0) {</span>
<span class="lineNum">    1164 </span>            :                 // See if the next font provides support for any extra
<span class="lineNum">    1165 </span>            :                 // characters.  Most often the next font is not going to
<span class="lineNum">    1166 </span>            :                 // support more characters so check for a SubSet first before
<span class="lineNum">    1167 </span>            :                 // allocating a new CharSet with Union.
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :                 FcCharSet *supportedChars = mCharSet;</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :                 if (!supportedChars) {</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :                     FcPatternGetCharSet(mFonts[mFonts.Length() - 1].mPattern,</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :                                         FC_CHARSET, 0, &amp;supportedChars);</span>
<span class="lineNum">    1172 </span>            :                 }
<span class="lineNum">    1173 </span>            : 
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :                 if (supportedChars) {</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :                     FcCharSet *newChars = nullptr;</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :                     FcPatternGetCharSet(font, FC_CHARSET, 0, &amp;newChars);</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :                     if (newChars) {</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                         if (FcCharSetIsSubset(newChars, supportedChars))</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                             continue;</span>
<span class="lineNum">    1180 </span>            : 
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :                         mCharSet.own(FcCharSetUnion(supportedChars, newChars));</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :                     } else if (!mCharSet) {</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :                         mCharSet.own(FcCharSetCopy(supportedChars));</span>
<span class="lineNum">    1184 </span>            :                     }
<span class="lineNum">    1185 </span>            :                 }
<span class="lineNum">    1186 </span>            :             }
<span class="lineNum">    1187 </span>            : 
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :             mFonts.AppendElement(font);</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :             if (mFonts.Length() &gt;= i)</span>
<span class="lineNum">    1190 </span>            :                 break;
<span class="lineNum">    1191 </span>            :         }
<span class="lineNum">    1192 </span>            : 
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :         if (mFcFontsTrimmed == mFcFontSet-&gt;nfont) {</span>
<span class="lineNum">    1194 </span>            :             // finished with this font set
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :             mFcFontSet.reset();</span>
<span class="lineNum">    1196 </span>            :         }
<span class="lineNum">    1197 </span>            :     }
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :     return mFonts[i].mPattern;</span>
<span class="lineNum">    1200 </span>            : }
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">    1203 </span>            : static void ApplyGdkScreenFontOptions(FcPattern *aPattern);
<span class="lineNum">    1204 </span>            : #endif
<span class="lineNum">    1205 </span>            : 
<a name="1206"><span class="lineNum">    1206 </span>            : // Apply user settings and defaults to pattern in preparation for matching.</a>
<span class="lineNum">    1207 </span>            : static void
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 : PrepareSortPattern(FcPattern *aPattern, double aFallbackSize,</span>
<span class="lineNum">    1209 </span>            :                    double aSizeAdjustFactor, bool aIsPrinterFont)
<span class="lineNum">    1210 </span>            : {
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :     FcConfigSubstitute(nullptr, aPattern, FcMatchPattern);</span>
<span class="lineNum">    1212 </span>            : 
<span class="lineNum">    1213 </span>            :     // This gets cairo_font_options_t for the Screen.  We should have
<span class="lineNum">    1214 </span>            :     // different font options for printing (no hinting) but we are not told
<span class="lineNum">    1215 </span>            :     // what we are measuring for.
<span class="lineNum">    1216 </span>            :     //
<span class="lineNum">    1217 </span>            :     // If cairo adds support for lcd_filter, gdk will not provide the default
<span class="lineNum">    1218 </span>            :     // setting for that option.  We could get the default setting by creating
<span class="lineNum">    1219 </span>            :     // an xlib surface once, recording its font_options, and then merging the
<span class="lineNum">    1220 </span>            :     // gdk options.
<span class="lineNum">    1221 </span>            :     //
<span class="lineNum">    1222 </span>            :     // Using an xlib surface would also be an option to get Screen font
<span class="lineNum">    1223 </span>            :     // options for non-GTK X11 toolkits, but less efficient than using GDK to
<span class="lineNum">    1224 </span>            :     // pick up dynamic changes.
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :     if(aIsPrinterFont) {</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :        cairo_font_options_t *options = cairo_font_options_create();</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :        cairo_font_options_set_hint_style (options, CAIRO_HINT_STYLE_NONE);</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :        cairo_font_options_set_antialias (options, CAIRO_ANTIALIAS_GRAY);</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :        cairo_ft_font_options_substitute(options, aPattern);</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :        cairo_font_options_destroy(options);</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :        FcPatternAddBool(aPattern, PRINTING_FC_PROPERTY, FcTrue);</span>
<span class="lineNum">    1232 </span>            :     } else {
<span class="lineNum">    1233 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :        ApplyGdkScreenFontOptions(aPattern);</span>
<span class="lineNum">    1235 </span>            : #endif
<span class="lineNum">    1236 </span>            :     }
<span class="lineNum">    1237 </span>            : 
<span class="lineNum">    1238 </span>            :     // Protect against any fontconfig settings that may have incorrectly
<span class="lineNum">    1239 </span>            :     // modified the pixelsize, and consider aSizeAdjustFactor.
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :     double size = aFallbackSize;</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :     if (FcPatternGetDouble(aPattern, FC_PIXEL_SIZE, 0, &amp;size) != FcResultMatch</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :         || aSizeAdjustFactor != 1.0) {</span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :         FcPatternDel(aPattern, FC_PIXEL_SIZE);</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :         FcPatternAddDouble(aPattern, FC_PIXEL_SIZE, size * aSizeAdjustFactor);</span>
<span class="lineNum">    1245 </span>            :     }
<span class="lineNum">    1246 </span>            : 
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :     FcDefaultSubstitute(aPattern);</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1249 </span>            : 
<span class="lineNum">    1250 </span>            : /**
<span class="lineNum">    1251 </span>            :  ** gfxPangoFontGroup
<a name="1252"><span class="lineNum">    1252 </span>            :  **/</a>
<span class="lineNum">    1253 </span>            : 
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::gfxPangoFontGroup(const FontFamilyList&amp; aFontFamilyList,</span>
<span class="lineNum">    1255 </span>            :                                      const gfxFontStyle *aStyle,
<span class="lineNum">    1256 </span>            :                                      gfxUserFontSet *aUserFontSet,
<span class="lineNum">    1257 </span>            :                                      gfxFloat aDevToCssSize)
<span class="lineNum">    1258 </span>            :     : gfxFontGroup(aFontFamilyList, aStyle, nullptr, aUserFontSet, aDevToCssSize),
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :       mPangoLanguage(GuessPangoLanguage(aStyle-&gt;language))</span>
<span class="lineNum">    1260 </span>            : {
<span class="lineNum">    1261 </span>            :     // This language is passed to the font for shaping.
<span class="lineNum">    1262 </span>            :     // Shaping doesn't know about lang groups so make it a real language.
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :     if (mPangoLanguage) {</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :         mStyle.language = NS_Atomize(pango_language_to_string(mPangoLanguage));</span>
<span class="lineNum">    1265 </span>            :     }
<span class="lineNum">    1266 </span>            : 
<span class="lineNum">    1267 </span>            :     // dummy entry, will be replaced when actually needed
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :     mFonts.AppendElement(FamilyFace());</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :     mSkipUpdateUserFonts = true;</span>
<a name="1270"><span class="lineNum">    1270 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1271 </span>            : 
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::~gfxPangoFontGroup()</span>
<span class="lineNum">    1273 </span>            : {
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 : }</span>
<a name="1275"><span class="lineNum">    1275 </span>            : </a>
<span class="lineNum">    1276 </span>            : gfxFontGroup *
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::Copy(const gfxFontStyle *aStyle)</span>
<span class="lineNum">    1278 </span>            : {
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :     return new gfxPangoFontGroup(mFamilyList, aStyle, mUserFontSet, mDevToCssSize);</span>
<span class="lineNum">    1280 </span>            : }
<a name="1281"><span class="lineNum">    1281 </span>            : </a>
<span class="lineNum">    1282 </span>            : void
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::FindGenericFontsPFG(FontFamilyType aGenericType,</span>
<span class="lineNum">    1284 </span>            :                                        nsIAtom *aLanguage,
<span class="lineNum">    1285 </span>            :                                        void *aClosure)
<span class="lineNum">    1286 </span>            : {
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :     AutoTArray&lt;nsString, 5&gt; resolvedGenerics;</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :     ResolveGenericFontNamesPFG(aGenericType, aLanguage, resolvedGenerics);</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :     uint32_t g = 0, numGenerics = resolvedGenerics.Length();</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :     for (g = 0; g &lt; numGenerics; g++) {</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :         FindPlatformFontPFG(resolvedGenerics[g], false, aClosure);</span>
<span class="lineNum">    1292 </span>            :     }
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 : }</span>
<a name="1294"><span class="lineNum">    1294 </span>            : </a>
<span class="lineNum">    1295 </span>            : /* static */ void
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::ResolveGenericFontNamesPFG(FontFamilyType aGenericType,</span>
<span class="lineNum">    1297 </span>            :                                               nsIAtom *aLanguage,
<span class="lineNum">    1298 </span>            :                                               nsTArray&lt;nsString&gt;&amp; aGenericFamilies)
<span class="lineNum">    1299 </span>            : {
<span class="lineNum">    1300 </span>            :     static const char kGeneric_serif[] = &quot;serif&quot;;
<span class="lineNum">    1301 </span>            :     static const char kGeneric_sans_serif[] = &quot;sans-serif&quot;;
<span class="lineNum">    1302 </span>            :     static const char kGeneric_monospace[] = &quot;monospace&quot;;
<span class="lineNum">    1303 </span>            :     static const char kGeneric_cursive[] = &quot;cursive&quot;;
<span class="lineNum">    1304 </span>            :     static const char kGeneric_fantasy[] = &quot;fantasy&quot;;
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span>            :     // treat -moz-fixed as monospace
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :     if (aGenericType == eFamily_moz_fixed) {</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :         aGenericType = eFamily_monospace;</span>
<span class="lineNum">    1309 </span>            :     }
<span class="lineNum">    1310 </span>            : 
<span class="lineNum">    1311 </span>            :     // type should be standard generic type at this point
<span class="lineNum">    1312 </span>            :     NS_ASSERTION(aGenericType &gt;= eFamily_serif &amp;&amp;
<span class="lineNum">    1313 </span>            :                  aGenericType &lt;= eFamily_fantasy,
<span class="lineNum">    1314 </span>            :                  &quot;standard generic font family type required&quot;);
<span class="lineNum">    1315 </span>            : 
<span class="lineNum">    1316 </span>            :     // create the lang string
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :     nsIAtom *langGroupAtom = nullptr;</span>
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :     nsAutoCString langGroupString;</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :     if (aLanguage) {</span>
<span class="lineNum">    1320 </span><span class="lineNoCov">          0 :         if (!gLangService) {</span>
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :             CallGetService(NS_LANGUAGEATOMSERVICE_CONTRACTID, &amp;gLangService);</span>
<span class="lineNum">    1322 </span>            :         }
<span class="lineNum">    1323 </span><span class="lineNoCov">          0 :         if (gLangService) {</span>
<span class="lineNum">    1324 </span>            :             nsresult rv;
<span class="lineNum">    1325 </span><span class="lineNoCov">          0 :             langGroupAtom = gLangService-&gt;GetLanguageGroup(aLanguage, &amp;rv);</span>
<span class="lineNum">    1326 </span>            :         }
<span class="lineNum">    1327 </span>            :     }
<span class="lineNum">    1328 </span><span class="lineNoCov">          0 :     if (!langGroupAtom) {</span>
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :         langGroupAtom = nsGkAtoms::Unicode;</span>
<span class="lineNum">    1330 </span>            :     }
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :     langGroupAtom-&gt;ToUTF8String(langGroupString);</span>
<span class="lineNum">    1332 </span>            : 
<span class="lineNum">    1333 </span>            :     // map generic type to string
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :     const char *generic = nullptr;</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :     switch (aGenericType) {</span>
<span class="lineNum">    1336 </span>            :         case eFamily_serif:
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :             generic = kGeneric_serif;</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1339 </span>            :         case eFamily_sans_serif:
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :             generic = kGeneric_sans_serif;</span>
<span class="lineNum">    1341 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1342 </span>            :         case eFamily_monospace:
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :             generic = kGeneric_monospace;</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1345 </span>            :         case eFamily_cursive:
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :             generic = kGeneric_cursive;</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1348 </span>            :         case eFamily_fantasy:
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :             generic = kGeneric_fantasy;</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1351 </span>            :         default:
<span class="lineNum">    1352 </span>            :             break;
<span class="lineNum">    1353 </span>            :     }
<span class="lineNum">    1354 </span>            : 
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :     if (!generic) {</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1357 </span>            :     }
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :     aGenericFamilies.Clear();</span>
<span class="lineNum">    1360 </span>            : 
<span class="lineNum">    1361 </span>            :     // load family for &quot;font.name.generic.lang&quot;
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :     nsAutoCString prefFontName(&quot;font.name.&quot;);</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :     prefFontName.Append(generic);</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :     prefFontName.Append('.');</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :     prefFontName.Append(langGroupString);</span>
<span class="lineNum">    1366 </span>            :     gfxFontUtils::AppendPrefsFontList(prefFontName.get(),
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :                                       aGenericFamilies);</span>
<span class="lineNum">    1368 </span>            : 
<span class="lineNum">    1369 </span>            :     // if lang has pref fonts, also load fonts for &quot;font.name-list.generic.lang&quot;
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :     if (!aGenericFamilies.IsEmpty()) {</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :         nsAutoCString prefFontListName(&quot;font.name-list.&quot;);</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :         prefFontListName.Append(generic);</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :         prefFontListName.Append('.');</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :         prefFontListName.Append(langGroupString);</span>
<span class="lineNum">    1375 </span>            :         gfxFontUtils::AppendPrefsFontList(prefFontListName.get(),
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                                           aGenericFamilies);</span>
<span class="lineNum">    1377 </span>            :     }
<span class="lineNum">    1378 </span>            : 
<span class="lineNum">    1379 </span>            : #if 0  // dump out generic mappings
<span class="lineNum">    1380 </span>            :     printf(&quot;%s ===&gt; &quot;, prefFontName.get());
<span class="lineNum">    1381 </span>            :     for (uint32_t k = 0; k &lt; aGenericFamilies.Length(); k++) {
<span class="lineNum">    1382 </span>            :         if (k &gt; 0) printf(&quot;, &quot;);
<span class="lineNum">    1383 </span>            :         printf(&quot;%s&quot;, NS_ConvertUTF16toUTF8(aGenericFamilies[k]).get());
<span class="lineNum">    1384 </span>            :     }
<span class="lineNum">    1385 </span>            :     printf(&quot;\n&quot;);
<span class="lineNum">    1386 </span>            : #endif
<a name="1387"><span class="lineNum">    1387 </span>            : }</a>
<span class="lineNum">    1388 </span>            : 
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 : void gfxPangoFontGroup::EnumerateFontListPFG(nsIAtom *aLanguage, void *aClosure)</span>
<span class="lineNum">    1390 </span>            : {
<span class="lineNum">    1391 </span>            :     // initialize fonts in the font family list
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :     const nsTArray&lt;FontFamilyName&gt;&amp; fontlist = mFamilyList.GetFontlist();</span>
<span class="lineNum">    1393 </span>            : 
<span class="lineNum">    1394 </span>            :     // lookup fonts in the fontlist
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :     uint32_t i, numFonts = fontlist.Length();</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :     for (i = 0; i &lt; numFonts; i++) {</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :         const FontFamilyName&amp; name = fontlist[i];</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :         if (name.IsNamed()) {</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :             FindPlatformFontPFG(name.mName, true, aClosure);</span>
<span class="lineNum">    1400 </span>            :         } else {
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :             FindGenericFontsPFG(name.mType, aLanguage, aClosure);</span>
<span class="lineNum">    1402 </span>            :         }
<span class="lineNum">    1403 </span>            :     }
<span class="lineNum">    1404 </span>            : 
<span class="lineNum">    1405 </span>            :     // if necessary, append default generic onto the end
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :     if (mFamilyList.GetDefaultFontType() != eFamily_none &amp;&amp;</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :         !mFamilyList.HasDefaultGeneric()) {</span>
<span class="lineNum">    1408 </span>            :         FindGenericFontsPFG(mFamilyList.GetDefaultFontType(),
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :                             aLanguage, aClosure);</span>
<span class="lineNum">    1410 </span>            :     }
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 : }</span>
<a name="1412"><span class="lineNum">    1412 </span>            : </a>
<span class="lineNum">    1413 </span>            : void
<span class="lineNum">    1414 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::FindPlatformFontPFG(const nsAString&amp; fontName,</span>
<span class="lineNum">    1415 </span>            :                                        bool aUseFontSet,
<span class="lineNum">    1416 </span>            :                                        void *aClosure)
<span class="lineNum">    1417 </span>            : {
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :     nsTArray&lt;nsString&gt; *list = static_cast&lt;nsTArray&lt;nsString&gt;*&gt;(aClosure);</span>
<span class="lineNum">    1419 </span>            : 
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :     if (!list-&gt;Contains(fontName)) {</span>
<span class="lineNum">    1421 </span>            :         // names present in the user fontset are not matched against system fonts
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :         if (aUseFontSet &amp;&amp; mUserFontSet &amp;&amp; mUserFontSet-&gt;HasFamily(fontName)) {</span>
<span class="lineNum">    1423 </span>            :             nsAutoString userFontName =
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :                 NS_LITERAL_STRING(FONT_FACE_FAMILY_PREFIX) + fontName;</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :             list-&gt;AppendElement(userFontName);</span>
<span class="lineNum">    1426 </span>            :         } else {
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :             list-&gt;AppendElement(fontName);</span>
<span class="lineNum">    1428 </span>            :         }
<span class="lineNum">    1429 </span>            :     }
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 : }</span>
<a name="1431"><span class="lineNum">    1431 </span>            : </a>
<span class="lineNum">    1432 </span>            : gfxFcFont *
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::GetBaseFont()</span>
<span class="lineNum">    1434 </span>            : {
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :     if (mFonts[0].Font() == nullptr) {</span>
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :         gfxFont* font = GetBaseFontSet()-&gt;GetFontAt(0, GetStyle());</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :         mFonts[0] = FamilyFace(nullptr, font);</span>
<span class="lineNum">    1438 </span>            :     }
<span class="lineNum">    1439 </span>            : 
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :     return static_cast&lt;gfxFcFont*&gt;(mFonts[0].Font());</span>
<span class="lineNum">    1441 </span>            : }
<a name="1442"><span class="lineNum">    1442 </span>            : </a>
<span class="lineNum">    1443 </span>            : gfxFont*
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::GetFirstValidFont(uint32_t aCh)</span>
<span class="lineNum">    1445 </span>            : {
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :     return GetFontAt(0);</span>
<span class="lineNum">    1447 </span>            : }
<a name="1448"><span class="lineNum">    1448 </span>            : </a>
<span class="lineNum">    1449 </span>            : gfxFont *
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::GetFontAt(int32_t i, uint32_t aCh)</span>
<span class="lineNum">    1451 </span>            : {
<span class="lineNum">    1452 </span>            :     // If it turns out to be hard for all clients that cache font
<span class="lineNum">    1453 </span>            :     // groups to call UpdateUserFonts at appropriate times, we could
<span class="lineNum">    1454 </span>            :     // instead consider just calling UpdateUserFonts from someplace
<span class="lineNum">    1455 </span>            :     // more central (such as here).
<span class="lineNum">    1456 </span>            :     NS_ASSERTION(!mUserFontSet || mCurrGeneration == GetGeneration(),
<span class="lineNum">    1457 </span>            :                  &quot;Whoever was caching this font group should have &quot;
<span class="lineNum">    1458 </span>            :                  &quot;called UpdateUserFonts on it&quot;);
<span class="lineNum">    1459 </span>            : 
<span class="lineNum">    1460 </span>            :     NS_PRECONDITION(i == 0, &quot;Only have one font&quot;);
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :     return GetBaseFont();</span>
<span class="lineNum">    1463 </span>            : }
<a name="1464"><span class="lineNum">    1464 </span>            : </a>
<span class="lineNum">    1465 </span>            : void
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::UpdateUserFonts()</span>
<span class="lineNum">    1467 </span>            : {
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :     uint64_t newGeneration = GetGeneration();</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :     if (newGeneration == mCurrGeneration)</span>
<span class="lineNum">    1470 </span><span class="lineNoCov">          0 :         return;</span>
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :     mFonts[0] = FamilyFace();</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :     mFontSets.Clear();</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :     ClearCachedData();</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :     mCurrGeneration = newGeneration;</span>
<span class="lineNum">    1476 </span>            : }
<a name="1477"><span class="lineNum">    1477 </span>            : </a>
<span class="lineNum">    1478 </span>            : already_AddRefed&lt;gfxFcFontSet&gt;
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::MakeFontSet(PangoLanguage *aLang, gfxFloat aSizeAdjustFactor,</span>
<span class="lineNum">    1480 </span>            :                                nsAutoRef&lt;FcPattern&gt; *aMatchPattern)
<span class="lineNum">    1481 </span>            : {
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :     const char *lang = pango_language_to_string(aLang);</span>
<span class="lineNum">    1483 </span>            : 
<span class="lineNum">    1484 </span>            :     RefPtr&lt;nsIAtom&gt; langGroup;
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :     if (aLang != mPangoLanguage) {</span>
<span class="lineNum">    1486 </span>            :         // Set up langGroup for Mozilla's font prefs.
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :         langGroup = NS_Atomize(lang);</span>
<span class="lineNum">    1488 </span>            :     }
<span class="lineNum">    1489 </span>            : 
<span class="lineNum">    1490 </span><span class="lineNoCov">          0 :     AutoTArray&lt;nsString, 20&gt; fcFamilyList;</span>
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :     EnumerateFontListPFG(langGroup ? langGroup.get() : mStyle.language.get(),</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :                          &amp;fcFamilyList);</span>
<span class="lineNum">    1493 </span>            : 
<span class="lineNum">    1494 </span>            :     // To consider: A fontset cache here could be helpful.
<span class="lineNum">    1495 </span>            : 
<span class="lineNum">    1496 </span>            :     // Get a pattern suitable for matching.
<span class="lineNum">    1497 </span>            :     nsAutoRef&lt;FcPattern&gt; pattern
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :         (gfxFontconfigUtils::NewPattern(fcFamilyList, mStyle, lang));</span>
<span class="lineNum">    1499 </span>            : 
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :     PrepareSortPattern(pattern, mStyle.size, aSizeAdjustFactor, mStyle.printerFont);</span>
<span class="lineNum">    1501 </span>            : 
<span class="lineNum">    1502 </span>            :     RefPtr&lt;gfxFcFontSet&gt; fontset =
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :         new gfxFcFontSet(pattern, mUserFontSet);</span>
<span class="lineNum">    1504 </span>            : 
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :     mSkipDrawing = fontset-&gt;WaitingForUserFont();</span>
<span class="lineNum">    1506 </span>            : 
<span class="lineNum">    1507 </span><span class="lineNoCov">          0 :     if (aMatchPattern)</span>
<span class="lineNum">    1508 </span>            :         aMatchPattern-&gt;steal(pattern);
<span class="lineNum">    1509 </span>            : 
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :     return fontset.forget();</span>
<a name="1511"><span class="lineNum">    1511 </span>            : }</a>
<span class="lineNum">    1512 </span>            : 
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::</span>
<span class="lineNum">    1514 </span>            : FontSetByLangEntry::FontSetByLangEntry(PangoLanguage *aLang,
<span class="lineNum">    1515 </span>            :                                        gfxFcFontSet *aFontSet)
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :     : mLang(aLang), mFontSet(aFontSet)</span>
<span class="lineNum">    1517 </span>            : {
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 : }</span>
<a name="1519"><span class="lineNum">    1519 </span>            : </a>
<span class="lineNum">    1520 </span>            : gfxFcFontSet *
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::GetFontSet(PangoLanguage *aLang)</span>
<span class="lineNum">    1522 </span>            : {
<span class="lineNum">    1523 </span><span class="lineNoCov">          0 :     GetBaseFontSet(); // sets mSizeAdjustFactor and mFontSets[0]</span>
<span class="lineNum">    1524 </span>            : 
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :     if (!aLang)</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :         return mFontSets[0].mFontSet;</span>
<span class="lineNum">    1527 </span>            : 
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :     for (uint32_t i = 0; i &lt; mFontSets.Length(); ++i) {</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :         if (mFontSets[i].mLang == aLang)</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :             return mFontSets[i].mFontSet;</span>
<span class="lineNum">    1531 </span>            :     }
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span>            :     RefPtr&lt;gfxFcFontSet&gt; fontSet =
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :         MakeFontSet(aLang, mSizeAdjustFactor);</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :     mFontSets.AppendElement(FontSetByLangEntry(aLang, fontSet));</span>
<span class="lineNum">    1536 </span>            : 
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :     return fontSet;</span>
<span class="lineNum">    1538 </span>            : }
<a name="1539"><span class="lineNum">    1539 </span>            : </a>
<span class="lineNum">    1540 </span>            : already_AddRefed&lt;gfxFont&gt;
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::FindFontForChar(uint32_t aCh, uint32_t aPrevCh,</span>
<span class="lineNum">    1542 </span>            :                                    uint32_t aNextCh, Script aRunScript,
<span class="lineNum">    1543 </span>            :                                    gfxFont *aPrevMatchedFont,
<span class="lineNum">    1544 </span>            :                                    uint8_t *aMatchType)
<span class="lineNum">    1545 </span>            : {
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :     if (aPrevMatchedFont) {</span>
<span class="lineNum">    1547 </span>            :         // Don't switch fonts for control characters, regardless of
<span class="lineNum">    1548 </span>            :         // whether they are present in the current font, as they won't
<span class="lineNum">    1549 </span>            :         // actually be rendered (see bug 716229)
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :         uint8_t category = GetGeneralCategory(aCh);</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :         if (category == HB_UNICODE_GENERAL_CATEGORY_CONTROL) {</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :             return RefPtr&lt;gfxFont&gt;(aPrevMatchedFont).forget();</span>
<span class="lineNum">    1553 </span>            :         }
<span class="lineNum">    1554 </span>            : 
<span class="lineNum">    1555 </span>            :         // if this character is a join-control or the previous is a join-causer,
<span class="lineNum">    1556 </span>            :         // use the same font as the previous range if we can
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :         if (gfxFontUtils::IsJoinControl(aCh) ||</span>
<span class="lineNum">    1558 </span>            :             gfxFontUtils::IsJoinCauser(aPrevCh)) {
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :             if (aPrevMatchedFont-&gt;HasCharacter(aCh)) {</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :                 return RefPtr&lt;gfxFont&gt;(aPrevMatchedFont).forget();</span>
<span class="lineNum">    1561 </span>            :             }
<span class="lineNum">    1562 </span>            :         }
<span class="lineNum">    1563 </span>            :     }
<span class="lineNum">    1564 </span>            : 
<span class="lineNum">    1565 </span>            :     // if this character is a variation selector,
<span class="lineNum">    1566 </span>            :     // use the previous font regardless of whether it supports VS or not.
<span class="lineNum">    1567 </span>            :     // otherwise the text run will be divided.
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :     if (gfxFontUtils::IsVarSelector(aCh)) {</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :         if (aPrevMatchedFont) {</span>
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :             return RefPtr&lt;gfxFont&gt;(aPrevMatchedFont).forget();</span>
<span class="lineNum">    1571 </span>            :         }
<span class="lineNum">    1572 </span>            :         // VS alone. it's meaningless to search different fonts
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :         return nullptr;</span>
<span class="lineNum">    1574 </span>            :     }
<span class="lineNum">    1575 </span>            : 
<span class="lineNum">    1576 </span>            :     // The real fonts that fontconfig provides for generic/fallback families
<span class="lineNum">    1577 </span>            :     // depend on the language used, so a different FontSet is used for each
<span class="lineNum">    1578 </span>            :     // language (except for the variation below).
<span class="lineNum">    1579 </span>            :     //
<span class="lineNum">    1580 </span>            :     //   With most fontconfig configurations any real family names prior to a
<span class="lineNum">    1581 </span>            :     //   fontconfig generic with corresponding fonts installed will still lead
<span class="lineNum">    1582 </span>            :     //   to the same leading fonts in each FontSet.
<span class="lineNum">    1583 </span>            :     //
<span class="lineNum">    1584 </span>            :     //   There is an inefficiency here therefore because the same base FontSet
<span class="lineNum">    1585 </span>            :     //   could often be used if these real families support the character.
<span class="lineNum">    1586 </span>            :     //   However, with fontconfig aliases, it is difficult to distinguish
<span class="lineNum">    1587 </span>            :     //   where exactly alias fonts end and generic/fallback fonts begin.
<span class="lineNum">    1588 </span>            :     //
<span class="lineNum">    1589 </span>            :     // The variation from pure language-based matching used here is that the
<span class="lineNum">    1590 </span>            :     // same primary/base font is always used irrespective of the language.
<span class="lineNum">    1591 </span>            :     // This provides that SCRIPT_COMMON characters are consistently rendered
<span class="lineNum">    1592 </span>            :     // with the same font (bug 339513 and bug 416725).  This is particularly
<span class="lineNum">    1593 </span>            :     // important with the word cache as script can't be reliably determined
<span class="lineNum">    1594 </span>            :     // from surrounding words.  It also often avoids the unnecessary extra
<span class="lineNum">    1595 </span>            :     // FontSet efficiency mentioned above.
<span class="lineNum">    1596 </span>            :     //
<span class="lineNum">    1597 </span>            :     // However, in two situations, the base font is not checked before the
<span class="lineNum">    1598 </span>            :     // language-specific FontSet.
<span class="lineNum">    1599 </span>            :     //
<span class="lineNum">    1600 </span>            :     //   1. When we don't have a language to make a good choice for
<span class="lineNum">    1601 </span>            :     //      the base font.
<span class="lineNum">    1602 </span>            :     //
<span class="lineNum">    1603 </span>            :     //   2. For system fonts, use the default Pango behavior to give
<span class="lineNum">    1604 </span>            :     //      consistency with other apps.  This is relevant when un-localized
<span class="lineNum">    1605 </span>            :     //      builds are run in non-Latin locales.  This special-case probably
<span class="lineNum">    1606 </span>            :     //      wouldn't be necessary but for bug 91190.
<span class="lineNum">    1607 </span>            : 
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :     gfxFcFontSet *fontSet = GetBaseFontSet();</span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :     uint32_t nextFont = 0;</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :     FcPattern *basePattern = nullptr;</span>
<span class="lineNum">    1611 </span><span class="lineNoCov">          0 :     if (!mStyle.systemFont &amp;&amp; mPangoLanguage) {</span>
<span class="lineNum">    1612 </span><span class="lineNoCov">          0 :         basePattern = fontSet-&gt;GetFontPatternAt(0);</span>
<span class="lineNum">    1613 </span><span class="lineNoCov">          0 :         if (HasChar(basePattern, aCh)) {</span>
<span class="lineNum">    1614 </span><span class="lineNoCov">          0 :             *aMatchType = gfxTextRange::kFontGroup;</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :             return RefPtr&lt;gfxFont&gt;(GetBaseFont()).forget();</span>
<span class="lineNum">    1616 </span>            :         }
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span>            :         nextFont = 1;
<span class="lineNum">    1619 </span>            :     }
<span class="lineNum">    1620 </span>            : 
<span class="lineNum">    1621 </span>            :     // Our MOZ_SCRIPT_* codes may not match the PangoScript enumeration values
<span class="lineNum">    1622 </span>            :     // (if we're using ICU's codes), so convert by mapping through ISO 15924 tag.
<span class="lineNum">    1623 </span>            :     // Note that PangoScript is defined to be compatible with GUnicodeScript:
<span class="lineNum">    1624 </span>            :     // https://developer.gnome.org/pango/stable/pango-Scripts-and-Languages.html#PangoScript
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :     const hb_tag_t scriptTag = GetScriptTagForCode(aRunScript);</span>
<span class="lineNum">    1626 </span>            :     const PangoScript script =
<span class="lineNum">    1627 </span><span class="lineNoCov">          0 :       (const PangoScript)hb_glib_script_from_script(hb_script_from_iso15924_tag(scriptTag));</span>
<span class="lineNum">    1628 </span>            : 
<span class="lineNum">    1629 </span>            :     // Might be nice to call pango_language_includes_script only once for the
<span class="lineNum">    1630 </span>            :     // run rather than for each character.
<span class="lineNum">    1631 </span>            :     PangoLanguage *scriptLang;
<span class="lineNum">    1632 </span><span class="lineNoCov">          0 :     if ((!basePattern ||</span>
<span class="lineNum">    1633 </span><span class="lineNoCov">          0 :          !pango_language_includes_script(mPangoLanguage, script)) &amp;&amp;</span>
<span class="lineNum">    1634 </span>            :         (scriptLang = pango_script_get_sample_language(script))) {
<span class="lineNum">    1635 </span><span class="lineNoCov">          0 :         fontSet = GetFontSet(scriptLang);</span>
<span class="lineNum">    1636 </span><span class="lineNoCov">          0 :         nextFont = 0;</span>
<span class="lineNum">    1637 </span>            :     }
<span class="lineNum">    1638 </span>            : 
<span class="lineNum">    1639 </span><span class="lineNoCov">          0 :     for (uint32_t i = nextFont;</span>
<span class="lineNum">    1640 </span><span class="lineNoCov">          0 :          FcPattern *pattern = fontSet-&gt;GetFontPatternAt(i);</span>
<span class="lineNum">    1641 </span>            :          ++i) {
<span class="lineNum">    1642 </span><span class="lineNoCov">          0 :         if (pattern == basePattern) {</span>
<span class="lineNum">    1643 </span>            :             continue; // already checked basePattern
<span class="lineNum">    1644 </span>            :         }
<span class="lineNum">    1645 </span>            : 
<span class="lineNum">    1646 </span><span class="lineNoCov">          0 :         if (HasChar(pattern, aCh)) {</span>
<span class="lineNum">    1647 </span><span class="lineNoCov">          0 :             *aMatchType = gfxTextRange::kFontGroup;</span>
<span class="lineNum">    1648 </span><span class="lineNoCov">          0 :             return RefPtr&lt;gfxFont&gt;(fontSet-&gt;GetFontAt(i, GetStyle())).forget();</span>
<span class="lineNum">    1649 </span>            :         }
<span class="lineNum">    1650 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1651 </span>            : 
<span class="lineNum">    1652 </span><span class="lineNoCov">          0 :     return nullptr;</span>
<span class="lineNum">    1653 </span>            : }
<span class="lineNum">    1654 </span>            : 
<span class="lineNum">    1655 </span>            : /**
<span class="lineNum">    1656 </span>            :  ** gfxFcFont
<span class="lineNum">    1657 </span>            :  **/
<span class="lineNum">    1658 </span>            : 
<a name="1659"><span class="lineNum">    1659 </span>            : cairo_user_data_key_t gfxFcFont::sGfxFontKey;</a>
<span class="lineNum">    1660 </span>            : 
<span class="lineNum">    1661 </span><span class="lineNoCov">          0 : gfxFcFont::gfxFcFont(cairo_scaled_font_t *aCairoFont,</span>
<span class="lineNum">    1662 </span>            :                      FcPattern *aPattern,
<span class="lineNum">    1663 </span>            :                      gfxFcFontEntry *aFontEntry,
<span class="lineNum">    1664 </span>            :                      const gfxFontStyle *aFontStyle)
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :     : gfxFontconfigFontBase(aCairoFont, aPattern, aFontEntry, aFontStyle)</span>
<span class="lineNum">    1666 </span>            : {
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :     cairo_scaled_font_set_user_data(mScaledFont, &amp;sGfxFontKey, this, nullptr);</span>
<a name="1668"><span class="lineNum">    1668 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1669 </span>            : 
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 : gfxFcFont::~gfxFcFont()</span>
<span class="lineNum">    1671 </span>            : {
<span class="lineNum">    1672 </span>            :     cairo_scaled_font_set_user_data(mScaledFont,
<span class="lineNum">    1673 </span>            :                                     &amp;sGfxFontKey,
<span class="lineNum">    1674 </span>            :                                     nullptr,
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :                                     nullptr);</span>
<span class="lineNum">    1676 </span><span class="lineNoCov">          0 : }</span>
<a name="1677"><span class="lineNum">    1677 </span>            : </a>
<span class="lineNum">    1678 </span>            : already_AddRefed&lt;gfxFont&gt;
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 : gfxFcFont::GetSubSuperscriptFont(int32_t aAppUnitsPerDevPixel)</span>
<span class="lineNum">    1680 </span>            : {
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :     gfxFontStyle style(*GetStyle());</span>
<span class="lineNum">    1682 </span><span class="lineNoCov">          0 :     style.AdjustForSubSuperscript(aAppUnitsPerDevPixel);</span>
<span class="lineNum">    1683 </span><span class="lineNoCov">          0 :     return MakeScaledFont(&amp;style, style.size / GetStyle()-&gt;size);</span>
<span class="lineNum">    1684 </span>            : }
<a name="1685"><span class="lineNum">    1685 </span>            : </a>
<span class="lineNum">    1686 </span>            : already_AddRefed&lt;gfxFont&gt;
<span class="lineNum">    1687 </span><span class="lineNoCov">          0 : gfxFcFont::MakeScaledFont(gfxFontStyle *aFontStyle, gfxFloat aScaleFactor)</span>
<span class="lineNum">    1688 </span>            : {
<span class="lineNum">    1689 </span><span class="lineNoCov">          0 :     gfxFcFontEntry* fe = static_cast&lt;gfxFcFontEntry*&gt;(GetFontEntry());</span>
<span class="lineNum">    1690 </span>            :     RefPtr&lt;gfxFont&gt; font =
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :         gfxFontCache::GetCache()-&gt;Lookup(fe, aFontStyle, nullptr);</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :     if (font) {</span>
<span class="lineNum">    1693 </span>            :         return font.forget();
<span class="lineNum">    1694 </span>            :     }
<span class="lineNum">    1695 </span>            : 
<span class="lineNum">    1696 </span>            :     cairo_matrix_t fontMatrix;
<span class="lineNum">    1697 </span><span class="lineNoCov">          0 :     cairo_scaled_font_get_font_matrix(mScaledFont, &amp;fontMatrix);</span>
<span class="lineNum">    1698 </span><span class="lineNoCov">          0 :     cairo_matrix_scale(&amp;fontMatrix, aScaleFactor, aScaleFactor);</span>
<span class="lineNum">    1699 </span>            : 
<span class="lineNum">    1700 </span>            :     cairo_matrix_t ctm;
<span class="lineNum">    1701 </span><span class="lineNoCov">          0 :     cairo_scaled_font_get_ctm(mScaledFont, &amp;ctm);</span>
<span class="lineNum">    1702 </span>            : 
<span class="lineNum">    1703 </span><span class="lineNoCov">          0 :     cairo_font_options_t *options = cairo_font_options_create();</span>
<span class="lineNum">    1704 </span><span class="lineNoCov">          0 :     cairo_scaled_font_get_font_options(mScaledFont, options);</span>
<span class="lineNum">    1705 </span>            : 
<span class="lineNum">    1706 </span>            :     cairo_scaled_font_t *newFont =
<span class="lineNum">    1707 </span>            :         cairo_scaled_font_create(cairo_scaled_font_get_font_face(mScaledFont),
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :                                  &amp;fontMatrix, &amp;ctm, options);</span>
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :     cairo_font_options_destroy(options);</span>
<span class="lineNum">    1710 </span>            : 
<span class="lineNum">    1711 </span><span class="lineNoCov">          0 :     font = new gfxFcFont(newFont, GetPattern(), fe, aFontStyle);</span>
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :     gfxFontCache::GetCache()-&gt;AddNew(font);</span>
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :     cairo_scaled_font_destroy(newFont);</span>
<span class="lineNum">    1714 </span>            : 
<span class="lineNum">    1715 </span><span class="lineNoCov">          0 :     return font.forget();</span>
<span class="lineNum">    1716 </span>            : }
<a name="1717"><span class="lineNum">    1717 </span>            : </a>
<span class="lineNum">    1718 </span>            : already_AddRefed&lt;gfxFont&gt;
<span class="lineNum">    1719 </span><span class="lineNoCov">          0 : gfxFcFont::GetSmallCapsFont()</span>
<span class="lineNum">    1720 </span>            : {
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :     gfxFontStyle style(*GetStyle());</span>
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :     style.size *= SMALL_CAPS_SCALE_FACTOR;</span>
<span class="lineNum">    1723 </span><span class="lineNoCov">          0 :     style.variantCaps = NS_FONT_VARIANT_CAPS_NORMAL;</span>
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :     return MakeScaledFont(&amp;style, SMALL_CAPS_SCALE_FACTOR);</span>
<span class="lineNum">    1725 </span>            : }
<a name="1726"><span class="lineNum">    1726 </span>            : </a>
<span class="lineNum">    1727 </span>            : /* static */ void
<span class="lineNum">    1728 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::Shutdown()</span>
<span class="lineNum">    1729 </span>            : {
<span class="lineNum">    1730 </span>            :     // Resetting gFTLibrary in case this is wanted again after a
<span class="lineNum">    1731 </span>            :     // cairo_debug_reset_static_data.
<span class="lineNum">    1732 </span><span class="lineNoCov">          0 :     gFTLibrary = nullptr;</span>
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 : }</span>
<a name="1734"><span class="lineNum">    1734 </span>            : </a>
<span class="lineNum">    1735 </span>            : /* static */ gfxFontEntry *
<span class="lineNum">    1736 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::NewFontEntry(const nsAString&amp; aFontName,</span>
<span class="lineNum">    1737 </span>            :                                 uint16_t aWeight,
<span class="lineNum">    1738 </span>            :                                 int16_t aStretch,
<span class="lineNum">    1739 </span>            :                                 uint8_t aStyle)
<span class="lineNum">    1740 </span>            : {
<span class="lineNum">    1741 </span><span class="lineNoCov">          0 :     gfxFontconfigUtils *utils = gfxFontconfigUtils::GetFontconfigUtils();</span>
<span class="lineNum">    1742 </span><span class="lineNoCov">          0 :     if (!utils)</span>
<span class="lineNum">    1743 </span>            :         return nullptr;
<span class="lineNum">    1744 </span>            : 
<span class="lineNum">    1745 </span>            :     // The font face name from @font-face { src: local() } is not well
<span class="lineNum">    1746 </span>            :     // defined.
<span class="lineNum">    1747 </span>            :     //
<span class="lineNum">    1748 </span>            :     // On MS Windows, this name gets compared with
<span class="lineNum">    1749 </span>            :     // ENUMLOGFONTEXW::elfFullName, which for OpenType fonts seems to be the
<span class="lineNum">    1750 </span>            :     // full font name from the name table.  For CFF OpenType fonts this is the
<span class="lineNum">    1751 </span>            :     // same as the PostScript name, but for TrueType fonts it is usually
<span class="lineNum">    1752 </span>            :     // different.
<span class="lineNum">    1753 </span>            :     //
<span class="lineNum">    1754 </span>            :     // On Mac, the font face name is compared with the PostScript name, even
<span class="lineNum">    1755 </span>            :     // for TrueType fonts.
<span class="lineNum">    1756 </span>            :     //
<span class="lineNum">    1757 </span>            :     // Fontconfig only records the full font names, so the behavior here
<span class="lineNum">    1758 </span>            :     // follows that on MS Windows.  However, to provide the possibility
<span class="lineNum">    1759 </span>            :     // of aliases to compensate for variations, the font face name is passed
<span class="lineNum">    1760 </span>            :     // through FcConfigSubstitute.
<span class="lineNum">    1761 </span>            : 
<span class="lineNum">    1762 </span><span class="lineNoCov">          0 :     nsAutoRef&lt;FcPattern&gt; pattern(FcPatternCreate());</span>
<span class="lineNum">    1763 </span><span class="lineNoCov">          0 :     if (!pattern)</span>
<span class="lineNum">    1764 </span>            :         return nullptr;
<span class="lineNum">    1765 </span>            : 
<span class="lineNum">    1766 </span><span class="lineNoCov">          0 :     NS_ConvertUTF16toUTF8 fullname(aFontName);</span>
<span class="lineNum">    1767 </span>            :     FcPatternAddString(pattern, FC_FULLNAME,
<span class="lineNum">    1768 </span><span class="lineNoCov">          0 :                        gfxFontconfigUtils::ToFcChar8(fullname));</span>
<span class="lineNum">    1769 </span><span class="lineNoCov">          0 :     FcConfigSubstitute(nullptr, pattern, FcMatchPattern);</span>
<span class="lineNum">    1770 </span>            : 
<span class="lineNum">    1771 </span>            :     FcChar8 *name;
<span class="lineNum">    1772 </span><span class="lineNoCov">          0 :     for (int v = 0;</span>
<span class="lineNum">    1773 </span><span class="lineNoCov">          0 :          FcPatternGetString(pattern, FC_FULLNAME, v, &amp;name) == FcResultMatch;</span>
<span class="lineNum">    1774 </span>            :          ++v) {
<span class="lineNum">    1775 </span>            :         const nsTArray&lt; nsCountedRef&lt;FcPattern&gt; &gt;&amp; fonts =
<span class="lineNum">    1776 </span><span class="lineNoCov">          0 :             utils-&gt;GetFontsForFullname(name);</span>
<span class="lineNum">    1777 </span>            : 
<span class="lineNum">    1778 </span><span class="lineNoCov">          0 :         if (fonts.Length() != 0)</span>
<span class="lineNum">    1779 </span>            :             return new gfxLocalFcFontEntry(aFontName,
<span class="lineNum">    1780 </span>            :                                            aWeight,
<span class="lineNum">    1781 </span>            :                                            aStretch,
<span class="lineNum">    1782 </span>            :                                            aStyle,
<span class="lineNum">    1783 </span><span class="lineNoCov">          0 :                                            fonts);</span>
<span class="lineNum">    1784 </span>            :     }
<span class="lineNum">    1785 </span>            : 
<span class="lineNum">    1786 </span>            :     return nullptr;
<span class="lineNum">    1787 </span>            : }
<a name="1788"><span class="lineNum">    1788 </span>            : </a>
<span class="lineNum">    1789 </span>            : /* static */ FT_Library
<span class="lineNum">    1790 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::GetFTLibrary()</span>
<span class="lineNum">    1791 </span>            : {
<span class="lineNum">    1792 </span><span class="lineNoCov">          0 :     if (!gFTLibrary) {</span>
<span class="lineNum">    1793 </span>            :         // Use cairo's FT_Library so that cairo takes care of shutdown of the
<span class="lineNum">    1794 </span>            :         // FT_Library after it has destroyed its font_faces, and FT_Done_Face
<span class="lineNum">    1795 </span>            :         // has been called on each FT_Face, at least until this bug is fixed:
<span class="lineNum">    1796 </span>            :         // https://bugs.freedesktop.org/show_bug.cgi?id=18857
<span class="lineNum">    1797 </span>            :         //
<span class="lineNum">    1798 </span>            :         // Cairo's FT_Library can be obtained from any cairo_scaled_font.  The
<span class="lineNum">    1799 </span>            :         // font properties requested here are chosen to get an FT_Face that is
<span class="lineNum">    1800 </span>            :         // likely to be also used elsewhere.
<span class="lineNum">    1801 </span><span class="lineNoCov">          0 :         gfxFontStyle style;</span>
<span class="lineNum">    1802 </span>            :         RefPtr&lt;gfxPangoFontGroup&gt; fontGroup =
<span class="lineNum">    1803 </span>            :             new gfxPangoFontGroup(FontFamilyList(eFamily_sans_serif),
<span class="lineNum">    1804 </span><span class="lineNoCov">          0 :                                   &amp;style, nullptr, 1.0);</span>
<span class="lineNum">    1805 </span>            : 
<span class="lineNum">    1806 </span><span class="lineNoCov">          0 :         gfxFcFont *font = fontGroup-&gt;GetBaseFont();</span>
<span class="lineNum">    1807 </span><span class="lineNoCov">          0 :         if (!font)</span>
<span class="lineNum">    1808 </span><span class="lineNoCov">          0 :             return nullptr;</span>
<span class="lineNum">    1809 </span>            : 
<span class="lineNum">    1810 </span><span class="lineNoCov">          0 :         gfxFT2LockedFace face(font);</span>
<span class="lineNum">    1811 </span><span class="lineNoCov">          0 :         if (!face.get())</span>
<span class="lineNum">    1812 </span><span class="lineNoCov">          0 :             return nullptr;</span>
<span class="lineNum">    1813 </span>            : 
<span class="lineNum">    1814 </span><span class="lineNoCov">          0 :         gFTLibrary = face.get()-&gt;glyph-&gt;library;</span>
<span class="lineNum">    1815 </span>            :     }
<span class="lineNum">    1816 </span>            : 
<span class="lineNum">    1817 </span><span class="lineNoCov">          0 :     return gFTLibrary;</span>
<span class="lineNum">    1818 </span>            : }
<a name="1819"><span class="lineNum">    1819 </span>            : </a>
<span class="lineNum">    1820 </span>            : /* static */ gfxFontEntry *
<span class="lineNum">    1821 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::NewFontEntry(const nsAString&amp; aFontName,</span>
<span class="lineNum">    1822 </span>            :                                 uint16_t aWeight,
<span class="lineNum">    1823 </span>            :                                 int16_t aStretch,
<span class="lineNum">    1824 </span>            :                                 uint8_t aStyle,
<span class="lineNum">    1825 </span>            :                                 const uint8_t* aFontData,
<span class="lineNum">    1826 </span>            :                                 uint32_t aLength)
<span class="lineNum">    1827 </span>            : {
<span class="lineNum">    1828 </span>            :     // Ownership of aFontData is passed in here, and transferred to the
<span class="lineNum">    1829 </span>            :     // new fontEntry, which will release it when no longer needed.
<span class="lineNum">    1830 </span>            : 
<span class="lineNum">    1831 </span>            :     // Using face_index = 0 for the first face in the font, as we have no
<span class="lineNum">    1832 </span>            :     // other information.  FT_New_Memory_Face checks for a nullptr FT_Library.
<span class="lineNum">    1833 </span>            :     FT_Face face;
<span class="lineNum">    1834 </span>            :     FT_Error error =
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :         FT_New_Memory_Face(GetFTLibrary(), aFontData, aLength, 0, &amp;face);</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :     if (error != 0) {</span>
<span class="lineNum">    1837 </span><span class="lineNoCov">          0 :         free((void*)aFontData);</span>
<span class="lineNum">    1838 </span><span class="lineNoCov">          0 :         return nullptr;</span>
<span class="lineNum">    1839 </span>            :     }
<span class="lineNum">    1840 </span>            : 
<span class="lineNum">    1841 </span>            :     return new gfxDownloadedFcFontEntry(aFontName, aWeight,
<span class="lineNum">    1842 </span>            :                                         aStretch, aStyle,
<span class="lineNum">    1843 </span><span class="lineNoCov">          0 :                                         aFontData, face);</span>
<span class="lineNum">    1844 </span>            : }
<span class="lineNum">    1845 </span>            : 
<a name="1846"><span class="lineNum">    1846 </span>            : </a>
<span class="lineNum">    1847 </span>            : static double
<span class="lineNum">    1848 </span><span class="lineNoCov">          0 : GetPixelSize(FcPattern *aPattern)</span>
<span class="lineNum">    1849 </span>            : {
<span class="lineNum">    1850 </span>            :     double size;
<span class="lineNum">    1851 </span><span class="lineNoCov">          0 :     if (FcPatternGetDouble(aPattern,</span>
<span class="lineNum">    1852 </span><span class="lineNoCov">          0 :                            FC_PIXEL_SIZE, 0, &amp;size) == FcResultMatch)</span>
<span class="lineNum">    1853 </span><span class="lineNoCov">          0 :         return size;</span>
<span class="lineNum">    1854 </span>            : 
<span class="lineNum">    1855 </span>            :     NS_NOTREACHED(&quot;No size on pattern&quot;);
<span class="lineNum">    1856 </span>            :     return 0.0;
<span class="lineNum">    1857 </span>            : }
<span class="lineNum">    1858 </span>            : 
<span class="lineNum">    1859 </span>            : /**
<span class="lineNum">    1860 </span>            :  * The following gfxFcFonts are accessed from the cairo_scaled_font or created
<span class="lineNum">    1861 </span>            :  * from the FcPattern, not from the gfxFontCache hash table.  The gfxFontCache
<span class="lineNum">    1862 </span>            :  * hash table is keyed by desired family and style, whereas here we only know
<span class="lineNum">    1863 </span>            :  * actual family and style.  There may be more than one of these fonts with
<span class="lineNum">    1864 </span>            :  * the same family and style, but different PangoFont and actual font face.
<span class="lineNum">    1865 </span>            :  * 
<span class="lineNum">    1866 </span>            :  * The point of this is to record the exact font face for gfxTextRun glyph
<span class="lineNum">    1867 </span>            :  * indices.  The style of this font does not necessarily represent the exact
<span class="lineNum">    1868 </span>            :  * gfxFontStyle used to build the text run.  Notably, the language is not
<span class="lineNum">    1869 </span>            :  * recorded.
<span class="lineNum">    1870 </span>            :  */
<span class="lineNum">    1871 </span>            : 
<a name="1872"><span class="lineNum">    1872 </span>            : /* static */</a>
<span class="lineNum">    1873 </span>            : already_AddRefed&lt;gfxFcFont&gt;
<span class="lineNum">    1874 </span><span class="lineNoCov">          0 : gfxFcFont::GetOrMakeFont(FcPattern *aRequestedPattern, FcPattern *aFontPattern,</span>
<span class="lineNum">    1875 </span>            :                          const gfxFontStyle *aFontStyle)
<span class="lineNum">    1876 </span>            : {
<span class="lineNum">    1877 </span>            :     nsAutoRef&lt;FcPattern&gt; renderPattern
<span class="lineNum">    1878 </span><span class="lineNoCov">          0 :         (FcFontRenderPrepare(nullptr, aRequestedPattern, aFontPattern));</span>
<span class="lineNum">    1879 </span>            : 
<span class="lineNum">    1880 </span>            :     // If synthetic bold/italic is not allowed by the style, adjust the
<span class="lineNum">    1881 </span>            :     // resulting pattern to match the actual properties of the font.
<span class="lineNum">    1882 </span><span class="lineNoCov">          0 :     if (!aFontStyle-&gt;allowSyntheticWeight) {</span>
<span class="lineNum">    1883 </span>            :         int weight;
<span class="lineNum">    1884 </span><span class="lineNoCov">          0 :         if (FcPatternGetInteger(aFontPattern, FC_WEIGHT, 0,</span>
<span class="lineNum">    1885 </span><span class="lineNoCov">          0 :                                 &amp;weight) == FcResultMatch) {</span>
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :             FcPatternDel(renderPattern, FC_WEIGHT);</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :             FcPatternAddInteger(renderPattern, FC_WEIGHT, weight);</span>
<span class="lineNum">    1888 </span>            :         }
<span class="lineNum">    1889 </span>            :     }
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :     if (!aFontStyle-&gt;allowSyntheticStyle) {</span>
<span class="lineNum">    1891 </span>            :         int slant;
<span class="lineNum">    1892 </span><span class="lineNoCov">          0 :         if (FcPatternGetInteger(aFontPattern, FC_SLANT, 0,</span>
<span class="lineNum">    1893 </span><span class="lineNoCov">          0 :                                 &amp;slant) == FcResultMatch) {</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :             FcPatternDel(renderPattern, FC_SLANT);</span>
<span class="lineNum">    1895 </span><span class="lineNoCov">          0 :             FcPatternAddInteger(renderPattern, FC_SLANT, slant);</span>
<span class="lineNum">    1896 </span>            :         }
<span class="lineNum">    1897 </span>            :     }
<span class="lineNum">    1898 </span>            : 
<span class="lineNum">    1899 </span>            :     cairo_font_face_t *face =
<span class="lineNum">    1900 </span><span class="lineNoCov">          0 :         cairo_ft_font_face_create_for_pattern(renderPattern);</span>
<span class="lineNum">    1901 </span>            : 
<span class="lineNum">    1902 </span>            :     // Reuse an existing font entry if available.
<span class="lineNum">    1903 </span><span class="lineNoCov">          0 :     RefPtr&lt;gfxFcFontEntry&gt; fe = gfxFcFontEntry::LookupFontEntry(face);</span>
<span class="lineNum">    1904 </span><span class="lineNoCov">          0 :     if (!fe) {</span>
<span class="lineNum">    1905 </span>            :         gfxDownloadedFcFontEntry *downloadedFontEntry =
<span class="lineNum">    1906 </span><span class="lineNoCov">          0 :             GetDownloadedFontEntry(aFontPattern);</span>
<span class="lineNum">    1907 </span><span class="lineNoCov">          0 :         if (downloadedFontEntry) {</span>
<span class="lineNum">    1908 </span>            :             // Web font
<span class="lineNum">    1909 </span>            :             fe = downloadedFontEntry;
<span class="lineNum">    1910 </span><span class="lineNoCov">          0 :             if (cairo_font_face_status(face) == CAIRO_STATUS_SUCCESS) {</span>
<span class="lineNum">    1911 </span>            :                 // cairo_font_face_t is using the web font data.
<span class="lineNum">    1912 </span>            :                 // Hold a reference to the font entry to keep the font face
<span class="lineNum">    1913 </span>            :                 // data.
<span class="lineNum">    1914 </span><span class="lineNoCov">          0 :                 if (!downloadedFontEntry-&gt;SetCairoFace(face)) {</span>
<span class="lineNum">    1915 </span>            :                     // OOM.  Let cairo pick a fallback font
<span class="lineNum">    1916 </span><span class="lineNoCov">          0 :                     cairo_font_face_destroy(face);</span>
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :                     face = cairo_ft_font_face_create_for_pattern(aRequestedPattern);</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :                     fe = gfxFcFontEntry::LookupFontEntry(face);</span>
<span class="lineNum">    1919 </span>            :                 }
<span class="lineNum">    1920 </span>            :             }
<span class="lineNum">    1921 </span>            :         }
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :         if (!fe) {</span>
<span class="lineNum">    1923 </span>            :             // Get a unique name for the font face from the file and id.
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :             nsAutoString name;</span>
<span class="lineNum">    1925 </span>            :             FcChar8 *fc_file;
<span class="lineNum">    1926 </span><span class="lineNoCov">          0 :             if (FcPatternGetString(renderPattern,</span>
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :                                    FC_FILE, 0, &amp;fc_file) == FcResultMatch) {</span>
<span class="lineNum">    1928 </span>            :                 int index;
<span class="lineNum">    1929 </span><span class="lineNoCov">          0 :                 if (FcPatternGetInteger(renderPattern,</span>
<span class="lineNum">    1930 </span><span class="lineNoCov">          0 :                                         FC_INDEX, 0, &amp;index) != FcResultMatch) {</span>
<span class="lineNum">    1931 </span>            :                     // cairo defaults to 0.
<span class="lineNum">    1932 </span><span class="lineNoCov">          0 :                     index = 0;</span>
<span class="lineNum">    1933 </span>            :                 }
<span class="lineNum">    1934 </span>            : 
<span class="lineNum">    1935 </span><span class="lineNoCov">          0 :                 AppendUTF8toUTF16(gfxFontconfigUtils::ToCString(fc_file), name);</span>
<span class="lineNum">    1936 </span><span class="lineNoCov">          0 :                 if (index != 0) {</span>
<span class="lineNum">    1937 </span><span class="lineNoCov">          0 :                     name.Append('/');</span>
<span class="lineNum">    1938 </span><span class="lineNoCov">          0 :                     name.AppendInt(index);</span>
<span class="lineNum">    1939 </span>            :                 }
<span class="lineNum">    1940 </span>            :             }
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span><span class="lineNoCov">          0 :             fe = new gfxSystemFcFontEntry(face, aFontPattern, name);</span>
<span class="lineNum">    1943 </span>            :         }
<span class="lineNum">    1944 </span>            :     }
<span class="lineNum">    1945 </span>            : 
<span class="lineNum">    1946 </span><span class="lineNoCov">          0 :     gfxFontStyle style(*aFontStyle);</span>
<span class="lineNum">    1947 </span><span class="lineNoCov">          0 :     style.size = GetPixelSize(renderPattern);</span>
<span class="lineNum">    1948 </span><span class="lineNoCov">          0 :     style.style = gfxFontconfigUtils::GetThebesStyle(renderPattern);</span>
<span class="lineNum">    1949 </span><span class="lineNoCov">          0 :     style.weight = gfxFontconfigUtils::GetThebesWeight(renderPattern);</span>
<span class="lineNum">    1950 </span>            : 
<span class="lineNum">    1951 </span>            :     RefPtr&lt;gfxFont&gt; font =
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :         gfxFontCache::GetCache()-&gt;Lookup(fe, &amp;style, nullptr);</span>
<span class="lineNum">    1953 </span><span class="lineNoCov">          0 :     if (!font) {</span>
<span class="lineNum">    1954 </span>            :         // Note that a file/index pair (or FT_Face) and the gfxFontStyle are
<span class="lineNum">    1955 </span>            :         // not necessarily enough to provide a key that will describe a unique
<span class="lineNum">    1956 </span>            :         // font.  cairoFont contains information from renderPattern, which is a
<span class="lineNum">    1957 </span>            :         // fully resolved pattern from FcFontRenderPrepare.
<span class="lineNum">    1958 </span>            :         // FcFontRenderPrepare takes the requested pattern and the face
<span class="lineNum">    1959 </span>            :         // pattern as input and can modify elements of the resulting pattern
<span class="lineNum">    1960 </span>            :         // that affect rendering but are not included in the gfxFontStyle.
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :         cairo_scaled_font_t *cairoFont = CreateScaledFont(renderPattern, face);</span>
<span class="lineNum">    1962 </span><span class="lineNoCov">          0 :         font = new gfxFcFont(cairoFont, renderPattern, fe, &amp;style);</span>
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :         gfxFontCache::GetCache()-&gt;AddNew(font);</span>
<span class="lineNum">    1964 </span><span class="lineNoCov">          0 :         cairo_scaled_font_destroy(cairoFont);</span>
<span class="lineNum">    1965 </span>            :     }
<span class="lineNum">    1966 </span>            : 
<span class="lineNum">    1967 </span><span class="lineNoCov">          0 :     cairo_font_face_destroy(face);</span>
<span class="lineNum">    1968 </span>            : 
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :     RefPtr&lt;gfxFcFont&gt; retval(static_cast&lt;gfxFcFont*&gt;(font.get()));</span>
<span class="lineNum">    1970 </span><span class="lineNoCov">          0 :     return retval.forget();</span>
<span class="lineNum">    1971 </span>            : }
<a name="1972"><span class="lineNum">    1972 </span>            : </a>
<span class="lineNum">    1973 </span>            : gfxFcFontSet *
<span class="lineNum">    1974 </span><span class="lineNoCov">          0 : gfxPangoFontGroup::GetBaseFontSet()</span>
<span class="lineNum">    1975 </span>            : {
<span class="lineNum">    1976 </span><span class="lineNoCov">          0 :     if (mFontSets.Length() &gt; 0)</span>
<span class="lineNum">    1977 </span><span class="lineNoCov">          0 :         return mFontSets[0].mFontSet;</span>
<span class="lineNum">    1978 </span>            : 
<span class="lineNum">    1979 </span><span class="lineNoCov">          0 :     mSizeAdjustFactor = 1.0; // will be adjusted below if necessary</span>
<span class="lineNum">    1980 </span>            :     nsAutoRef&lt;FcPattern&gt; pattern;
<span class="lineNum">    1981 </span>            :     RefPtr&lt;gfxFcFontSet&gt; fontSet =
<span class="lineNum">    1982 </span><span class="lineNoCov">          0 :         MakeFontSet(mPangoLanguage, mSizeAdjustFactor, &amp;pattern);</span>
<span class="lineNum">    1983 </span>            : 
<span class="lineNum">    1984 </span><span class="lineNoCov">          0 :     double size = GetPixelSize(pattern);</span>
<span class="lineNum">    1985 </span><span class="lineNoCov">          0 :     if (size != 0.0 &amp;&amp; mStyle.sizeAdjust &gt; 0.0) {</span>
<span class="lineNum">    1986 </span><span class="lineNoCov">          0 :         gfxFcFont *font = fontSet-&gt;GetFontAt(0, GetStyle());</span>
<span class="lineNum">    1987 </span><span class="lineNoCov">          0 :         if (font) {</span>
<span class="lineNum">    1988 </span>            :             const gfxFont::Metrics&amp; metrics =
<span class="lineNum">    1989 </span><span class="lineNoCov">          0 :                 font-&gt;GetMetrics(gfxFont::eHorizontal); // XXX vertical?</span>
<span class="lineNum">    1990 </span>            : 
<span class="lineNum">    1991 </span>            :             // The factor of 0.1 ensures that xHeight is sane so fonts don't
<span class="lineNum">    1992 </span>            :             // become huge.  Strictly &quot;&gt;&quot; ensures that xHeight and emHeight are
<span class="lineNum">    1993 </span>            :             // not both zero.
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 :             if (metrics.xHeight &gt; 0.1 * metrics.emHeight) {</span>
<span class="lineNum">    1995 </span>            :                 mSizeAdjustFactor =
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :                     mStyle.sizeAdjust * metrics.emHeight / metrics.xHeight;</span>
<span class="lineNum">    1997 </span>            : 
<span class="lineNum">    1998 </span><span class="lineNoCov">          0 :                 size *= mSizeAdjustFactor;</span>
<span class="lineNum">    1999 </span><span class="lineNoCov">          0 :                 FcPatternDel(pattern, FC_PIXEL_SIZE);</span>
<span class="lineNum">    2000 </span><span class="lineNoCov">          0 :                 FcPatternAddDouble(pattern, FC_PIXEL_SIZE, size);</span>
<span class="lineNum">    2001 </span>            : 
<span class="lineNum">    2002 </span><span class="lineNoCov">          0 :                 fontSet = new gfxFcFontSet(pattern, mUserFontSet);</span>
<span class="lineNum">    2003 </span>            :             }
<span class="lineNum">    2004 </span>            :         }
<span class="lineNum">    2005 </span>            :     }
<span class="lineNum">    2006 </span>            : 
<span class="lineNum">    2007 </span><span class="lineNoCov">          0 :     PangoLanguage *pangoLang = mPangoLanguage;</span>
<span class="lineNum">    2008 </span>            :     FcChar8 *fcLang;
<span class="lineNum">    2009 </span><span class="lineNoCov">          0 :     if (!pangoLang &amp;&amp;</span>
<span class="lineNum">    2010 </span><span class="lineNoCov">          0 :         FcPatternGetString(pattern, FC_LANG, 0, &amp;fcLang) == FcResultMatch) {</span>
<span class="lineNum">    2011 </span>            :         pangoLang =
<span class="lineNum">    2012 </span><span class="lineNoCov">          0 :             pango_language_from_string(gfxFontconfigUtils::ToCString(fcLang));</span>
<span class="lineNum">    2013 </span>            :     }
<span class="lineNum">    2014 </span>            : 
<span class="lineNum">    2015 </span><span class="lineNoCov">          0 :     mFontSets.AppendElement(FontSetByLangEntry(pangoLang, fontSet));</span>
<span class="lineNum">    2016 </span>            : 
<span class="lineNum">    2017 </span>            :     return fontSet;
<span class="lineNum">    2018 </span>            : }
<span class="lineNum">    2019 </span>            : 
<span class="lineNum">    2020 </span>            : /**
<span class="lineNum">    2021 </span>            :  ** gfxTextRun
<span class="lineNum">    2022 </span>            :  * 
<span class="lineNum">    2023 </span>            :  * A serious problem:
<span class="lineNum">    2024 </span>            :  *
<span class="lineNum">    2025 </span>            :  * -- We draw with a font that's hinted for the CTM, but we measure with a font
<span class="lineNum">    2026 </span>            :  * hinted to the identity matrix, so our &quot;bounding metrics&quot; may not be accurate.
<span class="lineNum">    2027 </span>            :  * 
<span class="lineNum">    2028 </span>            :  **/
<span class="lineNum">    2029 </span>            : 
<a name="2030"><span class="lineNum">    2030 </span>            : // This will fetch an existing scaled_font if one exists.</a>
<span class="lineNum">    2031 </span>            : static cairo_scaled_font_t *
<span class="lineNum">    2032 </span><span class="lineNoCov">          0 : CreateScaledFont(FcPattern *aPattern, cairo_font_face_t *aFace)</span>
<span class="lineNum">    2033 </span>            : {
<span class="lineNum">    2034 </span><span class="lineNoCov">          0 :     double size = GetPixelSize(aPattern);</span>
<span class="lineNum">    2035 </span>            :         
<span class="lineNum">    2036 </span>            :     cairo_matrix_t fontMatrix;
<span class="lineNum">    2037 </span>            :     FcMatrix *fcMatrix;
<span class="lineNum">    2038 </span><span class="lineNoCov">          0 :     if (FcPatternGetMatrix(aPattern, FC_MATRIX, 0, &amp;fcMatrix) == FcResultMatch)</span>
<span class="lineNum">    2039 </span><span class="lineNoCov">          0 :         cairo_matrix_init(&amp;fontMatrix, fcMatrix-&gt;xx, -fcMatrix-&gt;yx, -fcMatrix-&gt;xy, fcMatrix-&gt;yy, 0, 0);</span>
<span class="lineNum">    2040 </span>            :     else
<span class="lineNum">    2041 </span><span class="lineNoCov">          0 :         cairo_matrix_init_identity(&amp;fontMatrix);</span>
<span class="lineNum">    2042 </span><span class="lineNoCov">          0 :     cairo_matrix_scale(&amp;fontMatrix, size, size);</span>
<span class="lineNum">    2043 </span>            : 
<span class="lineNum">    2044 </span>            :     FcBool printing;
<span class="lineNum">    2045 </span><span class="lineNoCov">          0 :     if (FcPatternGetBool(aPattern, PRINTING_FC_PROPERTY, 0, &amp;printing) != FcResultMatch) {</span>
<span class="lineNum">    2046 </span><span class="lineNoCov">          0 :         printing = FcFalse;</span>
<span class="lineNum">    2047 </span>            :     }
<span class="lineNum">    2048 </span>            : 
<span class="lineNum">    2049 </span>            :     // The cairo_scaled_font is created with a unit ctm so that metrics and
<span class="lineNum">    2050 </span>            :     // positions are in user space, but this means that hinting effects will
<span class="lineNum">    2051 </span>            :     // not be estimated accurately for non-unit transformations.
<span class="lineNum">    2052 </span>            :     cairo_matrix_t identityMatrix;
<span class="lineNum">    2053 </span><span class="lineNoCov">          0 :     cairo_matrix_init_identity(&amp;identityMatrix);</span>
<span class="lineNum">    2054 </span>            : 
<span class="lineNum">    2055 </span>            :     // Font options are set explicitly here to improve cairo's caching
<span class="lineNum">    2056 </span>            :     // behavior and to record the relevant parts of the pattern for
<span class="lineNum">    2057 </span>            :     // SetupCairoFont (so that the pattern can be released).
<span class="lineNum">    2058 </span>            :     //
<span class="lineNum">    2059 </span>            :     // Most font_options have already been set as defaults on the FcPattern
<span class="lineNum">    2060 </span>            :     // with cairo_ft_font_options_substitute(), then user and system
<span class="lineNum">    2061 </span>            :     // fontconfig configurations were applied.  The resulting font_options
<span class="lineNum">    2062 </span>            :     // have been recorded on the face during
<span class="lineNum">    2063 </span>            :     // cairo_ft_font_face_create_for_pattern().
<span class="lineNum">    2064 </span>            :     //
<span class="lineNum">    2065 </span>            :     // None of the settings here cause this scaled_font to behave any
<span class="lineNum">    2066 </span>            :     // differently from how it would behave if it were created from the same
<span class="lineNum">    2067 </span>            :     // face with default font_options.
<span class="lineNum">    2068 </span>            :     //
<span class="lineNum">    2069 </span>            :     // We set options explicitly so that the same scaled_font will be found in
<span class="lineNum">    2070 </span>            :     // the cairo_scaled_font_map when cairo loads glyphs from a context with
<span class="lineNum">    2071 </span>            :     // the same font_face, font_matrix, ctm, and surface font_options.
<span class="lineNum">    2072 </span>            :     //
<span class="lineNum">    2073 </span>            :     // Unfortunately, _cairo_scaled_font_keys_equal doesn't know about the
<span class="lineNum">    2074 </span>            :     // font_options on the cairo_ft_font_face, and doesn't consider default
<span class="lineNum">    2075 </span>            :     // option values to not match any explicit values.
<span class="lineNum">    2076 </span>            :     //
<span class="lineNum">    2077 </span>            :     // Even after cairo_set_scaled_font is used to set font_options for the
<span class="lineNum">    2078 </span>            :     // cairo context, when cairo looks for a scaled_font for the context, it
<span class="lineNum">    2079 </span>            :     // will look for a font with some option values from the target surface if
<span class="lineNum">    2080 </span>            :     // any values are left default on the context font_options.  If this
<span class="lineNum">    2081 </span>            :     // scaled_font is created with default font_options, cairo will not find
<span class="lineNum">    2082 </span>            :     // it.
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :     cairo_font_options_t *fontOptions = cairo_font_options_create();</span>
<span class="lineNum">    2084 </span>            : 
<span class="lineNum">    2085 </span>            :     // The one option not recorded in the pattern is hint_metrics, which will
<span class="lineNum">    2086 </span>            :     // affect glyph metrics.  The default behaves as CAIRO_HINT_METRICS_ON.
<span class="lineNum">    2087 </span>            :     // We should be considering the font_options of the surface on which this
<span class="lineNum">    2088 </span>            :     // font will be used, but currently we don't have different gfxFonts for
<span class="lineNum">    2089 </span>            :     // different surface font_options, so we'll create a font suitable for the
<span class="lineNum">    2090 </span>            :     // Screen. Image and xlib surfaces default to CAIRO_HINT_METRICS_ON.
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :     if (printing) {</span>
<span class="lineNum">    2092 </span><span class="lineNoCov">          0 :         cairo_font_options_set_hint_metrics(fontOptions, CAIRO_HINT_METRICS_OFF);</span>
<span class="lineNum">    2093 </span>            :     } else {
<span class="lineNum">    2094 </span><span class="lineNoCov">          0 :         cairo_font_options_set_hint_metrics(fontOptions, CAIRO_HINT_METRICS_ON);</span>
<span class="lineNum">    2095 </span>            :     }
<span class="lineNum">    2096 </span>            : 
<span class="lineNum">    2097 </span>            :     // The remaining options have been recorded on the pattern and the face.
<span class="lineNum">    2098 </span>            :     // _cairo_ft_options_merge has some logic to decide which options from the
<span class="lineNum">    2099 </span>            :     // scaled_font or from the cairo_ft_font_face take priority in the way the
<span class="lineNum">    2100 </span>            :     // font behaves.
<span class="lineNum">    2101 </span>            :     //
<span class="lineNum">    2102 </span>            :     // In the majority of cases, _cairo_ft_options_merge uses the options from
<span class="lineNum">    2103 </span>            :     // the cairo_ft_font_face, so sometimes it is not so important which
<span class="lineNum">    2104 </span>            :     // values are set here so long as they are not defaults, but we'll set
<span class="lineNum">    2105 </span>            :     // them to the exact values that we expect from the font, to be consistent
<span class="lineNum">    2106 </span>            :     // and to protect against changes in cairo.
<span class="lineNum">    2107 </span>            :     //
<span class="lineNum">    2108 </span>            :     // In some cases, _cairo_ft_options_merge uses some options from the
<span class="lineNum">    2109 </span>            :     // scaled_font's font_options rather than options on the
<span class="lineNum">    2110 </span>            :     // cairo_ft_font_face (from fontconfig).
<span class="lineNum">    2111 </span>            :     // https://bugs.freedesktop.org/show_bug.cgi?id=11838
<span class="lineNum">    2112 </span>            :     //
<span class="lineNum">    2113 </span>            :     // Surface font options were set on the pattern in
<span class="lineNum">    2114 </span>            :     // cairo_ft_font_options_substitute.  If fontconfig has changed the
<span class="lineNum">    2115 </span>            :     // hint_style then that is what the user (or distribution) wants, so we
<span class="lineNum">    2116 </span>            :     // use the setting from the FcPattern.
<span class="lineNum">    2117 </span>            :     //
<span class="lineNum">    2118 </span>            :     // Fallback values here mirror treatment of defaults in cairo-ft-font.c.
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :     FcBool hinting = FcFalse;</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :     if (FcPatternGetBool(aPattern, FC_HINTING, 0, &amp;hinting) != FcResultMatch) {</span>
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 :         hinting = FcTrue;</span>
<span class="lineNum">    2122 </span>            :     }
<span class="lineNum">    2123 </span>            : 
<span class="lineNum">    2124 </span>            :     cairo_hint_style_t hint_style;
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :     if (printing || !hinting) {</span>
<span class="lineNum">    2126 </span>            :         hint_style = CAIRO_HINT_STYLE_NONE;
<span class="lineNum">    2127 </span>            :     } else {
<span class="lineNum">    2128 </span>            : #ifdef FC_HINT_STYLE  // FC_HINT_STYLE is available from fontconfig 2.2.91.
<span class="lineNum">    2129 </span>            :         int fc_hintstyle;
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :         if (FcPatternGetInteger(aPattern, FC_HINT_STYLE,</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :                                 0, &amp;fc_hintstyle        ) != FcResultMatch) {</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :             fc_hintstyle = FC_HINT_FULL;</span>
<span class="lineNum">    2133 </span>            :         }
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :         switch (fc_hintstyle) {</span>
<span class="lineNum">    2135 </span>            :             case FC_HINT_NONE:
<span class="lineNum">    2136 </span>            :                 hint_style = CAIRO_HINT_STYLE_NONE;
<span class="lineNum">    2137 </span>            :                 break;
<span class="lineNum">    2138 </span>            :             case FC_HINT_SLIGHT:
<span class="lineNum">    2139 </span>            :                 hint_style = CAIRO_HINT_STYLE_SLIGHT;
<span class="lineNum">    2140 </span>            :                 break;
<span class="lineNum">    2141 </span>            :             case FC_HINT_MEDIUM:
<span class="lineNum">    2142 </span>            :             default: // This fallback mirrors _get_pattern_ft_options in cairo.
<span class="lineNum">    2143 </span>            :                 hint_style = CAIRO_HINT_STYLE_MEDIUM;
<span class="lineNum">    2144 </span>            :                 break;
<span class="lineNum">    2145 </span>            :             case FC_HINT_FULL:
<span class="lineNum">    2146 </span>            :                 hint_style = CAIRO_HINT_STYLE_FULL;
<span class="lineNum">    2147 </span>            :                 break;
<span class="lineNum">    2148 </span>            :         }
<span class="lineNum">    2149 </span>            : #else // no FC_HINT_STYLE
<span class="lineNum">    2150 </span>            :         hint_style = CAIRO_HINT_STYLE_FULL;
<span class="lineNum">    2151 </span>            : #endif
<span class="lineNum">    2152 </span>            :     }
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :     cairo_font_options_set_hint_style(fontOptions, hint_style);</span>
<span class="lineNum">    2154 </span>            : 
<span class="lineNum">    2155 </span>            :     int rgba;
<span class="lineNum">    2156 </span><span class="lineNoCov">          0 :     if (FcPatternGetInteger(aPattern,</span>
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :                             FC_RGBA, 0, &amp;rgba) != FcResultMatch) {</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :         rgba = FC_RGBA_UNKNOWN;</span>
<span class="lineNum">    2159 </span>            :     }
<span class="lineNum">    2160 </span><span class="lineNoCov">          0 :     cairo_subpixel_order_t subpixel_order = CAIRO_SUBPIXEL_ORDER_DEFAULT;</span>
<span class="lineNum">    2161 </span><span class="lineNoCov">          0 :     switch (rgba) {</span>
<span class="lineNum">    2162 </span>            :         case FC_RGBA_UNKNOWN:
<span class="lineNum">    2163 </span>            :         case FC_RGBA_NONE:
<span class="lineNum">    2164 </span>            :         default:
<span class="lineNum">    2165 </span>            :             // There is no CAIRO_SUBPIXEL_ORDER_NONE.  Subpixel antialiasing
<span class="lineNum">    2166 </span>            :             // is disabled through cairo_antialias_t.
<span class="lineNum">    2167 </span><span class="lineNoCov">          0 :             rgba = FC_RGBA_NONE;</span>
<span class="lineNum">    2168 </span>            :             // subpixel_order won't be used by the font as we won't use
<span class="lineNum">    2169 </span>            :             // CAIRO_ANTIALIAS_SUBPIXEL, but don't leave it at default for
<span class="lineNum">    2170 </span>            :             // caching reasons described above.  Fall through:
<span class="lineNum">    2171 </span>            :             MOZ_FALLTHROUGH;
<span class="lineNum">    2172 </span>            :         case FC_RGBA_RGB:
<span class="lineNum">    2173 </span>            :             subpixel_order = CAIRO_SUBPIXEL_ORDER_RGB;
<span class="lineNum">    2174 </span>            :             break;
<span class="lineNum">    2175 </span>            :         case FC_RGBA_BGR:
<span class="lineNum">    2176 </span>            :             subpixel_order = CAIRO_SUBPIXEL_ORDER_BGR;
<span class="lineNum">    2177 </span>            :             break;
<span class="lineNum">    2178 </span>            :         case FC_RGBA_VRGB:
<span class="lineNum">    2179 </span><span class="lineNoCov">          0 :             subpixel_order = CAIRO_SUBPIXEL_ORDER_VRGB;</span>
<span class="lineNum">    2180 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2181 </span>            :         case FC_RGBA_VBGR:
<span class="lineNum">    2182 </span><span class="lineNoCov">          0 :             subpixel_order = CAIRO_SUBPIXEL_ORDER_VBGR;</span>
<span class="lineNum">    2183 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    2184 </span>            :     }
<span class="lineNum">    2185 </span><span class="lineNoCov">          0 :     cairo_font_options_set_subpixel_order(fontOptions, subpixel_order);</span>
<span class="lineNum">    2186 </span>            : 
<span class="lineNum">    2187 </span>            :     FcBool fc_antialias;
<span class="lineNum">    2188 </span><span class="lineNoCov">          0 :     if (FcPatternGetBool(aPattern,</span>
<span class="lineNum">    2189 </span><span class="lineNoCov">          0 :                          FC_ANTIALIAS, 0, &amp;fc_antialias) != FcResultMatch) {</span>
<span class="lineNum">    2190 </span><span class="lineNoCov">          0 :         fc_antialias = FcTrue;</span>
<span class="lineNum">    2191 </span>            :     }
<span class="lineNum">    2192 </span>            :     cairo_antialias_t antialias;
<span class="lineNum">    2193 </span><span class="lineNoCov">          0 :     if (!fc_antialias) {</span>
<span class="lineNum">    2194 </span>            :         antialias = CAIRO_ANTIALIAS_NONE;
<span class="lineNum">    2195 </span><span class="lineNoCov">          0 :     } else if (rgba == FC_RGBA_NONE) {</span>
<span class="lineNum">    2196 </span>            :         antialias = CAIRO_ANTIALIAS_GRAY;
<span class="lineNum">    2197 </span>            :     } else {
<span class="lineNum">    2198 </span><span class="lineNoCov">          0 :         antialias = CAIRO_ANTIALIAS_SUBPIXEL;</span>
<span class="lineNum">    2199 </span>            :     }
<span class="lineNum">    2200 </span><span class="lineNoCov">          0 :     cairo_font_options_set_antialias(fontOptions, antialias);</span>
<span class="lineNum">    2201 </span>            : 
<span class="lineNum">    2202 </span>            :     cairo_scaled_font_t *scaledFont =
<span class="lineNum">    2203 </span>            :         cairo_scaled_font_create(aFace, &amp;fontMatrix, &amp;identityMatrix,
<span class="lineNum">    2204 </span><span class="lineNoCov">          0 :                                  fontOptions);</span>
<span class="lineNum">    2205 </span>            : 
<span class="lineNum">    2206 </span><span class="lineNoCov">          0 :     cairo_font_options_destroy(fontOptions);</span>
<span class="lineNum">    2207 </span>            : 
<span class="lineNum">    2208 </span>            :     NS_ASSERTION(cairo_scaled_font_status(scaledFont) == CAIRO_STATUS_SUCCESS,
<span class="lineNum">    2209 </span>            :                  &quot;Failed to create scaled font&quot;);
<span class="lineNum">    2210 </span><span class="lineNoCov">          0 :     return scaledFont;</span>
<span class="lineNum">    2211 </span>            : }
<span class="lineNum">    2212 </span>            : 
<a name="2213"><span class="lineNum">    2213 </span>            : /* static */</a>
<span class="lineNum">    2214 </span>            : PangoLanguage *
<span class="lineNum">    2215 </span><span class="lineNoCov">          0 : GuessPangoLanguage(nsIAtom *aLanguage)</span>
<span class="lineNum">    2216 </span>            : {
<span class="lineNum">    2217 </span><span class="lineNoCov">          0 :     if (!aLanguage)</span>
<span class="lineNum">    2218 </span>            :         return nullptr;
<span class="lineNum">    2219 </span>            : 
<span class="lineNum">    2220 </span>            :     // Pango and fontconfig won't understand mozilla's internal langGroups, so
<span class="lineNum">    2221 </span>            :     // find a real language.
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 :     nsAutoCString lang;</span>
<span class="lineNum">    2223 </span><span class="lineNoCov">          0 :     gfxFontconfigUtils::GetSampleLangForGroup(aLanguage, &amp;lang);</span>
<span class="lineNum">    2224 </span><span class="lineNoCov">          0 :     if (lang.IsEmpty())</span>
<span class="lineNum">    2225 </span>            :         return nullptr;
<span class="lineNum">    2226 </span>            : 
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :     return pango_language_from_string(lang.get());</span>
<span class="lineNum">    2228 </span>            : }
<span class="lineNum">    2229 </span>            : 
<span class="lineNum">    2230 </span>            : #ifdef MOZ_WIDGET_GTK
<span class="lineNum">    2231 </span>            : /***************************************************************************
<span class="lineNum">    2232 </span>            :  *
<span class="lineNum">    2233 </span>            :  * This function must be last in the file because it uses the system cairo
<span class="lineNum">    2234 </span>            :  * library.  Above this point the cairo library used is the tree cairo if
<span class="lineNum">    2235 </span>            :  * MOZ_TREE_CAIRO.
<span class="lineNum">    2236 </span>            :  */
<span class="lineNum">    2237 </span>            : 
<span class="lineNum">    2238 </span>            : #if MOZ_TREE_CAIRO
<span class="lineNum">    2239 </span>            : // Tree cairo symbols have different names.  Disable their activation through
<span class="lineNum">    2240 </span>            : // preprocessor macros.
<span class="lineNum">    2241 </span>            : #undef cairo_ft_font_options_substitute
<span class="lineNum">    2242 </span>            : 
<span class="lineNum">    2243 </span>            : // The system cairo functions are not declared because the include paths cause
<span class="lineNum">    2244 </span>            : // the gdk headers to pick up the tree cairo.h.
<span class="lineNum">    2245 </span>            : extern &quot;C&quot; {
<span class="lineNum">    2246 </span>            : NS_VISIBILITY_DEFAULT void
<span class="lineNum">    2247 </span>            : cairo_ft_font_options_substitute (const cairo_font_options_t *options,
<span class="lineNum">    2248 </span>            :                                   FcPattern                  *pattern);
<span class="lineNum">    2249 </span>            : }
<span class="lineNum">    2250 </span>            : #endif
<a name="2251"><span class="lineNum">    2251 </span>            : </a>
<span class="lineNum">    2252 </span>            : static void
<span class="lineNum">    2253 </span><span class="lineNoCov">          0 : ApplyGdkScreenFontOptions(FcPattern *aPattern)</span>
<span class="lineNum">    2254 </span>            : {
<span class="lineNum">    2255 </span>            :     const cairo_font_options_t *options =
<span class="lineNum">    2256 </span><span class="lineNoCov">          0 :         gdk_screen_get_font_options(gdk_screen_get_default());</span>
<span class="lineNum">    2257 </span>            : 
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :     cairo_ft_font_options_substitute(options, aPattern);</span>
<span class="lineNum">    2259 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2260 </span>            : 
<span class="lineNum">    2261 </span>            : #endif // MOZ_WIDGET_GTK
<span class="lineNum">    2262 </span>            : 
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13-2-g25f5d38</a></td></tr>
  </table>
  <br>

</body>
</html>
