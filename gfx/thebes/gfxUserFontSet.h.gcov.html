<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - output.info - gfx/thebes/gfxUserFontSet.h</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">gfx/thebes</a> - gfxUserFontSet.h<span style="font-size: 80%;"> (source / <a href="gfxUserFontSet.h.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">output.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">66</td>
            <td class="headerCovTableEntry">73</td>
            <td class="headerCovTableEntryHi">90.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-03-15 21:34:37</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">22</td>
            <td class="headerCovTableEntry">25</td>
            <td class="headerCovTableEntryMed">88.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Legend:</td>
            <td class="headerValueLeg">            Lines:
            <span class="coverLegendCov">hit</span>
            <span class="coverLegendNoCov">not hit</span>
</td>
            <td></td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* -*- Mode: C++; tab-width: 20; indent-tabs-mode: nil; c-basic-offset: 4 -*-</a>
<span class="lineNum">       2 </span>            :  * This Source Code Form is subject to the terms of the Mozilla Public
<span class="lineNum">       3 </span>            :  * License, v. 2.0. If a copy of the MPL was not distributed with this
<span class="lineNum">       4 </span>            :  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
<span class="lineNum">       5 </span>            : 
<span class="lineNum">       6 </span>            : #ifndef GFX_USER_FONT_SET_H
<span class="lineNum">       7 </span>            : #define GFX_USER_FONT_SET_H
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : #include &quot;gfxFont.h&quot;
<span class="lineNum">      10 </span>            : #include &quot;gfxFontFamilyList.h&quot;
<span class="lineNum">      11 </span>            : #include &quot;nsRefPtrHashtable.h&quot;
<span class="lineNum">      12 </span>            : #include &quot;nsCOMPtr.h&quot;
<span class="lineNum">      13 </span>            : #include &quot;nsIURI.h&quot;
<span class="lineNum">      14 </span>            : #include &quot;nsIPrincipal.h&quot;
<span class="lineNum">      15 </span>            : #include &quot;nsIScriptError.h&quot;
<span class="lineNum">      16 </span>            : #include &quot;nsURIHashKey.h&quot;
<span class="lineNum">      17 </span>            : #include &quot;mozilla/net/ReferrerPolicy.h&quot;
<span class="lineNum">      18 </span>            : #include &quot;gfxFontConstants.h&quot;
<span class="lineNum">      19 </span>            : 
<span class="lineNum">      20 </span>            : class nsFontFaceLoader;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : //#define DEBUG_USERFONT_CACHE
<span class="lineNum">      23 </span>            : 
<a name="24"><span class="lineNum">      24 </span>            : class gfxFontFaceBufferSource</a>
<span class="lineNum">      25 </span>            : {
<span class="lineNum">      26 </span><span class="lineCov">          1 :   NS_INLINE_DECL_REFCOUNTING(gfxFontFaceBufferSource)</span>
<span class="lineNum">      27 </span>            : public:
<span class="lineNum">      28 </span>            :   virtual void TakeBuffer(uint8_t*&amp; aBuffer, uint32_t&amp; aLength) = 0;
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : protected:
<span class="lineNum">      31 </span>            :   virtual ~gfxFontFaceBufferSource() {}
<span class="lineNum">      32 </span>            : };
<span class="lineNum">      33 </span>            : 
<a name="34"><span class="lineNum">      34 </span>            : // parsed CSS @font-face rule information</a>
<span class="lineNum">      35 </span>            : // lifetime: from when @font-face rule processed until font is loaded
<span class="lineNum">      36 </span><span class="lineCov">          1 : struct gfxFontFaceSrc {</span>
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            :     enum SourceType {
<span class="lineNum">      39 </span>            :         eSourceType_Local,
<span class="lineNum">      40 </span>            :         eSourceType_URL,
<span class="lineNum">      41 </span>            :         eSourceType_Buffer
<span class="lineNum">      42 </span>            :     };
<span class="lineNum">      43 </span>            : 
<span class="lineNum">      44 </span>            :     SourceType             mSourceType;
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span>            :     // if url, whether to use the origin principal or not
<span class="lineNum">      47 </span>            :     bool                   mUseOriginPrincipal;
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            :     // format hint flags, union of all possible formats
<span class="lineNum">      50 </span>            :     // (e.g. TrueType, EOT, SVG, etc.)
<span class="lineNum">      51 </span>            :     // see FLAG_FORMAT_* enum values below
<span class="lineNum">      52 </span>            :     uint32_t               mFormatFlags;
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            :     nsString               mLocalName;     // full font name if local
<span class="lineNum">      55 </span>            :     nsCOMPtr&lt;nsIURI&gt;       mURI;           // uri if url
<span class="lineNum">      56 </span>            :     nsCOMPtr&lt;nsIURI&gt;       mReferrer;      // referrer url if url
<span class="lineNum">      57 </span>            :     mozilla::net::ReferrerPolicy mReferrerPolicy;
<span class="lineNum">      58 </span>            :     nsCOMPtr&lt;nsIPrincipal&gt; mOriginPrincipal; // principal if url
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            :     RefPtr&lt;gfxFontFaceBufferSource&gt; mBuffer;
<span class="lineNum">      61 </span>            : };
<a name="62"><span class="lineNum">      62 </span>            : </a>
<span class="lineNum">      63 </span>            : inline bool
<span class="lineNum">      64 </span><span class="lineCov">          1 : operator==(const gfxFontFaceSrc&amp; a, const gfxFontFaceSrc&amp; b)</span>
<span class="lineNum">      65 </span>            : {
<span class="lineNum">      66 </span><span class="lineCov">          1 :     if (a.mSourceType != b.mSourceType) {</span>
<span class="lineNum">      67 </span>            :         return false;
<span class="lineNum">      68 </span>            :     }
<span class="lineNum">      69 </span><span class="lineCov">          1 :     switch (a.mSourceType) {</span>
<span class="lineNum">      70 </span>            :         case gfxFontFaceSrc::eSourceType_Local:
<span class="lineNum">      71 </span><span class="lineCov">          1 :             return a.mLocalName == b.mLocalName;</span>
<span class="lineNum">      72 </span>            :         case gfxFontFaceSrc::eSourceType_URL: {
<span class="lineNum">      73 </span>            :             bool equals;
<span class="lineNum">      74 </span><span class="lineCov">          1 :             return a.mUseOriginPrincipal == b.mUseOriginPrincipal &amp;&amp;</span>
<span class="lineNum">      75 </span><span class="lineCov">          1 :                    a.mFormatFlags == b.mFormatFlags &amp;&amp;</span>
<span class="lineNum">      76 </span><span class="lineCov">          1 :                    NS_SUCCEEDED(a.mURI-&gt;Equals(b.mURI, &amp;equals)) &amp;&amp; equals &amp;&amp;</span>
<span class="lineNum">      77 </span><span class="lineCov">          1 :                    NS_SUCCEEDED(a.mReferrer-&gt;Equals(b.mReferrer, &amp;equals)) &amp;&amp;</span>
<span class="lineNum">      78 </span><span class="lineCov">          1 :                      equals &amp;&amp;</span>
<span class="lineNum">      79 </span><span class="lineCov">          1 :                    a.mReferrerPolicy == b.mReferrerPolicy &amp;&amp;</span>
<span class="lineNum">      80 </span><span class="lineCov">          1 :                    a.mOriginPrincipal-&gt;Equals(b.mOriginPrincipal);</span>
<span class="lineNum">      81 </span>            :         }
<span class="lineNum">      82 </span>            :         case gfxFontFaceSrc::eSourceType_Buffer:
<span class="lineNum">      83 </span><span class="lineCov">          1 :             return a.mBuffer == b.mBuffer;</span>
<span class="lineNum">      84 </span>            :     }
<span class="lineNum">      85 </span>            :     NS_WARNING(&quot;unexpected mSourceType&quot;);
<span class="lineNum">      86 </span>            :     return false;
<span class="lineNum">      87 </span>            : }
<span class="lineNum">      88 </span>            : 
<span class="lineNum">      89 </span>            : // Subclassed to store platform-specific code cleaned out when font entry is
<span class="lineNum">      90 </span>            : // deleted.
<span class="lineNum">      91 </span>            : // Lifetime: from when platform font is created until it is deactivated.
<span class="lineNum">      92 </span>            : // If the platform does not need to add any platform-specific code/data here,
<span class="lineNum">      93 </span>            : // then the gfxUserFontSet will allocate a base gfxUserFontData and attach
<span class="lineNum">      94 </span>            : // to the entry to track the basic user font info fields here.
<a name="95"><span class="lineNum">      95 </span>            : class gfxUserFontData {</a>
<span class="lineNum">      96 </span>            : public:
<span class="lineNum">      97 </span><span class="lineCov">          1 :     gfxUserFontData()</span>
<span class="lineNum">      98 </span>            :         : mSrcIndex(0), mFormat(0), mMetaOrigLen(0),
<span class="lineNum">      99 </span>            :           mCRC32(0), mLength(0), mCompression(kUnknownCompression),
<a name="100"><span class="lineNum">     100 </span><span class="lineCov">          1 :           mPrivate(false), mIsBuffer(false)</span></a>
<span class="lineNum">     101 </span><span class="lineCov">          1 :     { }</span>
<span class="lineNum">     102 </span><span class="lineCov">          1 :     virtual ~gfxUserFontData() { }</span>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            :     size_t SizeOfIncludingThis(mozilla::MallocSizeOf aMallocSizeOf) const;
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :     nsTArray&lt;uint8_t&gt; mMetadata;  // woff metadata block (compressed), if any
<span class="lineNum">     107 </span>            :     nsCOMPtr&lt;nsIURI&gt;  mURI;       // URI of the source, if it was url()
<span class="lineNum">     108 </span>            :     nsCOMPtr&lt;nsIPrincipal&gt; mPrincipal; // principal for the download, if url()
<span class="lineNum">     109 </span>            :     nsString          mLocalName; // font name used for the source, if local()
<span class="lineNum">     110 </span>            :     nsString          mRealName;  // original fullname from the font resource
<span class="lineNum">     111 </span>            :     uint32_t          mSrcIndex;  // index in the rule's source list
<span class="lineNum">     112 </span>            :     uint32_t          mFormat;    // format hint for the source used, if any
<span class="lineNum">     113 </span>            :     uint32_t          mMetaOrigLen; // length needed to decompress metadata
<span class="lineNum">     114 </span>            :     uint32_t          mCRC32;     // Checksum
<span class="lineNum">     115 </span>            :     uint32_t          mLength;    // Font length
<span class="lineNum">     116 </span>            :     uint8_t           mCompression; // compression type
<span class="lineNum">     117 </span>            :     bool              mPrivate;   // whether font belongs to a private window
<span class="lineNum">     118 </span>            :     bool              mIsBuffer;  // whether the font source was a buffer
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span>            :     enum {
<span class="lineNum">     121 </span>            :         kUnknownCompression = 0,
<span class="lineNum">     122 </span>            :         kZlibCompression = 1,
<span class="lineNum">     123 </span>            :         kBrotliCompression = 2
<span class="lineNum">     124 </span>            :     };
<span class="lineNum">     125 </span>            : };
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span>            : // initially contains a set of userfont font entry objects, replaced with
<span class="lineNum">     128 </span>            : // platform/user fonts as downloaded
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span>            : class gfxUserFontFamily : public gfxFontFamily {
<span class="lineNum">     131 </span>            : public:
<a name="132"><span class="lineNum">     132 </span>            :     friend class gfxUserFontSet;</a>
<span class="lineNum">     133 </span>            : 
<span class="lineNum">     134 </span><span class="lineCov">          1 :     explicit gfxUserFontFamily(const nsAString&amp; aName)</span>
<a name="135"><span class="lineNum">     135 </span><span class="lineCov">          1 :         : gfxFontFamily(aName) { }</span></a>
<span class="lineNum">     136 </span>            : 
<span class="lineNum">     137 </span><span class="lineCov">          1 :     virtual ~gfxUserFontFamily() { }</span>
<a name="138"><span class="lineNum">     138 </span>            : </a>
<span class="lineNum">     139 </span>            :     // add the given font entry to the end of the family's list
<span class="lineNum">     140 </span><span class="lineCov">          1 :     void AddFontEntry(gfxFontEntry* aFontEntry) {</span>
<span class="lineNum">     141 </span>            :         // keep ref while removing existing entry
<span class="lineNum">     142 </span><span class="lineCov">          1 :         RefPtr&lt;gfxFontEntry&gt; fe = aFontEntry;</span>
<span class="lineNum">     143 </span>            :         // remove existing entry, if already present
<span class="lineNum">     144 </span><span class="lineCov">          1 :         mAvailableFonts.RemoveElement(aFontEntry);</span>
<span class="lineNum">     145 </span>            :         // insert at the beginning so that the last-defined font is the first
<span class="lineNum">     146 </span>            :         // one in the fontlist used for matching, as per CSS Fonts spec
<span class="lineNum">     147 </span><span class="lineCov">          1 :         mAvailableFonts.InsertElementAt(0, aFontEntry);</span>
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span><span class="lineCov">          1 :         if (aFontEntry-&gt;mFamilyName.IsEmpty()) {</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :             aFontEntry-&gt;mFamilyName = Name();</span>
<span class="lineNum">     151 </span>            :         } else {
<span class="lineNum">     152 </span>            : #ifdef DEBUG
<span class="lineNum">     153 </span>            :             nsString thisName = Name();
<span class="lineNum">     154 </span>            :             nsString entryName = aFontEntry-&gt;mFamilyName;
<span class="lineNum">     155 </span>            :             ToLowerCase(thisName);
<span class="lineNum">     156 </span>            :             ToLowerCase(entryName);
<span class="lineNum">     157 </span>            :             MOZ_ASSERT(thisName.Equals(entryName));
<span class="lineNum">     158 </span>            : #endif
<span class="lineNum">     159 </span>            :         }
<span class="lineNum">     160 </span><span class="lineCov">          1 :         ResetCharacterMap();</span>
<span class="lineNum">     161 </span><span class="lineCov">          1 :     }</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span>            :     // Remove all font entries from the family
<span class="lineNum">     164 </span>            :     void DetachFontEntries() {
<span class="lineNum">     165 </span>            :         mAvailableFonts.Clear();
<span class="lineNum">     166 </span>            :     }
<span class="lineNum">     167 </span>            : };
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            : class gfxUserFontEntry;
<span class="lineNum">     170 </span>            : class gfxOTSContext;
<span class="lineNum">     171 </span>            : 
<span class="lineNum">     172 </span>            : class gfxUserFontSet {
<span class="lineNum">     173 </span>            :     friend class gfxUserFontEntry;
<span class="lineNum">     174 </span>            :     friend class gfxOTSContext;
<span class="lineNum">     175 </span>            : 
<a name="176"><span class="lineNum">     176 </span>            : public:</a>
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineCov">          1 :     NS_INLINE_DECL_REFCOUNTING(gfxUserFontSet)</span>
<span class="lineNum">     179 </span>            : 
<span class="lineNum">     180 </span>            :     gfxUserFontSet();
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            :     enum {
<span class="lineNum">     183 </span>            :         // no flags ==&gt; no hint set
<span class="lineNum">     184 </span>            :         // unknown ==&gt; unknown format hint set
<span class="lineNum">     185 </span>            :         FLAG_FORMAT_UNKNOWN        = 1,
<span class="lineNum">     186 </span>            :         FLAG_FORMAT_OPENTYPE       = 1 &lt;&lt; 1,
<span class="lineNum">     187 </span>            :         FLAG_FORMAT_TRUETYPE       = 1 &lt;&lt; 2,
<span class="lineNum">     188 </span>            :         FLAG_FORMAT_TRUETYPE_AAT   = 1 &lt;&lt; 3,
<span class="lineNum">     189 </span>            :         FLAG_FORMAT_EOT            = 1 &lt;&lt; 4,
<span class="lineNum">     190 </span>            :         FLAG_FORMAT_SVG            = 1 &lt;&lt; 5,
<span class="lineNum">     191 </span>            :         FLAG_FORMAT_WOFF           = 1 &lt;&lt; 6,
<span class="lineNum">     192 </span>            :         FLAG_FORMAT_WOFF2          = 1 &lt;&lt; 7,
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            :         // the common formats that we support everywhere
<span class="lineNum">     195 </span>            :         FLAG_FORMATS_COMMON        = FLAG_FORMAT_OPENTYPE |
<span class="lineNum">     196 </span>            :                                      FLAG_FORMAT_TRUETYPE |
<span class="lineNum">     197 </span>            :                                      FLAG_FORMAT_WOFF     |
<span class="lineNum">     198 </span>            :                                      FLAG_FORMAT_WOFF2,
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :         // mask of all unused bits, update when adding new formats
<span class="lineNum">     201 </span>            :         FLAG_FORMAT_NOT_USED       = ~((1 &lt;&lt; 8)-1)
<span class="lineNum">     202 </span>            :     };
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span>            :     // creates a font face without adding it to a particular family
<span class="lineNum">     206 </span>            :     // weight - [100, 900] (multiples of 100)
<span class="lineNum">     207 </span>            :     // stretch = [NS_FONT_STRETCH_ULTRA_CONDENSED, NS_FONT_STRETCH_ULTRA_EXPANDED]
<span class="lineNum">     208 </span>            :     // italic style = constants in gfxFontConstants.h, e.g. NS_FONT_STYLE_NORMAL
<span class="lineNum">     209 </span>            :     // language override = result of calling gfxFontStyle::ParseFontLanguageOverride
<span class="lineNum">     210 </span>            :     // TODO: support for unicode ranges not yet implemented
<span class="lineNum">     211 </span>            :     virtual already_AddRefed&lt;gfxUserFontEntry&gt; CreateUserFontEntry(
<span class="lineNum">     212 </span>            :                               const nsTArray&lt;gfxFontFaceSrc&gt;&amp; aFontFaceSrcList,
<span class="lineNum">     213 </span>            :                               uint32_t aWeight,
<span class="lineNum">     214 </span>            :                               int32_t aStretch,
<span class="lineNum">     215 </span>            :                               uint8_t aStyle,
<span class="lineNum">     216 </span>            :                               const nsTArray&lt;gfxFontFeature&gt;&amp; aFeatureSettings,
<span class="lineNum">     217 </span>            :                               uint32_t aLanguageOverride,
<span class="lineNum">     218 </span>            :                               gfxSparseBitSet* aUnicodeRanges,
<span class="lineNum">     219 </span>            :                               uint8_t aFontDisplay) = 0;
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            :     // creates a font face for the specified family, or returns an existing
<span class="lineNum">     222 </span>            :     // matching entry on the family if there is one
<span class="lineNum">     223 </span>            :     already_AddRefed&lt;gfxUserFontEntry&gt; FindOrCreateUserFontEntry(
<span class="lineNum">     224 </span>            :                                const nsAString&amp; aFamilyName,
<span class="lineNum">     225 </span>            :                                const nsTArray&lt;gfxFontFaceSrc&gt;&amp; aFontFaceSrcList,
<span class="lineNum">     226 </span>            :                                uint32_t aWeight,
<span class="lineNum">     227 </span>            :                                int32_t aStretch,
<span class="lineNum">     228 </span>            :                                uint8_t aStyle,
<span class="lineNum">     229 </span>            :                                const nsTArray&lt;gfxFontFeature&gt;&amp; aFeatureSettings,
<span class="lineNum">     230 </span>            :                                uint32_t aLanguageOverride,
<span class="lineNum">     231 </span>            :                                gfxSparseBitSet* aUnicodeRanges,
<span class="lineNum">     232 </span>            :                                uint8_t aFontDisplay);
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span>            :     // add in a font face for which we have the gfxUserFontEntry already
<span class="lineNum">     235 </span>            :     void AddUserFontEntry(const nsAString&amp; aFamilyName,
<span class="lineNum">     236 </span>            :                           gfxUserFontEntry* aUserFontEntry);
<a name="237"><span class="lineNum">     237 </span>            : </a>
<span class="lineNum">     238 </span>            :     // Whether there is a face with this family name
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :     bool HasFamily(const nsAString&amp; aFamilyName) const</span>
<span class="lineNum">     240 </span>            :     {
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :         return LookupFamily(aFamilyName) != nullptr;</span>
<span class="lineNum">     242 </span>            :     }
<span class="lineNum">     243 </span>            : 
<span class="lineNum">     244 </span>            :     // Look up and return the gfxUserFontFamily in mFontFamilies with
<span class="lineNum">     245 </span>            :     // the given name
<span class="lineNum">     246 </span>            :     gfxUserFontFamily* LookupFamily(const nsAString&amp; aName) const;
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span>            :     // Look up names in a fontlist and return true if any are in the set
<span class="lineNum">     249 </span>            :     bool ContainsUserFontSetFonts(const mozilla::FontFamilyList&amp; aFontList) const;
<span class="lineNum">     250 </span>            : 
<span class="lineNum">     251 </span>            :     // Lookup a font entry for a given style, returns null if not loaded.
<span class="lineNum">     252 </span>            :     // aFamily must be a family returned by our LookupFamily method.
<span class="lineNum">     253 </span>            :     // (only used by gfxPangoFontGroup for now)
<span class="lineNum">     254 </span>            :     gfxUserFontEntry* FindUserFontEntryAndLoad(gfxFontFamily* aFamily,
<span class="lineNum">     255 </span>            :                                                const gfxFontStyle&amp; aFontStyle,
<span class="lineNum">     256 </span>            :                                                bool&amp; aNeedsBold,
<span class="lineNum">     257 </span>            :                                                bool&amp; aWaitForUserFont);
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span>            :     // check whether the given source is allowed to be loaded;
<span class="lineNum">     260 </span>            :     // returns the Principal (for use in the key when caching the loaded font),
<span class="lineNum">     261 </span>            :     // and whether the load should bypass the cache (force-reload).
<span class="lineNum">     262 </span>            :     virtual nsresult CheckFontLoad(const gfxFontFaceSrc* aFontFaceSrc,
<span class="lineNum">     263 </span>            :                                    nsIPrincipal** aPrincipal,
<span class="lineNum">     264 </span>            :                                    bool* aBypassCache) = 0;
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span>            :     // check whether content policies allow the given URI to load.
<span class="lineNum">     267 </span>            :     virtual bool IsFontLoadAllowed(nsIURI* aFontLocation,
<span class="lineNum">     268 </span>            :                                    nsIPrincipal* aPrincipal) = 0;
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span>            :     // initialize the process that loads external font data, which upon
<span class="lineNum">     271 </span>            :     // completion will call FontDataDownloadComplete method
<span class="lineNum">     272 </span>            :     virtual nsresult StartLoad(gfxUserFontEntry* aUserFontEntry,
<span class="lineNum">     273 </span>            :                                const gfxFontFaceSrc* aFontFaceSrc) = 0;
<span class="lineNum">     274 </span>            : 
<span class="lineNum">     275 </span>            :     // generation - each time a face is loaded, generation is
<span class="lineNum">     276 </span>            :     // incremented so that the change can be recognized
<span class="lineNum">     277 </span>            :     uint64_t GetGeneration() { return mGeneration; }
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span>            :     // increment the generation on font load
<span class="lineNum">     280 </span>            :     void IncrementGeneration(bool aIsRebuild = false);
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span>            :     // Generation is bumped on font loads but that doesn't affect name-style
<span class="lineNum">     283 </span>            :     // mappings. Rebuilds do however affect name-style mappings so need to
<span class="lineNum">     284 </span>            :     // lookup fontlists again when that happens.
<span class="lineNum">     285 </span>            :     uint64_t GetRebuildGeneration() { return mRebuildGeneration; }
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :     // rebuild if local rules have been used
<span class="lineNum">     288 </span>            :     void RebuildLocalRules();
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span>            :     class UserFontCache {
<span class="lineNum">     291 </span>            :     public:
<span class="lineNum">     292 </span>            :         // Flag passed when caching a font entry, to specify whether the entry
<span class="lineNum">     293 </span>            :         // should persist in the cache or be discardable.
<span class="lineNum">     294 </span>            :         typedef enum {
<span class="lineNum">     295 </span>            :             kDiscardable,
<span class="lineNum">     296 </span>            :             kPersistent
<span class="lineNum">     297 </span>            :         } EntryPersistence;
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span>            :         // Record a loaded user-font in the cache. This requires that the
<span class="lineNum">     300 </span>            :         // font-entry's userFontData has been set up already, as it relies
<span class="lineNum">     301 </span>            :         // on the URI and Principal recorded there.
<span class="lineNum">     302 </span>            :         // If aPersistence is Persistent, the entry will remain in the cache
<span class="lineNum">     303 </span>            :         // across cacheservice:empty-cache notifications. This is used for
<span class="lineNum">     304 </span>            :         // &quot;preloaded hidden fonts&quot; on FxOS.
<span class="lineNum">     305 </span>            :         static void CacheFont(gfxFontEntry* aFontEntry,
<span class="lineNum">     306 </span>            :                               EntryPersistence aPersistence = kDiscardable);
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            :         // The given gfxFontEntry is being destroyed, so remove any record that
<span class="lineNum">     309 </span>            :         // refers to it.
<span class="lineNum">     310 </span>            :         static void ForgetFont(gfxFontEntry* aFontEntry);
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :         // Return the gfxFontEntry corresponding to a given URI and principal,
<span class="lineNum">     313 </span>            :         // and the features of the given userfont entry, or nullptr if none is available.
<span class="lineNum">     314 </span>            :         // The aPrivate flag is set for requests coming from private windows,
<span class="lineNum">     315 </span>            :         // so we can avoid leaking fonts cached in private windows mode out to
<span class="lineNum">     316 </span>            :         // normal windows.
<span class="lineNum">     317 </span>            :         static gfxFontEntry* GetFont(nsIURI* aSrcURI,
<span class="lineNum">     318 </span>            :                                      nsIPrincipal* aPrincipal,
<span class="lineNum">     319 </span>            :                                      gfxUserFontEntry* aUserFontEntry,
<span class="lineNum">     320 </span>            :                                      bool              aPrivate);
<span class="lineNum">     321 </span>            : 
<span class="lineNum">     322 </span>            :         // Clear everything so that we don't leak URIs and Principals.
<span class="lineNum">     323 </span>            :         static void Shutdown();
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :         // Memory-reporting support.
<span class="lineNum">     326 </span><span class="lineCov">          1 :         class MemoryReporter final : public nsIMemoryReporter</span>
<span class="lineNum">     327 </span>            :         {
<span class="lineNum">     328 </span>            :         private:
<span class="lineNum">     329 </span><span class="lineCov">          1 :             ~MemoryReporter() { }</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span>            :         public:
<span class="lineNum">     332 </span>            :             NS_DECL_ISUPPORTS
<span class="lineNum">     333 </span>            :             NS_DECL_NSIMEMORYREPORTER
<span class="lineNum">     334 </span>            :         };
<span class="lineNum">     335 </span>            : 
<span class="lineNum">     336 </span>            : #ifdef DEBUG_USERFONT_CACHE
<span class="lineNum">     337 </span>            :         // dump contents
<span class="lineNum">     338 </span>            :         static void Dump();
<span class="lineNum">     339 </span>            : #endif
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            :     private:
<span class="lineNum">     342 </span>            :         // Helper that we use to observe the empty-cache notification
<span class="lineNum">     343 </span>            :         // from nsICacheService.
<a name="344"><span class="lineNum">     344 </span>            :         class Flusher : public nsIObserver</a>
<span class="lineNum">     345 </span>            :         {
<span class="lineNum">     346 </span><span class="lineCov">          1 :             virtual ~Flusher() {}</span>
<span class="lineNum">     347 </span>            :         public:
<span class="lineNum">     348 </span>            :             NS_DECL_ISUPPORTS
<span class="lineNum">     349 </span>            :             NS_DECL_NSIOBSERVER
<span class="lineNum">     350 </span><span class="lineCov">          1 :             Flusher() {}</span>
<span class="lineNum">     351 </span>            :         };
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span>            :         // Key used to look up entries in the user-font cache.
<span class="lineNum">     354 </span>            :         // Note that key comparison does *not* use the mFontEntry field
<span class="lineNum">     355 </span>            :         // as a whole; it only compares specific fields within the entry
<span class="lineNum">     356 </span>            :         // (weight/width/style/features) that could affect font selection
<a name="357"><span class="lineNum">     357 </span>            :         // or rendering, and that must match between a font-set's userfont</a>
<span class="lineNum">     358 </span>            :         // entry and the corresponding &quot;real&quot; font entry.
<span class="lineNum">     359 </span><span class="lineCov">          1 :         struct Key {</span>
<span class="lineNum">     360 </span>            :             nsCOMPtr&lt;nsIURI&gt;        mURI;
<span class="lineNum">     361 </span>            :             nsCOMPtr&lt;nsIPrincipal&gt;  mPrincipal; // use nullptr with data: URLs
<span class="lineNum">     362 </span>            :             // The font entry MUST notify the cache when it is destroyed
<span class="lineNum">     363 </span>            :             // (by calling ForgetFont()).
<span class="lineNum">     364 </span>            :             gfxFontEntry* MOZ_NON_OWNING_REF mFontEntry;
<span class="lineNum">     365 </span>            :             uint32_t                mCRC32;
<span class="lineNum">     366 </span>            :             uint32_t                mLength;
<span class="lineNum">     367 </span>            :             bool                    mPrivate;
<a name="368"><span class="lineNum">     368 </span>            :             EntryPersistence        mPersistence;</a>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineCov">          1 :             Key(nsIURI* aURI, nsIPrincipal* aPrincipal,</span>
<span class="lineNum">     371 </span>            :                 gfxFontEntry* aFontEntry, bool aPrivate,
<span class="lineNum">     372 </span>            :                 EntryPersistence aPersistence = kDiscardable)
<span class="lineNum">     373 </span>            :                 : mURI(aURI),
<span class="lineNum">     374 </span>            :                   mPrincipal(aPrincipal),
<span class="lineNum">     375 </span>            :                   mFontEntry(aFontEntry),
<span class="lineNum">     376 </span>            :                   mCRC32(0),
<span class="lineNum">     377 </span>            :                   mLength(0),
<span class="lineNum">     378 </span>            :                   mPrivate(aPrivate),
<span class="lineNum">     379 </span><span class="lineCov">          1 :                   mPersistence(aPersistence)</span>
<span class="lineNum">     380 </span><span class="lineCov">          1 :             { }</span>
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            :             Key(uint32_t aCRC32, uint32_t aLength,
<span class="lineNum">     383 </span>            :                 gfxFontEntry* aFontEntry, bool aPrivate,
<span class="lineNum">     384 </span>            :                 EntryPersistence aPersistence = kDiscardable)
<span class="lineNum">     385 </span>            :                 : mURI(nullptr),
<span class="lineNum">     386 </span>            :                   mPrincipal(nullptr),
<span class="lineNum">     387 </span>            :                   mFontEntry(aFontEntry),
<span class="lineNum">     388 </span>            :                   mCRC32(aCRC32),
<span class="lineNum">     389 </span>            :                   mLength(aLength),
<span class="lineNum">     390 </span>            :                   mPrivate(aPrivate),
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                   mPersistence(aPersistence)</span>
<span class="lineNum">     392 </span>            :             { }
<span class="lineNum">     393 </span>            :         };
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span>            :         class Entry : public PLDHashEntryHdr {
<span class="lineNum">     396 </span>            :         public:
<span class="lineNum">     397 </span>            :             typedef const Key&amp; KeyType;
<a name="398"><span class="lineNum">     398 </span>            :             typedef const Key* KeyTypePointer;</a>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineCov">          1 :             explicit Entry(KeyTypePointer aKey)</span>
<span class="lineNum">     401 </span>            :                 : mURI(aKey-&gt;mURI),
<span class="lineNum">     402 </span>            :                   mPrincipal(aKey-&gt;mPrincipal),
<span class="lineNum">     403 </span>            :                   mCRC32(aKey-&gt;mCRC32),
<span class="lineNum">     404 </span>            :                   mLength(aKey-&gt;mLength),
<span class="lineNum">     405 </span>            :                   mFontEntry(aKey-&gt;mFontEntry),
<span class="lineNum">     406 </span>            :                   mPrivate(aKey-&gt;mPrivate),
<span class="lineNum">     407 </span><span class="lineCov">          1 :                   mPersistence(aKey-&gt;mPersistence)</span>
<a name="408"><span class="lineNum">     408 </span><span class="lineCov">          1 :             { }</span></a>
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineCov">          1 :             Entry(const Entry&amp; aOther)</span>
<span class="lineNum">     411 </span>            :                 : mURI(aOther.mURI),
<span class="lineNum">     412 </span>            :                   mPrincipal(aOther.mPrincipal),
<span class="lineNum">     413 </span>            :                   mCRC32(aOther.mCRC32),
<span class="lineNum">     414 </span>            :                   mLength(aOther.mLength),
<span class="lineNum">     415 </span>            :                   mFontEntry(aOther.mFontEntry),
<span class="lineNum">     416 </span>            :                   mPrivate(aOther.mPrivate),
<span class="lineNum">     417 </span><span class="lineCov">          1 :                   mPersistence(aOther.mPersistence)</span>
<a name="418"><span class="lineNum">     418 </span><span class="lineCov">          1 :             { }</span></a>
<span class="lineNum">     419 </span>            : 
<span class="lineNum">     420 </span><span class="lineCov">          1 :             ~Entry() { }</span>
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span>            :             bool KeyEquals(const KeyTypePointer aKey) const;
<span class="lineNum">     423 </span>            : 
<a name="424"><span class="lineNum">     424 </span>            :             static KeyTypePointer KeyToPointer(KeyType aKey) { return &amp;aKey; }</a>
<span class="lineNum">     425 </span>            : 
<span class="lineNum">     426 </span><span class="lineCov">          1 :             static PLDHashNumber HashKey(const KeyTypePointer aKey) {</span>
<span class="lineNum">     427 </span><span class="lineCov">          1 :                 if (aKey-&gt;mLength) {</span>
<span class="lineNum">     428 </span><span class="lineNoCov">          0 :                     return aKey-&gt;mCRC32;</span>
<span class="lineNum">     429 </span>            :                 }
<span class="lineNum">     430 </span><span class="lineCov">          1 :                 uint32_t principalHash = 0;</span>
<span class="lineNum">     431 </span><span class="lineCov">          1 :                 if (aKey-&gt;mPrincipal) {</span>
<span class="lineNum">     432 </span><span class="lineCov">          1 :                     aKey-&gt;mPrincipal-&gt;GetHashValue(&amp;principalHash);</span>
<span class="lineNum">     433 </span>            :                 }
<span class="lineNum">     434 </span>            :                 return mozilla::HashGeneric(principalHash + int(aKey-&gt;mPrivate),
<span class="lineNum">     435 </span><span class="lineCov">          1 :                                             nsURIHashKey::HashKey(aKey-&gt;mURI),</span>
<span class="lineNum">     436 </span>            :                                             HashFeatures(aKey-&gt;mFontEntry-&gt;mFeatureSettings),
<span class="lineNum">     437 </span>            :                                             mozilla::HashString(aKey-&gt;mFontEntry-&gt;mFamilyName),
<span class="lineNum">     438 </span><span class="lineCov">          1 :                                             (aKey-&gt;mFontEntry-&gt;mStyle |</span>
<span class="lineNum">     439 </span><span class="lineCov">          1 :                                              (aKey-&gt;mFontEntry-&gt;mWeight &lt;&lt; 2) |</span>
<span class="lineNum">     440 </span><span class="lineCov">          1 :                                              (aKey-&gt;mFontEntry-&gt;mStretch &lt;&lt; 11) ) ^</span>
<span class="lineNum">     441 </span><span class="lineCov">          1 :                                              aKey-&gt;mFontEntry-&gt;mLanguageOverride);</span>
<span class="lineNum">     442 </span>            :             }
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span>            :             enum { ALLOW_MEMMOVE = false };
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span>            :             gfxFontEntry* GetFontEntry() const { return mFontEntry; }
<span class="lineNum">     447 </span>            : 
<span class="lineNum">     448 </span>            :             bool IsPersistent() const { return mPersistence == kPersistent; }
<span class="lineNum">     449 </span>            :             bool IsPrivate() const { return mPrivate; }
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            :             void ReportMemory(nsIHandleReportCallback* aHandleReport,
<span class="lineNum">     452 </span>            :                               nsISupports* aData, bool aAnonymize);
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span>            : #ifdef DEBUG_USERFONT_CACHE
<span class="lineNum">     455 </span>            :             void Dump();
<span class="lineNum">     456 </span>            : #endif
<span class="lineNum">     457 </span>            : 
<a name="458"><span class="lineNum">     458 </span>            :         private:</a>
<span class="lineNum">     459 </span>            :             static uint32_t
<span class="lineNum">     460 </span><span class="lineCov">          1 :             HashFeatures(const nsTArray&lt;gfxFontFeature&gt;&amp; aFeatures) {</span>
<span class="lineNum">     461 </span><span class="lineCov">          1 :                 return mozilla::HashBytes(aFeatures.Elements(),</span>
<span class="lineNum">     462 </span><span class="lineCov">          1 :                                           aFeatures.Length() * sizeof(gfxFontFeature));</span>
<span class="lineNum">     463 </span>            :             }
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span>            :             nsCOMPtr&lt;nsIURI&gt;       mURI;
<span class="lineNum">     466 </span>            :             nsCOMPtr&lt;nsIPrincipal&gt; mPrincipal; // or nullptr for data: URLs
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span>            :             uint32_t               mCRC32;
<span class="lineNum">     469 </span>            :             uint32_t               mLength;
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span>            :             // The &quot;real&quot; font entry corresponding to this downloaded font.
<span class="lineNum">     472 </span>            :             // The font entry MUST notify the cache when it is destroyed
<span class="lineNum">     473 </span>            :             // (by calling ForgetFont()).
<span class="lineNum">     474 </span>            :             gfxFontEntry* MOZ_NON_OWNING_REF mFontEntry;
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span>            :             // Whether this font was loaded from a private window.
<span class="lineNum">     477 </span>            :             bool                   mPrivate;
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            :             // Whether this entry should survive cache-flushing.
<span class="lineNum">     480 </span>            :             EntryPersistence       mPersistence;
<span class="lineNum">     481 </span>            :         };
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span>            :         static nsTHashtable&lt;Entry&gt;* sUserFonts;
<span class="lineNum">     484 </span>            :     };
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span>            :     void SetLocalRulesUsed() {
<span class="lineNum">     487 </span><span class="lineCov">          1 :         mLocalRulesUsed = true;</span>
<span class="lineNum">     488 </span>            :     }
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span>            :     static mozilla::LogModule* GetUserFontsLog();
<a name="491"><span class="lineNum">     491 </span>            : </a>
<span class="lineNum">     492 </span>            :     // record statistics about font completion
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :     virtual void RecordFontLoadDone(uint32_t aFontSize,</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :                                     mozilla::TimeStamp aDoneTime) {}</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span>            :     void GetLoadStatistics(uint32_t&amp; aLoadCount, uint64_t&amp; aLoadSize) const {
<span class="lineNum">     497 </span>            :         aLoadCount = mDownloadCount;
<span class="lineNum">     498 </span>            :         aLoadSize = mDownloadSize;
<span class="lineNum">     499 </span>            :     }
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span>            : protected:
<span class="lineNum">     502 </span>            :     // Protected destructor, to discourage deletion outside of Release():
<span class="lineNum">     503 </span>            :     virtual ~gfxUserFontSet();
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span>            :     // Return whether the font set is associated with a private-browsing tab.
<span class="lineNum">     506 </span>            :     virtual bool GetPrivateBrowsing() = 0;
<span class="lineNum">     507 </span>            : 
<span class="lineNum">     508 </span>            :     // parse data for a data URL
<span class="lineNum">     509 </span>            :     virtual nsresult SyncLoadFontData(gfxUserFontEntry* aFontToLoad,
<span class="lineNum">     510 </span>            :                                       const gfxFontFaceSrc* aFontFaceSrc,
<span class="lineNum">     511 </span>            :                                       uint8_t* &amp;aBuffer,
<span class="lineNum">     512 </span>            :                                       uint32_t &amp;aBufferLength) = 0;
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span>            :     // report a problem of some kind (implemented in nsUserFontSet)
<span class="lineNum">     515 </span>            :     virtual nsresult LogMessage(gfxUserFontEntry* aUserFontEntry,
<span class="lineNum">     516 </span>            :                                 const char* aMessage,
<span class="lineNum">     517 </span>            :                                 uint32_t aFlags = nsIScriptError::errorFlag,
<span class="lineNum">     518 </span>            :                                 nsresult aStatus = NS_OK) = 0;
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span>            :     // helper method for performing the actual userfont set rebuild
<span class="lineNum">     521 </span>            :     virtual void DoRebuildUserFontSet() = 0;
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :     // helper method for FindOrCreateUserFontEntry
<span class="lineNum">     524 </span>            :     gfxUserFontEntry* FindExistingUserFontEntry(
<span class="lineNum">     525 </span>            :                                    gfxUserFontFamily* aFamily,
<span class="lineNum">     526 </span>            :                                    const nsTArray&lt;gfxFontFaceSrc&gt;&amp; aFontFaceSrcList,
<span class="lineNum">     527 </span>            :                                    uint32_t aWeight,
<span class="lineNum">     528 </span>            :                                    int32_t aStretch,
<span class="lineNum">     529 </span>            :                                    uint8_t aStyle,
<span class="lineNum">     530 </span>            :                                    const nsTArray&lt;gfxFontFeature&gt;&amp; aFeatureSettings,
<span class="lineNum">     531 </span>            :                                    uint32_t aLanguageOverride,
<span class="lineNum">     532 </span>            :                                    gfxSparseBitSet* aUnicodeRanges,
<span class="lineNum">     533 </span>            :                                    uint8_t aFontDisplay);
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            :     // creates a new gfxUserFontFamily in mFontFamilies, or returns an existing
<span class="lineNum">     536 </span>            :     // family if there is one
<span class="lineNum">     537 </span>            :     gfxUserFontFamily* GetFamily(const nsAString&amp; aFamilyName);
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span>            :     // font families defined by @font-face rules
<span class="lineNum">     540 </span>            :     nsRefPtrHashtable&lt;nsStringHashKey, gfxUserFontFamily&gt; mFontFamilies;
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :     uint64_t        mGeneration;        // bumped on any font load change
<span class="lineNum">     543 </span>            :     uint64_t        mRebuildGeneration; // only bumped on rebuilds
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span>            :     // true when local names have been looked up, false otherwise
<span class="lineNum">     546 </span>            :     bool mLocalRulesUsed;
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span>            :     // true when rules using local names need to be redone
<span class="lineNum">     549 </span>            :     bool mRebuildLocalRules;
<span class="lineNum">     550 </span>            : 
<span class="lineNum">     551 </span>            :     // performance stats
<span class="lineNum">     552 </span>            :     uint32_t mDownloadCount;
<span class="lineNum">     553 </span>            :     uint64_t mDownloadSize;
<span class="lineNum">     554 </span>            : };
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span>            : // acts a placeholder until the real font is downloaded
<span class="lineNum">     557 </span>            : 
<span class="lineNum">     558 </span>            : class gfxUserFontEntry : public gfxFontEntry {
<span class="lineNum">     559 </span>            :     friend class gfxUserFontSet;
<span class="lineNum">     560 </span>            :     friend class nsUserFontSet;
<span class="lineNum">     561 </span>            :     friend class nsFontFaceLoader;
<span class="lineNum">     562 </span>            :     friend class gfxOTSContext;
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span>            : public:
<span class="lineNum">     565 </span>            :     enum UserFontLoadState {
<span class="lineNum">     566 </span>            :         STATUS_NOT_LOADED = 0,
<span class="lineNum">     567 </span>            :         STATUS_LOADING,
<span class="lineNum">     568 </span>            :         STATUS_LOADED,
<span class="lineNum">     569 </span>            :         STATUS_FAILED
<span class="lineNum">     570 </span>            :     };
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span>            :     gfxUserFontEntry(gfxUserFontSet* aFontSet,
<span class="lineNum">     573 </span>            :                      const nsTArray&lt;gfxFontFaceSrc&gt;&amp; aFontFaceSrcList,
<span class="lineNum">     574 </span>            :                      uint32_t aWeight,
<span class="lineNum">     575 </span>            :                      int32_t aStretch,
<span class="lineNum">     576 </span>            :                      uint8_t aStyle,
<span class="lineNum">     577 </span>            :                      const nsTArray&lt;gfxFontFeature&gt;&amp; aFeatureSettings,
<span class="lineNum">     578 </span>            :                      uint32_t aLanguageOverride,
<span class="lineNum">     579 </span>            :                      gfxSparseBitSet* aUnicodeRanges,
<span class="lineNum">     580 </span>            :                      uint8_t aFontDisplay);
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span>            :     virtual ~gfxUserFontEntry();
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            :     // Return whether the entry matches the given list of attributes
<span class="lineNum">     585 </span>            :     bool Matches(const nsTArray&lt;gfxFontFaceSrc&gt;&amp; aFontFaceSrcList,
<span class="lineNum">     586 </span>            :                  uint32_t aWeight,
<span class="lineNum">     587 </span>            :                  int32_t aStretch,
<span class="lineNum">     588 </span>            :                  uint8_t aStyle,
<span class="lineNum">     589 </span>            :                  const nsTArray&lt;gfxFontFeature&gt;&amp; aFeatureSettings,
<span class="lineNum">     590 </span>            :                  uint32_t aLanguageOverride,
<span class="lineNum">     591 </span>            :                  gfxSparseBitSet* aUnicodeRanges,
<span class="lineNum">     592 </span>            :                  uint8_t aFontDisplay);
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            :     virtual gfxFont* CreateFontInstance(const gfxFontStyle* aFontStyle,
<span class="lineNum">     595 </span>            :                                         bool aNeedsBold);
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span><span class="lineCov">          1 :     gfxFontEntry* GetPlatformFontEntry() const { return mPlatformFontEntry; }</span>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span>            :     // is the font loading or loaded, or did it fail?
<span class="lineNum">     600 </span>            :     UserFontLoadState LoadState() const { return mUserFontLoadState; }
<a name="601"><span class="lineNum">     601 </span>            : </a>
<span class="lineNum">     602 </span>            :     // whether to wait before using fallback font or not
<span class="lineNum">     603 </span><span class="lineCov">          1 :     bool WaitForUserFont() const {</span>
<span class="lineNum">     604 </span><span class="lineCov">          1 :         return mUserFontLoadState == STATUS_LOADING &amp;&amp;</span>
<span class="lineNum">     605 </span><span class="lineCov">          1 :                mFontDataLoadingState &lt; LOADING_SLOWLY;</span>
<span class="lineNum">     606 </span>            :     }
<span class="lineNum">     607 </span>            : 
<a name="608"><span class="lineNum">     608 </span>            :     // for userfonts, cmap is used to store the unicode range data</a>
<span class="lineNum">     609 </span>            :     // no cmap ==&gt; all codepoints permitted
<span class="lineNum">     610 </span><span class="lineCov">          1 :     bool CharacterInUnicodeRange(uint32_t ch) const {</span>
<span class="lineNum">     611 </span><span class="lineCov">          1 :         if (mCharacterMap) {</span>
<span class="lineNum">     612 </span><span class="lineCov">          1 :             return mCharacterMap-&gt;test(ch);</span>
<span class="lineNum">     613 </span>            :         }
<span class="lineNum">     614 </span>            :         return true;
<span class="lineNum">     615 </span>            :     }
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            :     gfxCharacterMap* GetUnicodeRangeMap() const {
<span class="lineNum">     618 </span><span class="lineCov">          1 :         return mCharacterMap.get();</span>
<span class="lineNum">     619 </span>            :     }
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :     uint8_t GetFontDisplay() const { return mFontDisplay; }
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span>            :     // load the font - starts the loading of sources which continues until
<span class="lineNum">     624 </span>            :     // a valid font resource is found or all sources fail
<span class="lineNum">     625 </span>            :     void Load();
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span>            :     // methods to expose some information to FontFaceSet::UserFontSet
<span class="lineNum">     628 </span>            :     // since we can't make that class a friend
<span class="lineNum">     629 </span>            :     void SetLoader(nsFontFaceLoader* aLoader) { mLoader = aLoader; }
<span class="lineNum">     630 </span>            :     nsFontFaceLoader* GetLoader() { return mLoader; }
<span class="lineNum">     631 </span>            :     nsIPrincipal* GetPrincipal() { return mPrincipal; }
<span class="lineNum">     632 </span>            :     uint32_t GetSrcIndex() { return mSrcIndex; }
<span class="lineNum">     633 </span>            :     void GetFamilyNameAndURIForLogging(nsACString&amp; aFamilyName,
<span class="lineNum">     634 </span>            :                                        nsACString&amp; aURI);
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            : protected:
<span class="lineNum">     637 </span>            :     const uint8_t* SanitizeOpenTypeData(const uint8_t* aData,
<span class="lineNum">     638 </span>            :                                         uint32_t aLength,
<span class="lineNum">     639 </span>            :                                         uint32_t&amp; aSaneLength,
<span class="lineNum">     640 </span>            :                                         gfxUserFontType aFontType);
<span class="lineNum">     641 </span>            : 
<span class="lineNum">     642 </span>            :     // attempt to load the next resource in the src list.
<span class="lineNum">     643 </span>            :     void LoadNextSrc();
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span>            :     // change the load state
<span class="lineNum">     646 </span>            :     virtual void SetLoadState(UserFontLoadState aLoadState);
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span>            :     // when download has been completed, pass back data here
<span class="lineNum">     649 </span>            :     // aDownloadStatus == NS_OK ==&gt; download succeeded, error otherwise
<span class="lineNum">     650 </span>            :     // returns true if platform font creation sucessful (or local()
<span class="lineNum">     651 </span>            :     // reference was next in line)
<span class="lineNum">     652 </span>            :     // Ownership of aFontData is passed in here; the font set must
<span class="lineNum">     653 </span>            :     // ensure that it is eventually deleted with free().
<span class="lineNum">     654 </span>            :     bool FontDataDownloadComplete(const uint8_t* aFontData, uint32_t aLength,
<span class="lineNum">     655 </span>            :                                   nsresult aDownloadStatus);
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span>            :     // helper method for creating a platform font
<span class="lineNum">     658 </span>            :     // returns true if platform font creation successful
<span class="lineNum">     659 </span>            :     // Ownership of aFontData is passed in here; the font must
<span class="lineNum">     660 </span>            :     // ensure that it is eventually deleted with free().
<span class="lineNum">     661 </span>            :     bool LoadPlatformFont(const uint8_t* aFontData, uint32_t&amp; aLength);
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            :     // store metadata and src details for current src into aFontEntry
<span class="lineNum">     664 </span>            :     void StoreUserFontData(gfxFontEntry*      aFontEntry,
<span class="lineNum">     665 </span>            :                            bool               aPrivate,
<span class="lineNum">     666 </span>            :                            const nsAString&amp;   aOriginalName,
<span class="lineNum">     667 </span>            :                            FallibleTArray&lt;uint8_t&gt;* aMetadata,
<span class="lineNum">     668 </span>            :                            uint32_t           aMetaOrigLen,
<span class="lineNum">     669 </span>            :                            uint8_t            aCompression);
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span>            :     // Clears and then adds to aResult all of the user font sets that this user
<span class="lineNum">     672 </span>            :     // font entry has been added to.  This will at least include mFontSet, the
<span class="lineNum">     673 </span>            :     // owner of this user font entry.
<span class="lineNum">     674 </span>            :     virtual void GetUserFontSets(nsTArray&lt;gfxUserFontSet*&gt;&amp; aResult);
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span>            :     // Calls IncrementGeneration() on all user font sets that contain this
<span class="lineNum">     677 </span>            :     // user font entry.
<span class="lineNum">     678 </span>            :     void IncrementGeneration();
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            :     // general load state
<span class="lineNum">     681 </span>            :     UserFontLoadState        mUserFontLoadState;
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span>            :     // detailed load state while font data is loading
<span class="lineNum">     684 </span>            :     // used to determine whether to use fallback font or not
<span class="lineNum">     685 </span>            :     // note that code depends on the ordering of these values!
<span class="lineNum">     686 </span>            :     enum FontDataLoadingState {
<span class="lineNum">     687 </span>            :         NOT_LOADING = 0,     // not started to load any font resources yet
<span class="lineNum">     688 </span>            :         LOADING_STARTED,     // loading has started; hide fallback font
<span class="lineNum">     689 </span>            :         LOADING_ALMOST_DONE, // timeout happened but we're nearly done,
<span class="lineNum">     690 </span>            :                              // so keep hiding fallback font
<span class="lineNum">     691 </span>            :         LOADING_SLOWLY,      // timeout happened and we're not nearly done,
<span class="lineNum">     692 </span>            :                              // so use the fallback font
<span class="lineNum">     693 </span>            :         LOADING_TIMED_OUT,   // font load took too long
<span class="lineNum">     694 </span>            :         LOADING_FAILED       // failed to load any source: use fallback
<span class="lineNum">     695 </span>            :     };
<span class="lineNum">     696 </span>            :     FontDataLoadingState     mFontDataLoadingState;
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span>            :     bool                     mUnsupportedFormat;
<span class="lineNum">     699 </span>            :     uint8_t                  mFontDisplay; // timing of userfont fallback
<span class="lineNum">     700 </span>            : 
<span class="lineNum">     701 </span>            :     RefPtr&lt;gfxFontEntry&gt;   mPlatformFontEntry;
<span class="lineNum">     702 </span>            :     nsTArray&lt;gfxFontFaceSrc&gt; mSrcList;
<span class="lineNum">     703 </span>            :     uint32_t                 mSrcIndex; // index of loading src item
<span class="lineNum">     704 </span>            :     // This field is managed by the nsFontFaceLoader. In the destructor and Cancel()
<span class="lineNum">     705 </span>            :     // methods of nsFontFaceLoader this reference is nulled out.
<span class="lineNum">     706 </span>            :     nsFontFaceLoader* MOZ_NON_OWNING_REF mLoader; // current loader for this entry, if any
<span class="lineNum">     707 </span>            :     gfxUserFontSet*          mFontSet; // font-set which owns this userfont entry
<span class="lineNum">     708 </span>            :     nsCOMPtr&lt;nsIPrincipal&gt;   mPrincipal;
<span class="lineNum">     709 </span>            : };
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span>            : #endif /* GFX_USER_FONT_SET_H */
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13-2-g25f5d38</a></td></tr>
  </table>
  <br>

</body>
</html>
